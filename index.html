<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOTO Process Tracker - High Rise Building</title>
    
    <style>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f9fc;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* ===== LAYOUT ===== */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ===== HEADER ===== */
        .site-header {
            background: linear-gradient(135deg, #1F3765 0%, #2A4A8A 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(31, 55, 101, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header-left h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-left p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        /* ===== DATA CONTROLS ===== */
        .data-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #1F3765;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: #f0f7ff;
            border-color: #1F3765;
            transform: translateY(-2px);
        }
        
        /* ===== TABS ===== */
        .main-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 18px 30px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            background: white;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            flex: 1;
            text-align: center;
        }
        
        .tab:hover {
            background: #f8fafc;
            color: #1F3765;
        }
        
        .tab.active {
            color: #1F3765;
            border-bottom-color: #D2785A;
            background: #f8fafc;
        }
        
        .tab i {
            margin-right: 10px;
        }
        
        /* ===== TAB CONTENT ===== */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== DASHBOARD KPI CARDS (UPDATED TO MATCH ANALYTICS) ===== */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-top: 6px solid;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
            cursor: pointer; /* Added for clickable cards */
        }
        
        .kpi-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .kpi-title {
            font-size: 1.1rem;
            color: #435254;
            font-weight: 600;
        }
        
        .kpi-value {
            font-size: 2.8rem;
            font-weight: 800;
            color: #1F3765;
            margin: 15px 0;
            line-height: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .progress-container {
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
        }
        
        .progress-bar {
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 1s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* ===== TOWER PROGRESS CHART ===== */
        .tower-progress-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .tower-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .chart-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .chart-filter-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .chart-filter-btn:hover {
            background: #f0f7ff;
            border-color: #1F3765;
        }
        
        .chart-filter-btn.active {
            background: #1F3765;
            color: white;
            border-color: #1F3765;
            box-shadow: 0 2px 8px rgba(31, 55, 101, 0.3);
        }
        
        .tower-progress-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .tower-chart-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .tower-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .tower-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1F3765;
        }
        
        /* ===== PROCESS CHART ITEM ===== */
        .process-chart-item {
            margin-bottom: 15px;
        }
        
        .process-name {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #435254;
        }
        
        .process-percent {
            font-weight: 700;
            color: #1F3765;
        }
        
        /* ===== UPCOMING EVENTS SECTION ===== */
        .upcoming-events-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .upcoming-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .upcoming-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        
        .upcoming-card:hover {
            transform: translateY(-5px);
        }
        
        .upcoming-card.handover {
            border-left-color: #3E7CA6;
        }
        
        .upcoming-card.first-visit {
            border-left-color: #DBD99A;
        }
        
        .upcoming-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .upcoming-item {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 3px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .upcoming-item:hover {
            background: #f0f7ff;
        }
        
        .upcoming-item.handover {
            border-left-color: #3E7CA6;
        }
        
        .upcoming-item.first-visit {
            border-left-color: #DBD99A;
        }
        
        .upcoming-date {
            background: #1F3765;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .no-events {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }
        
        /* ===== FORMS ===== */
        .process-form {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .section-title {
            font-size: 1.4rem;
            color: #1F3765;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #435254;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3E7CA6;
            box-shadow: 0 0 0 3px rgba(62, 124, 166, 0.1);
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: #1F3765;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2A4A8A;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(31, 55, 101, 0.3);
        }
        
        .btn-secondary {
            background: #80BBAD;
            color: #435254;
        }
        
        .btn-secondary:hover {
            background: #6CA89A;
            transform: translateY(-2px);
        }
        
        .btn-accent {
            background: #D2785A;
            color: white;
        }
        
        .btn-accent:hover {
            background: #C1694A;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        
        /* ===== TOWER SECTION ===== */
        .tower-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .tower-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .tower-btn {
            padding: 12px 25px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
        }
        
        .tower-btn:hover {
            background: #f0f7ff;
            border-color: #3E7CA6;
        }
        
        .tower-btn.active {
            background: #1F3765;
            color: white;
            border-color: #1F3765;
            box-shadow: 0 2px 8px rgba(31, 55, 101, 0.3);
        }
        
        /* ===== FLOOR SELECTION ===== */
        .floor-selection {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: block !important;
        }
        
        .floor-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .floor-btn {
            padding: 12px 5px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 1.1rem;
            position: relative;
        }
        
        .floor-btn:hover {
            background: #e9ecef;
            border-color: #3E7CA6;
        }
        
        .floor-btn.active {
            background: #1F3765;
            color: white;
            border-color: #1F3765;
        }
        
        .floor-btn.refuge {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
            font-weight: 700;
        }
        
        /* ===== FLAT SELECTION ===== */
        .flat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin: 25px 0;
        }
        
        .flat-item {
            padding: 15px 10px;
            text-align: center;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 1.1rem;
            position: relative;
        }
        
        .flat-item:hover {
            border-color: #3E7CA6;
            background: #f0f7ff;
            transform: translateY(-2px);
        }
        
        .flat-item.selected {
            background: #1F3765;
            color: white;
            border-color: #1F3765;
            box-shadow: 0 4px 12px rgba(31, 55, 101, 0.3);
        }
        
        .flat-item.refuge {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
            font-weight: 700;
            position: relative;
        }
        
        .flat-item.refuge:hover {
            background: #ffeaa7;
        }
        
        .flat-item.refuge.selected {
            background: #ffc107;
            color: #856404;
            border-color: #e0a800;
        }
        
        /* Refuge indicator */
        .refuge-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            font-size: 0.7rem;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* ===== DETAILS MODAL ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .data-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #3E7CA6;
        }
        
        .data-section h4 {
            color: #1F3765;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .data-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .data-field {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .data-field:hover {
            border-color: #3E7CA6;
            box-shadow: 0 2px 8px rgba(62, 124, 166, 0.1);
        }
        
        .field-label {
            font-weight: 600;
            color: #435254;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .field-value {
            color: #333;
            font-size: 1rem;
            font-weight: 500;
        }
        
        /* ===== SNAG CATEGORY SECTION ===== */
        .snag-category {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #3E7CA6;
            transition: all 0.3s;
        }
        
        .snag-category:hover {
            box-shadow: 0 2px 8px rgba(62, 124, 166, 0.1);
        }
        
        .snag-category h5 {
            color: #1F3765;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* ===== MULTIPLE VENDORS ===== */
        .vendor-form {
            background: #e9f7fe;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            margin-bottom: 20px;
            border: 2px dashed #3E7CA6;
            transition: all 0.3s;
        }
        
        .vendor-form:hover {
            border-color: #1F3765;
        }
        
        .vendor-form.hidden {
            display: none;
        }
        
        .vendor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .remove-vendor {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .remove-vendor:hover {
            background: #c82333;
            transform: scale(1.05);
        }
        
        /* ===== DEVIATIONS SECTION ===== */
        .deviation-item {
            background: #fff3cd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
            transition: all 0.3s;
        }
        
        .deviation-item:hover {
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
        }
        
        .deviation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .deviation-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-resolved {
            color: #28a745;
            font-weight: 600;
        }
        
        .status-not-resolved {
            color: #dc3545;
            font-weight: 600;
        }
        
        /* ===== ANALYTICS STYLES ===== */
        .analytics-controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .date-range-filter {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .quick-filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .quick-filter-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .quick-filter-btn:hover {
            background: #e9ecef;
            border-color: #3E7CA6;
        }
        
        .quick-filter-btn.active {
            background: #1F3765;
            color: white;
            border-color: #1F3765;
            box-shadow: 0 2px 8px rgba(31, 55, 101, 0.3);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .chart-container:hover {
            transform: translateY(-5px);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.2rem;
            color: #1F3765;
            font-weight: 600;
        }
        
        .report-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .report-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .report-btn:hover {
            background: #e9ecef;
            border-color: #3E7CA6;
            transform: translateY(-2px);
        }
        
        .canvas-container {
            width: 100%;
            height: 300px;
            position: relative;
        }
        
        /* ===== ERROR MESSAGE STYLES ===== */
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 10px 15px;
            margin: 10px 0;
            color: #721c24;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .error-message i {
            color: #dc3545;
        }
        
        .validation-error {
            border-color: #dc3545 !important;
            background: #fff5f5;
        }
        
        /* ===== RESOLUTION DROPDOWN ===== */
        .resolution-dropdown {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .resolution-dropdown select {
            width: auto;
            min-width: 120px;
        }
        
        /* ===== DATE TIME DISPLAY ===== */
        .datetime-display {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ===== EDIT BUTTON STYLES ===== */
        .edit-btn {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        /* ===== COLOR THEMES ===== */
        .color-key { background: #80BBAD; border-color: #80BBAD; }
        .color-snag { background: #17E88F; border-color: #17E88F; }
        .color-visit { background: #DBD99A; border-color: #DBD99A; }
        .color-hoto { background: #3E7CA6; border-color: #3E7CA6; }
        .color-interior { background: #885073; border-color: #885073; }
        .color-movein { background: #1F3765; border-color: #1F3765; }
        .color-project { background: #6f42c1; border-color: #6f42c1; }
        .color-crm { background: #20c997; border-color: #20c997; }
        .color-team4-crm { background: #6610f2; border-color: #6610f2; }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 1200px) {
            .container {
                padding: 15px;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tower-progress-chart {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .upcoming-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .site-header {
                flex-direction: column;
                text-align: center;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .tower-progress-chart {
                grid-template-columns: 1fr;
            }
            
            .main-tabs {
                flex-direction: column;
            }
            
            .tab {
                padding: 15px;
                text-align: left;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .floor-buttons {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
            
            .flat-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .data-row {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .upcoming-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .flat-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .floor-buttons {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            }
        }
        
        /* ===== NOTIFICATION STYLES ===== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10001;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.warning { background: #ffc107; color: #212529; }
        .notification.info { background: #17a2b8; }
        
        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* ===== LOADING SPINNER ===== */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== TEMPLATE INSTRUCTIONS ===== */
        .template-instructions {
            background: #fff3cd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
        
        .required-fields {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .required-field {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .field-name {
            font-weight: 600;
            color: #1F3765;
        }
        
        .field-type {
            font-size: 0.9rem;
            color: #666;
            margin-left: 5px;
        }
        
        /* ===== IMPORT SUMMARY ===== */
        .import-summary {
            background: #e9f7fe;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #17a2b8;
        }
        
        /* ===== SETUP STEPS ===== */
        .setup-step {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .setup-step:last-child {
            border-bottom: none;
        }
        
        .setup-instruction {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .setup-instruction ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .setup-instruction li {
            margin-bottom: 8px;
        }
        
        /* ===== WORKFLOW INFO BADGE ===== */
        .workflow-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #6f42c1;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .workflow-badge.not-in-workflow {
            background: #6c757d;
        }
    </style>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS for Excel Processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header class="site-header">
            <div class="header-left">
                <h1>
                    <i class="fas fa-building"></i>
                    HOTO Process Tracker
                </h1>
                <p>High Rise Building Complex - Real-time Progress Tracking</p>
            </div>
            <div class="header-right">
                <div class="date-display">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="currentDate">Loading...</span>
                </div>
                <button class="control-btn" onclick="refreshData()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                <button class="control-btn" onclick="openTab('excel-processor')">
                    <i class="fas fa-file-excel"></i>
                    Excel Processor
                </button>
                <button class="control-btn" onclick="openTab('integration')" title="Google Sheets Integration">
                    <i class="fas fa-plug"></i>
                    <span id="connectionIndicator" style="color: #28a745;">‚óè</span>
                </button>
            </div>
        </header>
        
        <!-- TABS -->
        <div class="main-tabs">
            <div class="tab active" onclick="openTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>
            <div class="tab" onclick="openTab('key-handover')">
                <i class="fas fa-key"></i> Key Handover
            </div>
            <div class="tab" onclick="openTab('snagging')">
                <i class="fas fa-search"></i> CBRE Snagging
            </div>
            <div class="tab" onclick="openTab('project-mep')">
                <i class="fas fa-tools"></i> Project/MEP
            </div>
            <!-- NEW: TEAM4 CRM (Actual Workflow CRM) -->
            <div class="tab" onclick="openTab('team4-crm')">
                <i class="fas fa-users"></i> TEAM4 CRM
                <span class="workflow-badge">Workflow</span>
            </div>
            <!-- RENAMED: Existing CRM now CBRE CRM (Calls Only) -->
            <div class="tab" onclick="openTab('cbre-crm')">
                <i class="fas fa-phone-alt"></i> CBRE CRM (Calls)
                <span class="workflow-badge not-in-workflow">Calls Only</span>
            </div>
            <div class="tab" onclick="openTab('first-visit')">
                <i class="fas fa-calendar-check"></i> First Visit
            </div>
            <div class="tab" onclick="openTab('handover')">
                <i class="fas fa-handshake"></i> Handover
            </div>
            <div class="tab" onclick="openTab('interiors')">
                <i class="fas fa-hammer"></i> Interiors
            </div>
            <div class="tab" onclick="openTab('move-in')">
                <i class="fas fa-home"></i> Move-in
            </div>
            <div class="tab" onclick="openTab('excel-processor')">
                <i class="fas fa-file-excel"></i> Excel Processor
            </div>
            <div class="tab" onclick="openTab('integration')">
                <i class="fas fa-plug"></i> Integration
            </div>
            <!-- NEW ANALYTICS TAB -->
            <div class="tab" onclick="openTab('analytics')">
                <i class="fas fa-chart-bar"></i> Analytics
            </div>
        </div>
        
        <!-- DASHBOARD TAB -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="kpi-grid">
                <div class="kpi-card" style="border-top-color: #80BBAD;" onclick="openTab('key-handover')">
                    <div class="kpi-header">
                        <div class="kpi-title">Key Handovers</div>
                        <i class="fas fa-key fa-2x" style="color: #80BBAD;"></i>
                    </div>
                    <div class="kpi-value" id="totalKeyHandovers">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="keyHandoverPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="keyHandoverProgress" style="width: 0%; background-color: #80BBAD;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card" style="border-top-color: #17E88F;" onclick="openTab('snagging')">
                    <div class="kpi-header">
                        <div class="kpi-title">CBRE Snagging</div>
                        <i class="fas fa-search fa-2x" style="color: #17E88F;"></i>
                    </div>
                    <div class="kpi-value" id="totalSnagging">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="snaggingPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="snaggingProgress" style="width: 0%; background-color: #17E88F;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card" style="border-top-color: #6f42c1;" onclick="openTab('project-mep')">
                    <div class="kpi-header">
                        <div class="kpi-title">Project/MEP</div>
                        <i class="fas fa-tools fa-2x" style="color: #6f42c1;"></i>
                    </div>
                    <div class="kpi-value" id="totalProjectMEP">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="projectMEPPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="projectMEPProgress" style="width: 0%; background-color: #6f42c1;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- NEW: TEAM4 CRM KPI -->
                <div class="kpi-card" style="border-top-color: #6610f2;" onclick="openTab('team4-crm')">
                    <div class="kpi-header">
                        <div class="kpi-title">TEAM4 CRM</div>
                        <i class="fas fa-users fa-2x" style="color: #6610f2;"></i>
                    </div>
                    <div class="kpi-value" id="totalTeam4CRM">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="team4CRMPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="team4CRMProgress" style="width: 0%; background-color: #6610f2;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- RENAMED: CBRE CRM (Calls) KPI -->
                <div class="kpi-card" style="border-top-color: #20c997;" onclick="openTab('cbre-crm')">
                    <div class="kpi-header">
                        <div class="kpi-title">CBRE CRM (Calls)</div>
                        <i class="fas fa-phone-alt fa-2x" style="color: #20c997;"></i>
                    </div>
                    <div class="kpi-value" id="totalCbreCRM">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="cbreCRMPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="cbreCRMProgress" style="width: 0%; background-color: #20c997;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card" style="border-top-color: #DBD99A;" onclick="openTab('first-visit')">
                    <div class="kpi-header">
                        <div class="kpi-title">First Visits</div>
                        <i class="fas fa-calendar-check fa-2x" style="color: #DBD99A;"></i>
                    </div>
                    <div class="kpi-value" id="totalFirstVisits">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="firstVisitPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="firstVisitProgress" style="width: 0%; background-color: #DBD99A;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card" style="border-top-color: #3E7CA6;" onclick="openTab('handover')">
                    <div class="kpi-header">
                        <div class="kpi-title">Handovers</div>
                        <i class="fas fa-handshake fa-2x" style="color: #3E7CA6;"></i>
                    </div>
                    <div class="kpi-value" id="totalHandovers">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="handoverPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="handoverProgress" style="width: 0%; background-color: #3E7CA6;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card" style="border-top-color: #885073;" onclick="openTab('interiors')">
                    <div class="kpi-header">
                        <div class="kpi-title">Interiors</div>
                        <i class="fas fa-hammer fa-2x" style="color: #885073;"></i>
                    </div>
                    <div class="kpi-value" id="totalInteriors">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="interiorPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="interiorProgress" style="width: 0%; background-color: #885073;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card" style="border-top-color: #1F3765;" onclick="openTab('move-in')">
                    <div class="kpi-header">
                        <div class="kpi-title">Move-ins</div>
                        <i class="fas fa-home fa-2x" style="color: #1F3765;"></i>
                    </div>
                    <div class="kpi-value" id="totalMoveins">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="moveinPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="moveinProgress" style="width: 0%; background-color: #1F3765;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tower Progress Chart Section -->
            <div class="tower-progress-section">
                <div class="tower-progress-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Tower-wise Progress Analysis
                    </h2>
                    <div class="chart-filters">
                        <button class="chart-filter-btn active" onclick="filterChartData('all')">All Processes</button>
                        <button class="chart-filter-btn" onclick="filterChartData('key')">Key Handover</button>
                        <button class="chart-filter-btn" onclick="filterChartData('snag')">CBRE Snagging</button>
                        <button class="chart-filter-btn" onclick="filterChartData('project')">Project/MEP</button>
                        <button class="chart-filter-btn" onclick="filterChartData('team4-crm')">TEAM4 CRM</button>
                        <button class="chart-filter-btn" onclick="filterChartData('cbre-crm')">CBRE CRM</button>
                        <button class="chart-filter-btn" onclick="filterChartData('visit')">First Visit</button>
                        <button class="chart-filter-btn" onclick="filterChartData('hoto')">Handover</button>
                        <button class="chart-filter-btn" onclick="filterChartData('interior')">Interiors</button>
                        <button class="chart-filter-btn" onclick="filterChartData('movein')">Move-in</button>
                    </div>
                </div>
                
                <div class="tower-progress-chart" id="tower-progress-chart">
                    <!-- Tower charts will be dynamically generated here -->
                </div>
            </div>
            
            <!-- NEW: Upcoming Events Section -->
            <div class="upcoming-events-section">
                <h2 class="section-title">
                    <i class="fas fa-calendar-day"></i>
                    Upcoming Events (Next 7 Days)
                </h2>
                
                <div class="upcoming-grid">
                    <div class="upcoming-card first-visit">
                        <h3><i class="fas fa-calendar-check"></i> Upcoming First Visits</h3>
                        <div class="upcoming-list" id="upcomingFirstVisits">
                            <!-- Upcoming first visits will be loaded here -->
                            <div class="no-events">
                                <i class="fas fa-calendar-times fa-2x"></i>
                                <p>No upcoming first visits in the next 7 days</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="upcoming-card handover">
                        <h3><i class="fas fa-handshake"></i> Upcoming Handovers</h3>
                        <div class="upcoming-list" id="upcomingHandovers">
                            <!-- Upcoming handovers will be loaded here -->
                            <div class="no-events">
                                <i class="fas fa-calendar-times fa-2x"></i>
                                <p>No upcoming handovers in the next 7 days</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KEY HANDOVER TAB -->
        <div id="key-handover-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-key"></i>
                    Key Handover - Project Team to HOTO Team
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('key-handover', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('key-handover', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('key-handover', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="key-handover-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="key-handover-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- Key Handover Form -->
                <div id="key-handover-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('key_handover')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-edit"></i>
                        Key Handover Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="keyHandoverFlat">Flat Number *</label>
                            <input type="text" id="keyHandoverFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="keyHandoverTower">Tower *</label>
                            <input type="text" id="keyHandoverTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="handoverPerson">Handover Person *</label>
                            <input type="text" id="handoverPerson" placeholder="Name of person handing over keys">
                        </div>
                        <div class="form-group">
                            <label for="receivedByCBRE">Received by CBRE Person *</label>
                            <input type="text" id="receivedByCBRE" placeholder="Name of CBRE person receiving keys">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="handoverDate">Handover Date *</label>
                            <input type="date" id="handoverDate" value="<?php echo date('Y-m-d'); ?>">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="allKeysNotHanded" onchange="toggleKeyRemarks()">
                            <label for="allKeysNotHanded"><strong>All Keys Not Handed Over</strong></label>
                        </div>
                    </div>
                    
                    <div id="keyRemarksContainer" class="conditional-remarks" style="display: none;">
                        <label for="keyRemarks">Remarks for Incomplete Keys *</label>
                        <textarea id="keyRemarks" rows="3" placeholder="Specify which keys are missing or incomplete..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveKeyHandover()">
                            <i class="fas fa-save"></i> Save Key Handover
                        </button>
                        <button class="btn btn-secondary" onclick="resetKeyForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CBRE SNAGGING TAB -->
        <div id="snagging-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-search"></i>
                    CBRE Snagging Process
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('snagging', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('snagging', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('snagging', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="snagging-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="snagging-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- Snagging Form -->
                <div id="snagging-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('snagging')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-clipboard-check"></i>
                        CBRE Snagging Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="snaggingFlat">Flat Number *</label>
                            <input type="text" id="snaggingFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="snaggingTower">Tower *</label>
                            <input type="text" id="snaggingTower" readonly>
                        </div>
                    </div>
                    
                    <!-- MEP Snagging -->
                    <div class="snag-category">
                        <h5><i class="fas fa-bolt"></i> MEP Snagging</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mepInspector">MEP Inspector Name</label>
                                <input type="text" id="mepInspector" placeholder="Name of MEP inspector">
                            </div>
                            <div class="form-group">
                                <label for="mepStartDate">MEP Start Date</label>
                                <input type="date" id="mepStartDate">
                            </div>
                            <div class="form-group">
                                <label for="mepEndDate">MEP End Date</label>
                                <input type="date" id="mepEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="mepCompleted" onchange="checkAllSnaggingCompleted()">
                                <label for="mepCompleted"><strong>MEP Completed</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Civil Snagging -->
                    <div class="snag-category">
                        <h5><i class="fas fa-building"></i> Civil Snagging</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="civilInspector">Civil Inspector Name</label>
                                <input type="text" id="civilInspector" placeholder="Name of civil inspector">
                            </div>
                            <div class="form-group">
                                <label for="civilStartDate">Civil Start Date</label>
                                <input type="date" id="civilStartDate">
                            </div>
                            <div class="form-group">
                                <label for="civilEndDate">Civil End Date</label>
                                <input type="date" id="civilEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="civilCompleted" onchange="checkAllSnaggingCompleted()">
                                <label for="civilCompleted"><strong>Civil Completed</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Electrical Snagging -->
                    <div class="snag-category">
                        <h5><i class="fas fa-plug"></i> Electrical Snagging</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="electricalInspector">Electrical Inspector Name</label>
                                <input type="text" id="electricalInspector" placeholder="Name of electrical inspector">
                            </div>
                            <div class="form-group">
                                <label for="electricalStartDate">Electrical Start Date</label>
                                <input type="date" id="electricalStartDate">
                            </div>
                            <div class="form-group">
                                <label for="electricalEndDate">Electrical End Date</label>
                                <input type="date" id="electricalEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="electricalCompleted" onchange="checkAllSnaggingCompleted()">
                                <label for="electricalCompleted"><strong>Electrical Completed</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Water & Slopes Snagging -->
                    <div class="snag-category">
                        <h5><i class="fas fa-tint"></i> Water & Slopes Snagging</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="waterInspector">Water & Slopes Inspector Name</label>
                                <input type="text" id="waterInspector" placeholder="Name of water & slopes inspector">
                            </div>
                            <div class="form-group">
                                <label for="waterStartDate">Water & Slopes Start Date</label>
                                <input type="date" id="waterStartDate">
                            </div>
                            <div class="form-group">
                                <label for="waterEndDate">Water & Slopes End Date</label>
                                <input type="date" id="waterEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="waterCompleted" onchange="checkAllSnaggingCompleted()">
                                <label for="waterCompleted"><strong>Water & Slopes Completed</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AC Drain Snagging -->
                    <div class="snag-category">
                        <h5><i class="fas fa-wind"></i> AC Drain Snagging</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="acDrainInspector">AC Drain Inspector Name</label>
                                <input type="text" id="acDrainInspector" placeholder="Name of AC drain inspector">
                            </div>
                            <div class="form-group">
                                <label for="acDrainStartDate">AC Drain Start Date</label>
                                <input type="date" id="acDrainStartDate">
                            </div>
                            <div class="form-group">
                                <label for="acDrainEndDate">AC Drain End Date</label>
                                <input type="date" id="acDrainEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="acDrainCompleted" onchange="checkAllSnaggingCompleted()">
                                <label for="acDrainCompleted"><strong>AC Drain Completed</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tiles Snagging -->
                    <div class="snag-category">
                        <h5><i class="fas fa-square"></i> Tiles Snagging</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tilesInspector">Tiles Inspector Name</label>
                                <input type="text" id="tilesInspector" placeholder="Name of tiles inspector">
                            </div>
                            <div class="form-group">
                                <label for="tilesStartDate">Tiles Start Date</label>
                                <input type="date" id="tilesStartDate">
                            </div>
                            <div class="form-group">
                                <label for="tilesEndDate">Tiles End Date</label>
                                <input type="date" id="tilesEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="tilesCompleted" onchange="checkAllSnaggingCompleted()">
                                <label for="tilesCompleted"><strong>Tiles Completed</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="snagRemarksContainer" class="conditional-remarks">
                        <label for="snagRemarks">Remarks for Incomplete Areas</label>
                        <textarea id="snagRemarks" rows="3" placeholder="Specify which areas are incomplete and details..."></textarea>
                    </div>
                    
                    <div class="form-group" id="followupDateContainer">
                        <label for="followupDate">Follow-up Date</label>
                        <input type="date" id="followupDate">
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveSnagging()" id="saveSnaggingBtn">
                            <i class="fas fa-save"></i> Save Snagging
                        </button>
                        <button class="btn btn-primary" onclick="moveToProjectMEP()" id="moveToProjectMEPBtn" style="display: none;">
                            <i class="fas fa-arrow-right"></i> Save & Move to Project/MEP
                        </button>
                        <button class="btn btn-secondary" onclick="resetSnagForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PROJECT/MEP TAB -->
        <div id="project-mep-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-tools"></i>
                    Project/MEP Process
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('project-mep', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('project-mep', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('project-mep', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="project-mep-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="project-mep-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- Project/MEP Form -->
                <div id="project-mep-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('project_mep')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-clipboard-list"></i>
                        Project/MEP Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectMEPFlat">Flat Number *</label>
                            <input type="text" id="projectMEPFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="projectMEPTower">Tower *</label>
                            <input type="text" id="projectMEPTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="snagsStatus">Snags Status by Project Team</label>
                        <select id="snagsStatus">
                            <option value="attended">Attended</option>
                            <option value="not_attended">Not Attended</option>
                            <option value="partial">Partially Attended</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmationDate">Confirmation Date</label>
                        <input type="date" id="confirmationDate">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cbreChecked">CBRE Team Checked</label>
                            <select id="cbreChecked" onchange="toggleCBRECheckedDate()">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div class="form-group" id="cbreCheckedDateContainer" style="display: none;">
                            <label for="cbreCheckedDate">CBRE Checked Date</label>
                            <input type="date" id="cbreCheckedDate">
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveProjectMEP()">
                            <i class="fas fa-save"></i> Save Project/MEP
                        </button>
                        <button class="btn btn-primary" onclick="moveToTeam4CRM()">
                            <i class="fas fa-arrow-right"></i> Move to TEAM4 CRM
                        </button>
                        <button class="btn btn-secondary" onclick="resetProjectMEPForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NEW: TEAM4 CRM TAB (Actual Workflow CRM) -->
        <div id="team4-crm-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-users"></i>
                    TEAM4 CRM - Workflow CRM
                </h2>
                <div style="background: #e9f7fe; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <i class="fas fa-info-circle" style="color: #17a2b8;"></i>
                    <strong>Note:</strong> This is the actual CRM in the workflow process (Key ‚Üí Snagging ‚Üí Project/MEP ‚Üí TEAM4 CRM ‚Üí First Visit ‚Üí Handover ‚Üí Interiors ‚Üí Move-in)
                </div>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('team4-crm', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('team4-crm', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('team4-crm', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="team4-crm-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="team4-crm-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- TEAM4 CRM Form -->
                <div id="team4-crm-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('team4_crm')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-clipboard-list"></i>
                        TEAM4 CRM Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="team4CRMFlat">Flat Number *</label>
                            <input type="text" id="team4CRMFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="team4CRMTower">Tower *</label>
                            <input type="text" id="team4CRMTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="team4CRMAction">CRM Action Type *</label>
                            <select id="team4CRMAction">
                                <option value="handover">Handover</option>
                                <option value="first_visit">First Visit</option>
                                <option value="first_visit_handover">First Visit & Handover</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="team4CRMAssignedTo">Assigned To *</label>
                            <select id="team4CRMAssignedTo">
                                <option value="cbre">CBRE</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="team4CRMDate">Date *</label>
                            <input type="date" id="team4CRMDate">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="registrationCompleted">
                                <label for="registrationCompleted"><strong>Registration Completed</strong></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="nocGivenToCBRE">
                                <label for="nocGivenToCBRE"><strong>NOC Given to CBRE</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="team4CRMRemarks">Remarks</label>
                        <textarea id="team4CRMRemarks" rows="3" placeholder="Additional remarks..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveTeam4CRM()">
                            <i class="fas fa-save"></i> Save TEAM4 CRM
                        </button>
                        <button class="btn btn-primary" onclick="moveToFirstVisitFromTeam4CRM()">
                            <i class="fas fa-arrow-right"></i> Move to First Visit
                        </button>
                        <button class="btn btn-info" onclick="viewFlatDetails()">
                            <i class="fas fa-eye"></i> View All Details
                        </button>
                        <button class="btn btn-secondary" onclick="resetTeam4CRMForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- RENAMED: CBRE CRM TAB (Calls Only) -->
        <div id="cbre-crm-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-phone-alt"></i>
                    CBRE CRM - Calls Only
                </h2>
                <div style="background: #fff3cd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
                    <strong>Note:</strong> This is for call tracking only and is NOT part of the main workflow process.
                </div>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('cbre-crm', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('cbre-crm', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('cbre-crm', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="cbre-crm-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="cbre-crm-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- CBRE CRM Form -->
                <div id="cbre-crm-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('cbre_crm')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-clipboard-list"></i>
                        CBRE CRM Call Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cbreCRMFlat">Flat Number *</label>
                            <input type="text" id="cbreCRMFlat" readonly>
                            <div class="datetime-display" id="cbreCRMFlatDateTime">
                                <i class="fas fa-clock"></i>
                                <span>Date & time will appear after selection</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cbreCRMTower">Tower *</label>
                            <input type="text" id="cbreCRMTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cbreCRMDescription">Call Description *</label>
                        <textarea id="cbreCRMDescription" rows="3" placeholder="Description of the call or issue..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cbreCRMInformedTo">Informed To *</label>
                            <select id="cbreCRMInformedTo">
                                <option value="mep">MEP Team</option>
                                <option value="civil">Civil Team</option>
                                <option value="facilities">Facilities</option>
                                <option value="project">Project Team</option>
                                <option value="hoto">HOTO Team</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cbreCRMStatus">Call Status *</label>
                            <select id="cbreCRMStatus" onchange="toggleCbreCRMFollowupDate()">
                                <option value="open">Open</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cbreCRMCallerName">Caller Name (Optional)</label>
                            <input type="text" id="cbreCRMCallerName" placeholder="Name of caller">
                        </div>
                        <div class="form-group">
                            <label for="cbreCRMCallerPhone">Caller Phone (Optional)</label>
                            <input type="tel" id="cbreCRMCallerPhone" placeholder="Caller phone number">
                        </div>
                    </div>
                    
                    <div class="form-group" id="cbreCRMFollowupDateContainer">
                        <label for="cbreCRMFollowupDate">Follow-up Date</label>
                        <input type="date" id="cbreCRMFollowupDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="cbreCRMRemarks">Call Remarks (Optional)</label>
                        <textarea id="cbreCRMRemarks" rows="2" placeholder="Additional remarks about the call..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveCbreCRM()">
                            <i class="fas fa-save"></i> Save Call Details
                        </button>
                        <button class="btn btn-info" onclick="viewFlatDetails()">
                            <i class="fas fa-eye"></i> View All Details
                        </button>
                        <button class="btn btn-secondary" onclick="resetCbreCRMForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FIRST VISIT TAB -->
        <div id="first-visit-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-calendar-check"></i>
                    Customer First Visit
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('first-visit', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('first-visit', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('first-visit', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="first-visit-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="first-visit-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- First Visit Form -->
                <div id="first-visit-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('first_visit')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-user-check"></i>
                        First Visit Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstVisitFlat">Flat Number *</label>
                            <input type="text" id="firstVisitFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="firstVisitTower">Tower *</label>
                            <input type="text" id="firstVisitTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ownerName">Owner Name *</label>
                            <input type="text" id="ownerName" placeholder="Full name of owner">
                        </div>
                        <div class="form-group">
                            <label for="ownerPhone">Owner Phone *</label>
                            <input type="tel" id="ownerPhone" placeholder="10-digit mobile number">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="visitDateTime">Visit Date & Time *</label>
                            <input type="datetime-local" id="visitDateTime">
                        </div>
                        <div class="form-group">
                            <label for="hotMember">HOTO Team Member *</label>
                            <input type="text" id="hotMember" placeholder="Name of HOT team member">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="ownerWillInformDate" onchange="toggleHandoverDate()">
                            <label for="ownerWillInformDate"><strong>Owner will inform the date</strong></label>
                        </div>
                    </div>
                    
                    <div class="form-row" id="handoverSuggestedContainer">
                        <div class="form-group">
                            <label for="handoverSuggested">Handover Date Suggested</label>
                            <input type="date" id="handoverSuggested">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="goingForThirdParty" onchange="toggleThirdPartyForm()">
                            <label for="goingForThirdParty"><strong>Going for Third Party Inspection</strong></label>
                        </div>
                    </div>
                    
                    <!-- Third Party Inspection Form -->
                    <div id="thirdPartyForm" style="display: none;">
                        <h4 class="section-title">
                            <i class="fas fa-clipboard-list"></i>
                            Third Party Inspection Details
                        </h4>
                        
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="dateNotConfirmed" onchange="toggleThirdPartySubForm()">
                                <label for="dateNotConfirmed"><strong>Date Not Confirmed (Save First Visit Only)</strong></label>
                            </div>
                        </div>
                        
                        <div id="thirdPartySubForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="thirdPartyDateConfirmed">Date Confirmed *</label>
                                    <input type="date" id="thirdPartyDateConfirmed">
                                </div>
                                <div class="form-group">
                                    <label for="reportReceivedDate">Report Received Date</label>
                                    <input type="date" id="reportReceivedDate">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Report Copy Type</label>
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="softCopy">
                                        <label for="softCopy">Soft Copy</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="hardCopy">
                                        <label for="hardCopy">Hard Copy</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="informedToProjectTeam">Informed to Project Team</label>
                                    <select id="informedToProjectTeam" onchange="toggleProjectTeamDate()">
                                        <option value="no">No</option>
                                        <option value="yes">Yes</option>
                                    </select>
                                </div>
                                <div class="form-group" id="projectTeamDateContainer" style="display: none;">
                                    <label for="projectTeamInformedDate">Project Team Informed Date</label>
                                    <input type="date" id="projectTeamInformedDate">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="cbreCheckingDone">CBRE Checking Done</label>
                                    <select id="cbreCheckingDone" onchange="toggleCBRECheckingDate()">
                                        <option value="no">No</option>
                                        <option value="yes">Yes</option>
                                    </select>
                                </div>
                                <div class="form-group" id="cbreCheckingDateContainer" style="display: none;">
                                    <label for="cbreCheckingDate">CBRE Checking Date</label>
                                    <input type="date" id="cbreCheckingDate">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <button class="btn btn-primary" onclick="moveToTeam4CRMFromThirdParty()">
                                    <i class="fas fa-arrow-right"></i> Move to TEAM4 CRM
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerRemarks">Customer Remarks</label>
                        <textarea id="customerRemarks" rows="3" placeholder="Feedback from customer..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="crmNoc">CRM NOC Received</label>
                        <select id="crmNoc">
                            <option value="pending">Pending</option>
                            <option value="received">Received</option>
                            <option value="not_required">Not Required</option>
                        </select>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveFirstVisit()">
                            <i class="fas fa-save"></i> Save Visit Details
                        </button>
                        <button class="btn btn-secondary" onclick="resetVisitForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- HANDOVER TAB -->
        <div id="handover-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-handshake"></i>
                    HOTO Handover Process
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('handover', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('handover', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('handover', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="handover-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="handover-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- Handover Form -->
                <div id="handover-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('handover')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-house-user"></i>
                        Handover Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="handoverFlat">Flat Number *</label>
                            <input type="text" id="handoverFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="handoverTower">Tower *</label>
                            <input type="text" id="handoverTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">Customer Name *</label>
                            <input type="text" id="customerName" placeholder="Full name of customer">
                        </div>
                        <div class="form-group">
                            <label for="customerEmail">Customer Email *</label>
                            <input type="email" id="customerEmail" placeholder="customer@email.com">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="secondOwnerName">Second Owner (if any)</label>
                            <input type="text" id="secondOwnerName" placeholder="Full name of second owner">
                        </div>
                        <div class="form-group">
                            <label for="secondOwnerEmail">Second Owner Email</label>
                            <input type="email" id="secondOwnerEmail" placeholder="secondowner@email.com">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hotoMember">HOTO Team Member *</label>
                            <input type="text" id="hotoMember" placeholder="Name of HOTO team member">
                        </div>
                        <div class="form-group">
                            <label for="handoverDateTime">Handover Date & Time *</label>
                            <input type="datetime-local" id="handoverDateTime">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemsHanded">Items Handed Over</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="itemKeys" value="keys">
                                <label for="itemKeys">All Keys</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="itemManual" value="manual">
                                <label for="itemManual">User Manual</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="itemGift" value="gift">
                                <label for="itemGift">Welcome Gift</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerFeedback">Customer Feedback</label>
                        <textarea id="customerFeedback" rows="3" placeholder="Customer comments and feedback..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="finalInspection">Final Inspection Completed</label>
                        <select id="finalInspection" onchange="toggleInspectionRemarks()">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                            <option value="partial">Partial</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="inspectionRemarksContainer" style="display: none;">
                        <label for="inspectionRemarks">Inspection Remarks</label>
                        <textarea id="inspectionRemarks" rows="2" placeholder="Remarks about final inspection..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveHandover()">
                            <i class="fas fa-save"></i> Save Handover
                        </button>
                        <button class="btn btn-secondary" onclick="resetHandoverForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- INTERIORS TAB -->
        <div id="interiors-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-hammer"></i>
                    Interiors Work Process
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('interiors', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('interiors', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('interiors', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="interiors-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="interiors-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- Interiors Form -->
                <div id="interiors-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('interiors')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-paint-roller"></i>
                        Interiors Work Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="interiorsFlat">Flat Number *</label>
                            <input type="text" id="interiorsFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="interiorsTower">Tower *</label>
                            <input type="text" id="interiorsTower" readonly>
                        </div>
                    </div>
                    
                    <!-- REORDERED: Site Supervisor First -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="siteSupervisor">Site Supervisor Name</label>
                            <input type="text" id="siteSupervisor" placeholder="Name of site supervisor">
                        </div>
                        <div class="form-group">
                            <label for="siteSupervisorNumber">Site Supervisor Number *</label>
                            <input type="tel" id="siteSupervisorNumber" placeholder="Supervisor phone number">
                        </div>
                    </div>
                    
                    <!-- Main Vendor Form -->
                    <div id="mainVendorForm">
                        <h4 class="section-title">
                            <i class="fas fa-industry"></i>
                            Main Vendor Details
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="contractorName">Contractor Name *</label>
                                <input type="text" id="contractorName" placeholder="Name of interior contractor">
                            </div>
                            <div class="form-group">
                                <label for="contractorContact">Contractor Contact *</label>
                                <input type="tel" id="contractorContact" placeholder="Contractor phone number">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="workStartDate">Work Start Date *</label>
                                <input type="date" id="workStartDate">
                            </div>
                            <div class="form-group">
                                <label for="estimatedEndDate">Estimated End Date</label>
                                <input type="date" id="estimatedEndDate">
                            </div>
                        </div>
                        
                        <!-- Interior Works Planned -->
                        <div class="form-group">
                            <label>Interior Works Planned</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workFlooring" value="flooring">
                                    <label for="workFlooring">Flooring</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workPainting" value="painting">
                                    <label for="workPainting">Painting</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workElectrical" value="electrical">
                                    <label for="workElectrical">Electrical Fittings</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workPlumbing" value="plumbing">
                                    <label for="workPlumbing">Plumbing Work</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workCarpentry" value="carpentry">
                                    <label for="workCarpentry">Carpentry</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workFalseCeiling" value="false_ceiling">
                                    <label for="workFalseCeiling">False Ceiling</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workKitchen" value="kitchen">
                                    <label for="workKitchen">Kitchen Work</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workWardrobe" value="wardrobe">
                                    <label for="workWardrobe">Wardrobe</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- DOS and DON'Ts Checkbox -->
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="dosDontsExplained">
                                <label for="dosDontsExplained"><strong>DOS and DON'Ts Explained to Contractor</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MOVED: Multiple Vendors Option Below Interior Works -->
                    <div class="form-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="multipleVendors" onchange="toggleMultipleVendors()">
                            <label for="multipleVendors"><strong>Multiple Vendors (This will disable previous vendor details)</strong></label>
                        </div>
                    </div>
                    
                    <!-- Additional Vendors Container -->
                    <div id="additionalVendorsContainer" class="vendor-form hidden">
                        <div class="vendor-header">
                            <h4><i class="fas fa-plus-circle"></i> Additional Vendor</h4>
                            <button type="button" class="remove-vendor" onclick="removeVendor(this)">Remove</button>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="additionalContractorName">Contractor Name *</label>
                                <input type="text" class="additional-contractor-name" placeholder="Name of additional contractor">
                            </div>
                            <div class="form-group">
                                <label for="additionalContractorContact">Contractor Contact *</label>
                                <input type="tel" class="additional-contractor-contact" placeholder="Additional contractor phone">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Interior Works Planned by this Vendor</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-flooring" value="flooring">
                                    <label>Flooring</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-painting" value="painting">
                                    <label>Painting</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-electrical" value="electrical">
                                    <label>Electrical Fittings</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-plumbing" value="plumbing">
                                    <label>Plumbing Work</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-carpentry" value="carpentry">
                                    <label>Carpentry</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-false-ceiling" value="false_ceiling">
                                    <label>False Ceiling</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-kitchen" value="kitchen">
                                    <label>Kitchen Work</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-wardrobe" value="wardrobe">
                                    <label>Wardrobe</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" class="additional-dos-donts-explained">
                                <label><strong>DOS and DON'Ts Explained to this Contractor</strong></label>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="additionalStartDate">Work Start Date *</label>
                                <input type="date" class="additional-start-date">
                            </div>
                            <div class="form-group">
                                <label for="additionalEndDate">Estimated End Date</label>
                                <input type="date" class="additional-end-date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-info" onclick="addAdditionalVendor()" id="addVendorBtn" style="display: none;">
                            <i class="fas fa-plus"></i> Add Another Vendor
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="interiorsRemarks">Remarks / Notes</label>
                        <textarea id="interiorsRemarks" rows="3" placeholder="Additional notes about interior work..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveInteriors()">
                            <i class="fas fa-save"></i> Save Interiors Work
                        </button>
                        <button class="btn btn-warning" onclick="openDeviationForm('interiors')">
                            <i class="fas fa-exclamation-triangle"></i> Record Deviation
                        </button>
                        <button class="btn btn-secondary" onclick="resetInteriorsForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MOVE-IN TAB -->
        <div id="move-in-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-home"></i>
                    Customer Move-in Process
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('move-in', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('move-in', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('move-in', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="move-in-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="move-in-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- Move-in Form -->
                <div id="move-in-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('movein')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-truck-moving"></i>
                        Move-in Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="moveInFlat">Flat Number *</label>
                            <input type="text" id="moveInFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="moveInTower">Tower *</label>
                            <input type="text" id="moveInTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="moveinCustomerName">Customer Name *</label>
                            <input type="text" id="moveinCustomerName" placeholder="Full name of customer moving in">
                        </div>
                        <div class="form-group">
                            <label for="moveinContact">Contact Number *</label>
                            <input type="tel" id="moveinContact" placeholder="Customer contact number">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="moveinDate">Move-in Date *</label>
                            <input type="date" id="moveinDate">
                        </div>
                        <div class="form-group">
                            <label for="moveinTime">Move-in Time *</label>
                            <select id="moveinTime">
                                <option value="morning">Morning (8 AM - 12 PM)</option>
                                <option value="afternoon">Afternoon (12 PM - 4 PM)</option>
                                <option value="evening">Evening (4 PM - 8 PM)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="moveClearanceGiven" onchange="toggleMoveinSave()">
                            <label for="moveClearanceGiven"><strong>Move clearance given by fire and safety team</strong></label>
                        </div>
                    </div>
                    
                    <!-- Deviations Section -->
                    <div id="deviationsSection" style="display: none;">
                        <h4 class="section-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Recorded Deviations (From Interiors)
                        </h4>
                        <div id="deviationsList">
                            <!-- Deviations will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="moveinRemarks">Move-in Remarks</label>
                        <textarea id="moveinRemarks" rows="3" placeholder="Any special requirements or remarks..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveMoveIn()" id="saveMoveinBtn" disabled>
                            <i class="fas fa-save"></i> Save Move-in Details
                        </button>
                        <button class="btn btn-warning" onclick="openDeviationForm('movein')">
                            <i class="fas fa-exclamation-triangle"></i> Record Deviation
                        </button>
                        <button class="btn btn-secondary" onclick="resetMoveInForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- EXCEL PROCESSOR TAB -->
        <div id="excel-processor-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-file-excel"></i>
                    Excel Data Processor
                </h2>
                
                <div class="setup-step">
                    <h3><i class="fas fa-upload"></i> Step 1: Upload Excel File</h3>
                    
                    <div style="margin: 20px 0;">
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <select id="templateSelect" class="btn" style="flex: 1; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;" onchange="selectTemplate()">
                                <option value="">Select Template Type</option>
                                <option value="key_handover">Key Handover Template</option>
                                <option value="snagging">CBRE Snagging Template</option>
                                <option value="first_visit">First Visit Template</option>
                                <option value="handover">Handover Template</option>
                                <option value="interiors">Interiors Template</option>
                                <option value="movein">Move-in Template</option>
                                <option value="project_mep">Project/MEP Template</option>
                                <option value="team4_crm">TEAM4 CRM Template</option>
                                <option value="cbre_crm">CBRE CRM Template</option>
                            </select>
                            <button class="btn btn-warning" onclick="downloadSelectedTemplate()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                        </div>
                        
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                        <div id="dropZone" style="border: 2px dashed #1F3765; border-radius: 8px; padding: 40px; text-align: center; background: #f8fafc; cursor: pointer;" 
                             onclick="document.getElementById('excelFileInput').click()" 
                             ondrop="handleFileDrop(event)" 
                             ondragover="handleDragOver(event)">
                            <i class="fas fa-cloud-upload-alt fa-3x" style="color: #1F3765; margin-bottom: 15px;"></i>
                            <h4>Drag & Drop Excel File Here</h4>
                            <p>or click to browse</p>
                            <p id="selectedFileName" style="margin-top: 15px; color: #666;"></p>
                        </div>
                    </div>
                    
                    <!-- Validation Results -->
                    <div id="validationResults" style="display: none; margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4><i class="fas fa-check-circle" style="color: #28a745;"></i> Validation Results</h4>
                            <div>
                                <span id="validCount" style="background: #d4edda; color: #155724; padding: 5px 10px; border-radius: 20px; font-weight: 600;">0 valid</span>
                                <span id="errorCount" style="background: #f8d7da; color: #721c24; padding: 5px 10px; border-radius: 20px; font-weight: 600; margin-left: 10px;">0 errors</span>
                            </div>
                        </div>
                        
                        <!-- Valid Data Preview -->
                        <div id="validDataSection" style="display: none;">
                            <h5><i class="fas fa-check" style="color: #28a745;"></i> Correct Data Found (First 10 rows)</h5>
                            <div id="validPreviewTable" style="overflow: auto; max-height: 300px; margin: 15px 0; border: 1px solid #28a745; border-radius: 8px;"></div>
                        </div>
                        
                        <!-- Error Data Preview -->
                        <div id="errorDataSection" style="display: none;">
                            <h5><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Data with Errors</h5>
                            <div id="errorPreviewTable" style="overflow: auto; max-height: 300px; margin: 15px 0; border: 1px solid #dc3545; border-radius: 8px;"></div>
                            <div id="errorDetails" style="margin-top: 10px;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="setup-step">
                    <h3><i class="fas fa-cog"></i> Step 2: Configure Import</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="importProcess">Select Process to Import *</label>
                            <select id="importProcess">
                                <option value="">Select Process</option>
                                <option value="key_handover">Key Handover</option>
                                <option value="snagging">CBRE Snagging</option>
                                <option value="first_visit">First Visit</option>
                                <option value="handover">Handover</option>
                                <option value="interiors">Interiors</option>
                                <option value="movein">Move-in</option>
                                <option value="project_mep">Project/MEP</option>
                                <option value="team4_crm">TEAM4 CRM</option>
                                <option value="cbre_crm">CBRE CRM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="importAction">Import Action *</label>
                            <select id="importAction">
                                <option value="append">Append to Existing Data</option>
                                <option value="replace">Replace All Data</option>
                                <option value="update">Update Existing Records</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="validateExcelData()">
                            <i class="fas fa-check-circle"></i> Validate Data
                        </button>
                        <button class="btn btn-primary" onclick="processImport()" id="processImportBtn" disabled>
                            <i class="fas fa-play"></i> Process Import
                        </button>
                    </div>
                    
                    <!-- Import Summary -->
                    <div id="importSummary" class="import-summary" style="display: none;">
                        <h4><i class="fas fa-info-circle"></i> Import Summary</h4>
                        <p id="summaryText">Loading summary...</p>
                    </div>
                </div>
                
                <div class="setup-step">
                    <h3><i class="fas fa-download"></i> Step 3: Export Options</h3>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="exportAllToExcel()">
                            <i class="fas fa-file-excel"></i> Export All Data to Excel
                        </button>
                        <button class="btn btn-accent" onclick="exportSelectedProcess()">
                            <i class="fas fa-filter"></i> Export Selected Process
                        </button>
                        <button class="btn btn-primary" onclick="exportToGoogleSheets()" id="exportGoogleSheetsBtn">
                            <i class="fab fa-google"></i> Export to Google Sheets
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- INTEGRATION TAB -->
        <div id="integration-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-plug"></i>
                    Google Sheets Integration Setup
                </h2>
                
                <!-- Connection Status -->
                <div class="setup-step">
                    <h3><i class="fas fa-link"></i> Connection Status</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Current Status:</label>
                            <div id="connectionStatus" class="status-badge status-connected">
                                <i class="fas fa-check-circle"></i> Connected
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Last Sync:</label>
                            <div id="lastSyncTime">Never</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Local Records:</label>
                            <div id="localRecordsCount">Calculating...</div>
                        </div>
                        <div class="form-group">
                            <label>Cloud Records:</label>
                            <div id="cloudRecordsCount">Not connected</div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 1: Google Sheet Setup -->
                <div class="setup-step">
                    <h3><i class="fas fa-cogs"></i> Step 1: Configure Google Sheet</h3>
                    
                    <div class="template-instructions">
                        <h4><i class="fas fa-exclamation-triangle"></i> IMPORTANT: Your Google Sheet MUST have these sheets:</h4>
                        <div class="required-fields">
                            <div class="required-field">
                                <span class="field-name">key_handover</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">snagging</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">first_visit</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">handover</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">interiors</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">movein</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">project_mep</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">team4_crm</span>
                                <span class="field-type">(TEAM4 CRM - Actual Workflow)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">cbre_crm</span>
                                <span class="field-type">(CBRE CRM - Calls Only)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setup-instruction">
                        <h4><i class="fas fa-download"></i> Create Template</h4>
                        <p>Create a new Google Sheet with the required sheets or use our template:</p>
                        <button class="btn btn-primary" onclick="createGoogleSheetTemplate()">
                            <i class="fab fa-google"></i> Open Google Sheets Template
                        </button>
                        <button class="btn btn-secondary" onclick="downloadSheetTemplate()">
                            <i class="fas fa-download"></i> Download Excel Template
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Web App Deployment -->
                <div class="setup-step">
                    <h3><i class="fas fa-code"></i> Step 2: Deploy Google Apps Script</h3>
                    
                    <div class="setup-instruction">
                        <p><strong>Follow these steps:</strong></p>
                        <ol>
                            <li>Open your Google Sheet</li>
                            <li>Click <strong>Extensions ‚Üí Apps Script</strong></li>
                            <li>Delete any existing code</li>
                            <li>Copy and paste the code from the box below</li>
                            <li>Click <strong>Save</strong> (Ctrl+S)</li>
                            <li>Click <strong>Deploy ‚Üí New Deployment</strong></li>
                            <li>Select <strong>Web App</strong> as type</li>
                            <li>Set "Execute as" to <strong>Me</strong></li>
                            <li>Set "Who has access" to <strong>Anyone</strong></li>
                            <li>Click <strong>Deploy</strong></li>
                            <li>Copy the Web App URL provided</li>
                        </ol>
                    </div>
                    
                    <div class="form-group">
                        <label for="webAppCode">Google Apps Script Code:</label>
                        <textarea id="webAppCode" rows="15" readonly style="font-family: monospace; background: #f8f9fa; padding: 15px;">
// Google Apps Script for HOTO Process Tracker - Updated with TEAM4 CRM
const SHEET_NAMES = ['key_handover', 'snagging', 'first_visit', 'handover', 'interiors', 'movein', 'project_mep', 'team4_crm', 'cbre_crm'];

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  try {
    const action = e.parameter.action;
    const process = e.parameter.process;
    const content = e.postData ? JSON.parse(e.postData.contents) : {};
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // Handle CORS
    const response = ContentService.createTextOutput();
    response.setMimeType(ContentService.MimeType.JSON);
    response.setHeader('Access-Control-Allow-Origin', '*');
    
    let data;
    
    switch(action) {
      case 'get_data':
        data = getData(ss, process);
        break;
      case 'save_data':
        data = saveData(ss, process, content.data);
        break;
      case 'get_all_data':
        data = getAllData(ss);
        break;
      case 'sync_all':
        data = syncAllData(ss, content.data);
        break;
      case 'ping':
        data = {status: 'online', timestamp: new Date().toISOString(), version: '3.0'};
        break;
      case 'get_stats':
        data = getStatistics(ss);
        break;
      case 'get_flat_data':
        data = getFlatData(ss, content.tower, content.flat, content.process);
        break;
      case 'get_dashboard_counts':
        data = getDashboardCounts(ss);
        break;
      default:
        data = {error: 'Invalid action', valid_actions: ['get_data', 'save_data', 'get_all_data', 'sync_all', 'ping', 'get_stats', 'get_flat_data', 'get_dashboard_counts']};
    }
    
    response.setContent(JSON.stringify(data));
    return response;
    
  } catch (error) {
    Logger.log('Error: ' + error.toString());
    const response = ContentService.createTextOutput(JSON.stringify({
      error: error.toString(),
      stack: error.stack
    }));
    response.setMimeType(ContentService.MimeType.JSON);
    response.setHeader('Access-Control-Allow-Origin', '*');
    return response;
  }
}

function getData(ss, process) {
  if (!SHEET_NAMES.includes(process)) {
    return {error: 'Invalid process name', valid_processes: SHEET_NAMES, data: []};
  }
  
  const sheet = ss.getSheetByName(process);
  if (!sheet) {
    return {data: [], count: 0, message: `Sheet ${process} not found`};
  }
  
  const data = getSheetData(sheet);
  return {data: data, count: data.length, process: process};
}

function getAllData(ss) {
  const allData = {};
  SHEET_NAMES.forEach(process => {
    const sheet = ss.getSheetByName(process);
    if (sheet) {
      allData[process] = getSheetData(sheet);
    } else {
      allData[process] = [];
    }
  });
  
  return allData;
}

function saveData(ss, process, rowData) {
  if (!SHEET_NAMES.includes(process)) {
    return {error: 'Invalid process name', valid_processes: SHEET_NAMES};
  }
  
  let sheet = ss.getSheetByName(process);
  if (!sheet) {
    sheet = ss.insertSheet(process);
    const headers = getHeadersForProcess(process);
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  }
  
  // Ensure headers exist
  if (sheet.getLastRow() === 0) {
    const headers = getHeadersForProcess(process);
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  }
  
  const data = getSheetData(sheet);
  const existingIndex = data.findIndex(row => 
    row.tower === rowData.tower && row.flat === rowData.flat);
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  if (existingIndex >= 0) {
    // Update existing row
    const rowNumber = existingIndex + 2; // +2 because of header row
    const rowValues = headers.map(header => rowData[header] || '');
    sheet.getRange(rowNumber, 1, 1, headers.length).setValues([rowValues]);
    return {success: true, message: 'Data updated successfully', action: 'update'};
  } else {
    // Add new row
    const rowValues = headers.map(header => rowData[header] || '');
    sheet.appendRow(rowValues);
    return {success: true, message: 'Data saved successfully', action: 'insert'};
  }
}

function syncAllData(ss, allData) {
  const results = {};
  
  SHEET_NAMES.forEach(process => {
    if (allData[process]) {
      results[process] = [];
      
      allData[process].forEach(rowData => {
        const result = saveData(ss, process, rowData);
        results[process].push(result);
      });
    }
  });
  
  return {success: true, results: results, timestamp: new Date().toISOString()};
}

function getSheetData(sheet) {
  const lastRow = sheet.getLastRow();
  if (lastRow <= 1) return [];
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const dataRange = sheet.getRange(2, 1, lastRow - 1, headers.length);
  const values = dataRange.getValues();
  
  return values.map(row => {
    const obj = {};
    headers.forEach((header, index) => {
      obj[header] = row[index];
    });
    return obj;
  });
}

function getHeadersForProcess(process) {
  const headers = {
    'key_handover': ['id', 'tower', 'flat', 'handover_person', 'received_by_cbre', 'handover_date', 'all_keys_not_handed', 'key_remarks', 'created_at', 'updated_at'],
    'snagging': ['id', 'tower', 'flat', 'mep_inspector', 'mep_start_date', 'mep_end_date', 'mep_completed', 'civil_inspector', 'civil_start_date', 'civil_end_date', 'civil_completed', 'electrical_inspector', 'electrical_start_date', 'electrical_end_date', 'electrical_completed', 'water_inspector', 'water_start_date', 'water_end_date', 'water_completed', 'ac_drain_inspector', 'ac_drain_start_date', 'ac_drain_end_date', 'ac_drain_completed', 'tiles_inspector', 'tiles_start_date', 'tiles_end_date', 'tiles_completed', 'snag_remarks', 'followup_date', 'created_at', 'updated_at'],
    'first_visit': ['id', 'tower', 'flat', 'owner_name', 'owner_phone', 'visit_datetime', 'hot_member', 'owner_will_inform_date', 'handover_suggested', 'going_for_third_party', 'third_party_date_confirmed', 'report_received_date', 'soft_copy', 'hard_copy', 'informed_to_project_team', 'project_team_informed_date', 'cbre_checking_done', 'cbre_checking_date', 'customer_remarks', 'crm_noc', 'created_at', 'updated_at'],
    'handover': ['id', 'tower', 'flat', 'customer_name', 'customer_email', 'second_owner_name', 'second_owner_email', 'hoto_member', 'handover_datetime', 'items_handed', 'customer_feedback', 'final_inspection', 'inspection_remarks', 'created_at', 'updated_at'],
    'interiors': ['id', 'tower', 'flat', 'site_supervisor', 'site_supervisor_number', 'contractor_name', 'contractor_contact', 'work_start_date', 'estimated_end_date', 'works_planned', 'dos_donts_explained', 'multiple_vendors', 'additional_vendors_json', 'remarks', 'created_at', 'updated_at'],
    'movein': ['id', 'tower', 'flat', 'customer_name', 'contact_number', 'movein_date', 'movein_time', 'move_clearance_given', 'deviations_json', 'remarks', 'created_at', 'updated_at'],
    'project_mep': ['id', 'tower', 'flat', 'snags_status', 'confirmation_date', 'cbre_checked', 'cbre_checked_date', 'created_at', 'updated_at'],
    'team4_crm': ['id', 'tower', 'flat', 'action_type', 'assigned_to', 'start_date', 'registration_completed', 'noc_given_to_cbre', 'remarks', 'created_at', 'updated_at'],
    'cbre_crm': ['id', 'tower', 'flat', 'description', 'informed_to', 'status', 'caller_name', 'caller_phone', 'followup_date', 'remarks', 'created_at', 'updated_at']
  };
  
  return headers[process] || [];
}

function getStatistics(ss) {
  const stats = {};
  
  SHEET_NAMES.forEach(process => {
    const sheet = ss.getSheetByName(process);
    if (sheet) {
      const data = getSheetData(sheet);
      stats[process] = {
        count: data.length,
        lastUpdated: sheet.getLastRow() > 1 ? 'Has data' : 'Empty'
      };
    } else {
      stats[process] = {count: 0, lastUpdated: 'Sheet not found'};
    }
  });
  
  return stats;
}

function getFlatData(ss, tower, flat, process = null) {
  const result = {};
  
  if (process) {
    // Get data for specific process
    if (!SHEET_NAMES.includes(process)) {
      return {error: 'Invalid process name'};
    }
    
    const sheet = ss.getSheetByName(process);
    if (sheet) {
      const data = getSheetData(sheet);
      const flatData = data.filter(row => row.tower === tower && row.flat === flat);
      result[process] = flatData.length > 0 ? flatData[0] : null;
    }
  } else {
    // Get data for all processes
    SHEET_NAMES.forEach(processName => {
      const sheet = ss.getSheetByName(processName);
      if (sheet) {
        const data = getSheetData(sheet);
        const flatData = data.filter(row => row.tower === tower && row.flat === flat);
        if (flatData.length > 0) {
          result[processName] = flatData[0];
        }
      }
    });
  }
  
  return result;
}

function getDashboardCounts(ss) {
  const counts = {};
  
  SHEET_NAMES.forEach(process => {
    const sheet = ss.getSheetByName(process);
    if (sheet) {
      const lastRow = sheet.getLastRow();
      counts[process] = lastRow > 1 ? lastRow - 1 : 0;
    } else {
      counts[process] = 0;
    }
  });
  
  return counts;
}
                        </textarea>
                    </div>
                    
                    <button class="btn btn-success" onclick="copyWebAppCode()">
                        <i class="fas fa-copy"></i> Copy Code to Clipboard
                    </button>
                </div>
                
                <!-- Step 3: Connect to Web App -->
                <div class="setup-step">
                    <h3><i class="fas fa-wifi"></i> Step 3: Connect to Web App</h3>
                    
                    <div class="form-group">
                        <label for="webAppUrl">Web App URL *</label>
                        <input type="text" id="webAppUrl" placeholder="https://script.google.com/macros/s/..." style="font-family: monospace;">
                        <p class="datetime-display">
                            <i class="fas fa-info-circle"></i>
                            Paste the URL from your deployed web app
                        </p>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="testConnection()">
                            <i class="fas fa-plug"></i> Test Connection
                        </button>
                        <button class="btn btn-success" onclick="saveConnection()">
                            <i class="fas fa-save"></i> Save Connection
                        </button>
                        <button class="btn btn-accent" onclick="syncAllData()">
                            <i class="fas fa-sync-alt"></i> Sync All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics-tab" class="tab-content">
            <div class="analytics-controls">
                <h2 class="section-title">
                    <i class="fas fa-chart-bar"></i>
                    Analytics Dashboard
                </h2>
                
                <div class="date-range-filter">
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate">
                    </div>
                    <div class="form-group">
                        <label for="towerFilter">Tower Filter</label>
                        <select id="towerFilter">
                            <option value="all">All Towers</option>
                            <option value="A">Tower A</option>
                            <option value="B">Tower B</option>
                            <option value="C">Tower C</option>
                        </select>
                    </div>
                </div>
                
                <div class="quick-filter-buttons">
                    <button class="quick-filter-btn active" onclick="setDateFilter('today')">Today</button>
                    <button class="quick-filter-btn" onclick="setDateFilter('week')">This Week</button>
                    <button class="quick-filter-btn" onclick="setDateFilter('month')">This Month</button>
                    <button class="quick-filter-btn" onclick="setDateFilter('quarter')">This Quarter</button>
                    <button class="quick-filter-btn" onclick="setDateFilter('year')">This Year</button>
                    <button class="quick-filter-btn" onclick="setDateFilter('all')">All Time</button>
                </div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Process Completion Rates</h3>
                        <button class="report-btn" onclick="exportChart('completionChart')">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    <div class="canvas-container">
                        <canvas id="completionChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Tower-wise Distribution</h3>
                        <button class="report-btn" onclick="exportChart('towerChart')">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    <div class="canvas-container">
                        <canvas id="towerChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Monthly Progress Trend</h3>
                        <button class="report-btn" onclick="exportChart('trendChart')">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    <div class="canvas-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Status Overview</h3>
                        <button class="report-btn" onclick="exportChart('statusChart')">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    <div class="canvas-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="report-actions">
                <button class="btn btn-success" onclick="generateAnalyticsReport()">
                    <i class="fas fa-file-pdf"></i> Generate Full Report
                </button>
                <button class="btn btn-primary" onclick="exportAnalyticsData()">
                    <i class="fas fa-file-excel"></i> Export Analytics Data
                </button>
                <button class="btn btn-info" onclick="refreshAnalytics()">
                    <i class="fas fa-sync-alt"></i> Refresh Analytics
                </button>
            </div>
        </div>
        
        <!-- MODAL FOR FLAT DETAILS -->
        <div id="flatDetailsModal" class="modal-overlay">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal()">&times;</button>
                <h2 class="section-title">
                    <i class="fas fa-home"></i>
                    Complete Flat Details
                </h2>
                <div id="flatDetailsContent">
                    <!-- Details will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- MODAL FOR DEVIATIONS -->
        <div id="deviationModal" class="modal-overlay">
            <div class="modal-content">
                <button class="modal-close" onclick="closeDeviationModal()">&times;</button>
                <h2 class="section-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Record Deviation
                </h2>
                <div id="deviationFormContent">
                    <!-- Deviation form will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- NOTIFICATION CONTAINER -->
    <div id="notificationContainer"></div>
    
    <script>
        // Global Variables
        let currentTower = 'A';
        let currentFloor = '1';
        let currentFlat = '';
        let currentProcess = '';
        let selectedTab = 'dashboard';
        let backendUrl = localStorage.getItem('hoto_backend_url') || '';
        let chartInstances = {};
        let allProcessData = {}; // Store all process data for workflow filtering
        let excelValidationResults = { valid: [], errors: [] }; // Store Excel validation results
        let currentChartFilter = 'all'; // Track current chart filter
        
        // Building Configuration - UPDATED with correct flat numbering
        const BUILDING_CONFIG = {
            towers: ['A', 'B', 'C'],
            floors: 35,
            flatsPerFloor: 9, // Flats 1-9
            refugeFlats: ['1806', '2806'] // Only 1806 and 2806 are refuge flats
        };
        
        // Excel Template Schemas for validation
        const EXCEL_TEMPLATES = {
            'key_handover': {
                required: ['tower', 'flat', 'handover_person', 'received_by_cbre', 'handover_date'],
                optional: ['all_keys_not_handed', 'key_remarks']
            },
            'snagging': {
                required: ['tower', 'flat'],
                optional: ['mep_inspector', 'mep_start_date', 'mep_end_date', 'mep_completed', 'civil_inspector', 'civil_start_date', 'civil_end_date', 'civil_completed', 'electrical_inspector', 'electrical_start_date', 'electrical_end_date', 'electrical_completed', 'water_inspector', 'water_start_date', 'water_end_date', 'water_completed', 'ac_drain_inspector', 'ac_drain_start_date', 'ac_drain_end_date', 'ac_drain_completed', 'tiles_inspector', 'tiles_start_date', 'tiles_end_date', 'tiles_completed', 'snag_remarks', 'followup_date']
            },
            'first_visit': {
                required: ['tower', 'flat', 'owner_name', 'owner_phone', 'visit_datetime', 'hot_member'],
                optional: ['owner_will_inform_date', 'handover_suggested', 'going_for_third_party', 'third_party_date_confirmed', 'report_received_date', 'soft_copy', 'hard_copy', 'informed_to_project_team', 'project_team_informed_date', 'cbre_checking_done', 'cbre_checking_date', 'customer_remarks', 'crm_noc']
            },
            'handover': {
                required: ['tower', 'flat', 'customer_name', 'customer_email', 'hoto_member', 'handover_datetime'],
                optional: ['second_owner_name', 'second_owner_email', 'items_handed', 'customer_feedback', 'final_inspection', 'inspection_remarks']
            },
            'interiors': {
                required: ['tower', 'flat', 'site_supervisor_number', 'contractor_name', 'contractor_contact', 'work_start_date'],
                optional: ['site_supervisor', 'estimated_end_date', 'works_planned', 'dos_donts_explained', 'multiple_vendors', 'additional_vendors_json', 'remarks']
            },
            'movein': {
                required: ['tower', 'flat', 'customer_name', 'contact_number', 'movein_date', 'movein_time'],
                optional: ['move_clearance_given', 'deviations_json', 'remarks']
            },
            'project_mep': {
                required: ['tower', 'flat', 'snags_status'],
                optional: ['confirmation_date', 'cbre_checked', 'cbre_checked_date']
            },
            'team4_crm': {
                required: ['tower', 'flat', 'action_type', 'assigned_to', 'start_date'],
                optional: ['registration_completed', 'noc_given_to_cbre', 'remarks']
            },
            'cbre_crm': {
                required: ['tower', 'flat', 'description', 'informed_to', 'status'],
                optional: ['caller_name', 'caller_phone', 'followup_date', 'remarks']
            }
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadDashboardData();
            updateDateTime();
            setInterval(updateDateTime, 60000); // Update every minute
        });
        
        // Initialize the application
        function initializeApp() {
            // Set current date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('currentDate').textContent = formatDate(new Date());
            
            // Set default dates in forms
            setDefaultDates();
            
            // Initialize floor buttons for all processes
            initializeFloorButtons();
            
            // Test backend connection if URL exists
            if (backendUrl) {
                testBackendConnection();
            }
            
            // Initialize charts with empty data
            initializeCharts();
            
            // Load all process data for workflow filtering
            loadAllProcessData();
            
            // Setup Excel file input listener
            setupExcelFileInput();
            
            // Load upcoming events
            loadUpcomingEvents();
            
            // Initialize tower progress chart
            updateTowerProgressChart();
        }
        
        // Load upcoming first visits and handovers
        function loadUpcomingEvents() {
            // This function should load real data from backend
            // For now, we'll use dummy data
            updateUpcomingEventsWithRealData();
        }
        
        // Update upcoming events with real data - FIXED date formatting
        function updateUpcomingEventsWithRealData() {
            const upcomingFirstVisits = [];
            const upcomingHandovers = [];
            
            // Get current date
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            // Check first visit data
            if (allProcessData.first_visit) {
                allProcessData.first_visit.forEach(visit => {
                    if (visit.visit_datetime) {
                        const visitDate = new Date(visit.visit_datetime);
                        if (visitDate >= today && visitDate <= nextWeek) {
                            upcomingFirstVisits.push({
                                flat: `${visit.tower}${visit.flat}`,
                                date: visitDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                                owner: visit.owner_name || 'Not specified'
                            });
                        }
                    }
                });
            }
            
            // Check handover data
            if (allProcessData.handover) {
                allProcessData.handover.forEach(handover => {
                    if (handover.handover_datetime) {
                        const handoverDate = new Date(handover.handover_datetime);
                        if (handoverDate >= today && handoverDate <= nextWeek) {
                            upcomingHandovers.push({
                                flat: `${handover.tower}${handover.flat}`,
                                date: handoverDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                                customer: handover.customer_name || 'Not specified'
                            });
                        }
                    }
                });
            }
            
            // Update UI
            updateUpcomingEventsUI(upcomingFirstVisits, upcomingHandovers);
        }
        
        // Update upcoming events UI
        function updateUpcomingEventsUI(firstVisits, handovers) {
            const firstVisitsContainer = document.getElementById('upcomingFirstVisits');
            const handoversContainer = document.getElementById('upcomingHandovers');
            
            // Update first visits
            if (firstVisits.length > 0) {
                firstVisitsContainer.innerHTML = '';
                firstVisits.forEach(visit => {
                    const item = document.createElement('div');
                    item.className = 'upcoming-item first-visit';
                    item.innerHTML = `
                        <div>
                            <strong>${visit.flat}</strong><br>
                            <small>${visit.owner}</small>
                        </div>
                        <div class="upcoming-date">${visit.date}</div>
                    `;
                    firstVisitsContainer.appendChild(item);
                });
            } else {
                firstVisitsContainer.innerHTML = `
                    <div class="no-events">
                        <i class="fas fa-calendar-times fa-2x"></i>
                        <p>No upcoming first visits in the next 7 days</p>
                    </div>
                `;
            }
            
            // Update handovers
            if (handovers.length > 0) {
                handoversContainer.innerHTML = '';
                handovers.forEach(handover => {
                    const item = document.createElement('div');
                    item.className = 'upcoming-item handover';
                    item.innerHTML = `
                        <div>
                            <strong>${handover.flat}</strong><br>
                            <small>${handover.customer}</small>
                        </div>
                        <div class="upcoming-date">${handover.date}</div>
                    `;
                    handoversContainer.appendChild(item);
                });
            } else {
                handoversContainer.innerHTML = `
                    <div class="no-events">
                        <i class="fas fa-calendar-times fa-2x"></i>
                        <p>No upcoming handovers in the next 7 days</p>
                    </div>
                `;
            }
        }
        
        // Setup Excel file input
        function setupExcelFileInput() {
            const fileInput = document.getElementById('excelFileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleExcelFileSelect);
            }
        }
        
        // Handle Excel file selection
        function handleExcelFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('selectedFileName').textContent = `Selected: ${file.name}`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const excelData = XLSX.utils.sheet_to_json(firstSheet);
                
                // Store data for validation
                window.excelData = excelData;
                
                // Show validation results
                validateExcelData();
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Validate Excel data against template
        function validateExcelData() {
            const process = document.getElementById('templateSelect').value || document.getElementById('importProcess').value;
            if (!process) {
                showNotification('Please select a template type first', 'error');
                return;
            }
            
            if (!window.excelData || window.excelData.length === 0) {
                showNotification('No Excel data loaded. Please upload a file first.', 'error');
                return;
            }
            
            const template = EXCEL_TEMPLATES[process];
            if (!template) {
                showNotification(`No validation template found for ${process}`, 'error');
                return;
            }
            
            const validRows = [];
            const errorRows = [];
            
            // Validate each row
            window.excelData.forEach((row, index) => {
                const errors = [];
                
                // Check required fields
                template.required.forEach(field => {
                    if (!row[field] && row[field] !== 0 && row[field] !== false) {
                        errors.push(`Missing required field: ${field}`);
                    }
                });
                
                // Validate flat format
                if (row.flat) {
                    // Check if flat is in correct format (3 or 4 digits)
                    const flatStr = String(row.flat);
                    if (!/^\d{3,4}$/.test(flatStr)) {
                        errors.push(`Invalid flat format: ${flatStr}. Should be 3-4 digits (e.g., 101, 209, 1806)`);
                    }
                }
                
                // Validate tower
                if (row.tower && !['A', 'B', 'C'].includes(String(row.tower).toUpperCase())) {
                    errors.push(`Invalid tower: ${row.tower}. Should be A, B, or C`);
                }
                
                // Validate dates
                const dateFields = ['handover_date', 'mep_start_date', 'mep_end_date', 'visit_datetime', 'handover_datetime', 'work_start_date', 'movein_date', 'start_date'];
                dateFields.forEach(dateField => {
                    if (row[dateField]) {
                        const dateValue = String(row[dateField]);
                        if (!isValidDate(dateValue)) {
                            errors.push(`Invalid date format for ${dateField}: ${dateValue}`);
                        }
                    }
                });
                
                if (errors.length === 0) {
                    validRows.push({ ...row, _rowIndex: index + 2 }); // +2 for header row and 1-based index
                } else {
                    errorRows.push({
                        row: row,
                        errors: errors,
                        _rowIndex: index + 2
                    });
                }
            });
            
            // Store validation results
            excelValidationResults = { valid: validRows, errors: errorRows };
            
            // Update UI with validation results
            updateValidationResultsUI(validRows, errorRows, process);
            
            // Enable/disable import button
            document.getElementById('processImportBtn').disabled = validRows.length === 0;
            
            showNotification(`Validation complete: ${validRows.length} valid rows, ${errorRows.length} rows with errors`, 
                           validRows.length > 0 ? 'success' : 'warning');
        }
        
        // Update validation results UI
        function updateValidationResultsUI(validRows, errorRows, process) {
            const resultsDiv = document.getElementById('validationResults');
            const validCount = document.getElementById('validCount');
            const errorCount = document.getElementById('errorCount');
            const validDataSection = document.getElementById('validDataSection');
            const errorDataSection = document.getElementById('errorDataSection');
            const validPreviewTable = document.getElementById('validPreviewTable');
            const errorPreviewTable = document.getElementById('errorPreviewTable');
            const errorDetails = document.getElementById('errorDetails');
            
            // Update counts
            validCount.textContent = `${validRows.length} valid`;
            errorCount.textContent = `${errorRows.length} errors`;
            
            // Show valid data preview (first 10 rows)
            if (validRows.length > 0) {
                validDataSection.style.display = 'block';
                const headers = Object.keys(validRows[0]).filter(key => !key.startsWith('_'));
                const previewRows = validRows.slice(0, 10);
                
                let tableHTML = '<table style="width:100%; border-collapse:collapse;">';
                tableHTML += '<thead><tr>';
                headers.forEach(header => {
                    tableHTML += `<th style="padding:8px; border:1px solid #ddd; background:#f8f9fa;">${header}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                previewRows.forEach(row => {
                    tableHTML += '<tr>';
                    headers.forEach(header => {
                        tableHTML += `<td style="padding:8px; border:1px solid #ddd;">${row[header] || ''}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table>';
                validPreviewTable.innerHTML = tableHTML;
            } else {
                validDataSection.style.display = 'none';
            }
            
            // Show error data
            if (errorRows.length > 0) {
                errorDataSection.style.display = 'block';
                
                // Show error rows table
                const errorHeaders = Object.keys(errorRows[0].row || {}).filter(key => !key.startsWith('_'));
                const errorPreviewRows = errorRows.slice(0, 10);
                
                let errorTableHTML = '<table style="width:100%; border-collapse:collapse;">';
                errorTableHTML += '<thead><tr>';
                errorHeaders.forEach(header => {
                    errorTableHTML += `<th style="padding:8px; border:1px solid #ddd; background:#f8f9fa;">${header}</th>`;
                });
                errorTableHTML += '<th style="padding:8px; border:1px solid #ddd; background:#f8f9fa;">Errors</th>';
                errorTableHTML += '</tr></thead><tbody>';
                
                errorPreviewRows.forEach(errorRow => {
                    errorTableHTML += '<tr style="background:#fff5f5;">';
                    errorHeaders.forEach(header => {
                        errorTableHTML += `<td style="padding:8px; border:1px solid #ddd;">${errorRow.row[header] || ''}</td>`;
                    });
                    errorTableHTML += `<td style="padding:8px; border:1px solid #ddd; color:#dc3545;">${errorRow.errors.join(', ')}</td>`;
                    errorTableHTML += '</tr>';
                });
                
                errorTableHTML += '</tbody></table>';
                errorPreviewTable.innerHTML = errorTableHTML;
                
                // Show error summary
                let errorSummary = '<div style="margin-top:10px;">';
                errorSummary += `<p><strong>Total errors found:</strong> ${errorRows.length} rows</p>`;
                
                // Group errors by type
                const errorTypes = {};
                errorRows.forEach(errorRow => {
                    errorRow.errors.forEach(error => {
                        errorTypes[error] = (errorTypes[error] || 0) + 1;
                    });
                });
                
                if (Object.keys(errorTypes).length > 0) {
                    errorSummary += '<p><strong>Error types:</strong></p><ul style="margin-left:20px;">';
                    Object.entries(errorTypes).forEach(([error, count]) => {
                        errorSummary += `<li>${error}: ${count} rows</li>`;
                    });
                    errorSummary += '</ul>';
                }
                errorSummary += '</div>';
                errorDetails.innerHTML = errorSummary;
            } else {
                errorDataSection.style.display = 'none';
            }
            
            // Show validation results section
            resultsDiv.style.display = 'block';
        }
        
        // Check if a string is a valid date
        function isValidDate(dateString) {
            // Try to parse the date
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date);
        }
        
        // Load all process data for workflow filtering
        async function loadAllProcessData() {
            if (!backendUrl) return;
            
            try {
                const response = await callBackend('get_all_data');
                if (response) {
                    allProcessData = response;
                    console.log('All process data loaded:', allProcessData);
                    
                    // Update upcoming events with real data
                    updateUpcomingEventsWithRealData();
                    
                    // Update tower progress chart with real data
                    updateTowerProgressChart();
                }
            } catch (error) {
                console.error('Error loading process data:', error);
            }
        }
        
        // Set default dates in form fields
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            
            // Set today's date in all date fields
            const dateFields = [
                'handoverDate', 'mepStartDate', 'mepEndDate', 'civilStartDate', 
                'civilEndDate', 'electricalStartDate', 'electricalEndDate',
                'waterStartDate', 'waterEndDate', 'acDrainStartDate', 'acDrainEndDate',
                'tilesStartDate', 'tilesEndDate', 'followupDate', 'confirmationDate',
                'cbreCheckedDate', 'cbreCheckingDate', 'projectTeamInformedDate',
                'reportReceivedDate', 'thirdPartyDateConfirmed', 'handoverSuggested',
                'workStartDate', 'estimatedEndDate', 'moveinDate',
                'team4CRMDate', 'cbreCRMFollowupDate'
            ];
            
            dateFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = today;
                }
            });
            
            // Set datetime-local fields to current time
            const now = new Date();
            const localDateTime = now.toISOString().slice(0, 16);
            
            const datetimeFields = ['visitDateTime', 'handoverDateTime'];
            datetimeFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = localDateTime;
                }
            });
        }
        
        // Update date and time display
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = formatDate(now);
        }
        
        // Format date for display - FIXED to use toLocaleString
        function formatDate(date) {
            return date.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Open tab function
        function openTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab
            const activeTab = document.querySelector(`.tab[onclick="openTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            selectedTab = tabName;
            
            // Load data for the selected tab
            if (tabName === 'dashboard') {
                loadDashboardData();
            } else if (tabName === 'analytics') {
                loadAnalyticsData();
            }
            
            // Reload all process data when switching tabs
            loadAllProcessData();
        }
        
        // Select tower for a process
        function selectTower(process, tower) {
            currentTower = tower;
            currentProcess = process;
            
            // Update active tower button
            const buttons = document.querySelectorAll(`#${process}-tab .tower-btn`);
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(tower)) {
                    btn.classList.add('active');
                }
            });
            
            // Generate floor buttons
            generateFloorButtons(process);
        }
        
        // Generate floor buttons - FIXED to correctly highlight only selected floor
        function generateFloorButtons(process) {
            const container = document.getElementById(`${process}-floor-buttons`);
            if (!container) return;
            
            container.innerHTML = '';
            
            for (let i = 1; i <= BUILDING_CONFIG.floors; i++) {
                const floorNum = i.toString();
                const button = document.createElement('button');
                button.className = 'floor-btn';
                button.textContent = floorNum;
                button.dataset.floor = floorNum; // Add data attribute for easier selection
                
                // Check if this floor has refuge flats (only 18 and 28)
                const hasRefugeFlat = floorNum === '18' || floorNum === '28';
                if (hasRefugeFlat) {
                    button.classList.add('refuge');
                    // Store original text content for comparison
                    button.dataset.originalText = floorNum;
                }
                
                button.onclick = () => selectFloor(process, floorNum);
                container.appendChild(button);
            }
            
            // Select first floor by default
            if (container.firstChild) {
                selectFloor(process, '1');
            }
        }
        
        // Initialize floor buttons for all processes
        function initializeFloorButtons() {
            const processes = [
                'key-handover', 'snagging', 'project-mep', 'team4-crm', 'cbre-crm',
                'first-visit', 'handover', 'interiors', 'move-in'
            ];
            
            processes.forEach(process => {
                generateFloorButtons(process);
            });
        }
        
        // Select floor - FIXED to correctly highlight only the clicked floor
        function selectFloor(process, floor) {
            currentFloor = floor;
            
            // Update active floor button
            const container = document.getElementById(`${process}-floor-buttons`);
            const buttons = container.querySelectorAll('.floor-btn');
            
            // Remove active class from all buttons
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the correct button
            buttons.forEach(btn => {
                // Compare using data attribute or text content
                if (btn.dataset.floor === floor || 
                    btn.textContent.trim() === floor || 
                    btn.dataset.originalText === floor) {
                    btn.classList.add('active');
                }
            });
            
            // Generate flats for the selected floor with workflow filtering
            generateFlatsWithWorkflow(process, floor);
        }
        
        // Generate flats with correct numbering (101, 102, ..., 109, 201, ..., 209, etc.)
        function generateFlatsWithWorkflow(process, floor) {
            const container = document.getElementById(`${process}-flat-grid`);
            if (!container) return;
            
            container.innerHTML = '';
            
            // Get flats that should be shown based on workflow
            const flatsToShow = getFlatsForProcess(process, floor);
            
            for (let i = 1; i <= BUILDING_CONFIG.flatsPerFloor; i++) {
                // Create flat number in format: floor (1-2 digits) + flat (2 digits)
                const flatNum = `${floor}${i.toString().padStart(2, '0')}`; // e.g., 101, 102, ..., 109, 201, etc.
                const fullFlatNum = `${currentTower}${flatNum}`; // e.g., A101, A102
                
                // Check if this flat should be shown based on workflow
                if (flatsToShow.includes(fullFlatNum)) {
                    const button = document.createElement('div');
                    button.className = 'flat-item';
                    button.textContent = flatNum; // Show without tower prefix
                    button.dataset.flat = fullFlatNum; // Store full flat number with tower
                    
                    // Check if this is a refuge flat (only 1806 and 2806)
                    if (BUILDING_CONFIG.refugeFlats.includes(flatNum)) {
                        button.classList.add('refuge');
                        button.innerHTML = `${flatNum} <span class="refuge-indicator">R</span>`;
                    }
                    
                    button.onclick = () => selectFlat(process, fullFlatNum);
                    container.appendChild(button);
                }
            }
            
            // Show the form container if there are flats
            const formContainer = document.getElementById(`${process}-form-container`);
            if (formContainer && container.children.length > 0) {
                formContainer.style.display = 'block';
            } else if (formContainer) {
                formContainer.style.display = 'none';
                showNotification(`No flats available for ${process.replace('-', ' ')} on floor ${floor}`, 'info');
            }
        }
        
        // Get flats for process based on workflow
        function getFlatsForProcess(process, floor) {
            const flats = [];
            
            // Generate all possible flats for this floor in correct format
            for (let i = 1; i <= BUILDING_CONFIG.flatsPerFloor; i++) {
                const flatNum = `${floor}${i.toString().padStart(2, '0')}`;
                flats.push(`${currentTower}${flatNum}`);
            }
            
            // Filter based on workflow
            switch(process) {
                case 'key-handover':
                    // Show all flats for key handover
                    return flats;
                    
                case 'snagging':
                    // Show flats that have key handover completed but snagging not completed
                    return flats.filter(flat => {
                        const keyHandoverData = getFlatDataForProcess('key_handover', flat);
                        const snaggingData = getFlatDataForProcess('snagging', flat);
                        
                        // Has key handover but not completed snagging
                        return keyHandoverData && !isSnaggingCompleted(snaggingData);
                    });
                    
                case 'project-mep':
                    // Show flats that have snagging completed but project/mep not completed
                    return flats.filter(flat => {
                        const snaggingData = getFlatDataForProcess('snagging', flat);
                        const projectMEPData = getFlatDataForProcess('project_mep', flat);
                        
                        return isSnaggingCompleted(snaggingData) && !projectMEPData;
                    });
                    
                case 'team4-crm':
                    // Show flats that have project/mep completed but team4 crm not completed
                    return flats.filter(flat => {
                        const projectMEPData = getFlatDataForProcess('project_mep', flat);
                        const team4CRMData = getFlatDataForProcess('team4_crm', flat);
                        
                        return projectMEPData && !team4CRMData;
                    });
                    
                case 'first-visit':
                    // Show flats that have team4 crm completed but first visit not completed
                    return flats.filter(flat => {
                        const team4CRMData = getFlatDataForProcess('team4_crm', flat);
                        const firstVisitData = getFlatDataForProcess('first_visit', flat);
                        
                        return team4CRMData && !firstVisitData;
                    });
                    
                case 'handover':
                    // Show flats that have first visit completed but handover not completed
                    return flats.filter(flat => {
                        const firstVisitData = getFlatDataForProcess('first_visit', flat);
                        const handoverData = getFlatDataForProcess('handover', flat);
                        
                        return firstVisitData && !handoverData;
                    });
                    
                case 'interiors':
                    // Show flats that have handover completed but interiors not completed
                    return flats.filter(flat => {
                        const handoverData = getFlatDataForProcess('handover', flat);
                        const interiorsData = getFlatDataForProcess('interiors', flat);
                        
                        return handoverData && !interiorsData;
                    });
                    
                case 'move-in':
                    // Show flats that have interiors completed but move-in not completed
                    return flats.filter(flat => {
                        const interiorsData = getFlatDataForProcess('interiors', flat);
                        const moveinData = getFlatDataForProcess('movein', flat);
                        
                        return interiorsData && !moveinData;
                    });
                    
                case 'cbre-crm':
                    // Show all flats for CBRE CRM (calls only)
                    return flats;
                    
                default:
                    return flats;
            }
        }
        
        // Get flat data for a specific process
        function getFlatDataForProcess(process, flat) {
            if (!allProcessData[process]) return null;
            
            const flatData = allProcessData[process].find(item => 
                item.tower === currentTower && item.flat === flat
            );
            
            return flatData || null;
        }
        
        // Check if snagging is completed
        function isSnaggingCompleted(snaggingData) {
            if (!snaggingData) return false;
            
            // Check all snagging categories
            const categories = ['mep_completed', 'civil_completed', 'electrical_completed', 
                               'water_completed', 'ac_drain_completed', 'tiles_completed'];
            
            return categories.every(category => 
                snaggingData[category] === 'true' || snaggingData[category] === true
            );
        }
        
        // Select flat
        function selectFlat(process, flat) {
            currentFlat = flat;
            
            // Update selected flat
            const container = document.getElementById(`${process}-flat-grid`);
            const flats = container.querySelectorAll('.flat-item');
            flats.forEach(f => {
                f.classList.remove('selected');
                if (f.dataset.flat === flat) {
                    f.classList.add('selected');
                }
            });
            
            // Extract tower and flat number from full flat number
            const tower = flat.charAt(0); // First character is tower
            const flatNum = flat.substring(1); // Rest is flat number
            
            // Update form fields with flat and tower
            const flatField = document.getElementById(getFlatFieldId(process));
            const towerField = document.getElementById(getTowerFieldId(process));
            
            if (flatField) flatField.value = flatNum;
            if (towerField) towerField.value = tower;
            
            // Load existing data for this flat
            loadExistingDataForFlat(process, flat);
        }
        
        // Get flat field ID based on process
        function getFlatFieldId(process) {
            const fieldMap = {
                'key-handover': 'keyHandoverFlat',
                'snagging': 'snaggingFlat',
                'project-mep': 'projectMEPFlat',
                'team4-crm': 'team4CRMFlat',
                'cbre-crm': 'cbreCRMFlat',
                'first-visit': 'firstVisitFlat',
                'handover': 'handoverFlat',
                'interiors': 'interiorsFlat',
                'move-in': 'moveInFlat'
            };
            return fieldMap[process] || 'flat';
        }
        
        // Get tower field ID based on process
        function getTowerFieldId(process) {
            const fieldMap = {
                'key-handover': 'keyHandoverTower',
                'snagging': 'snaggingTower',
                'project-mep': 'projectMEPTower',
                'team4-crm': 'team4CRMTower',
                'cbre-crm': 'cbreCRMTower',
                'first-visit': 'firstVisitTower',
                'handover': 'handoverTower',
                'interiors': 'interiorsTower',
                'move-in': 'moveInTower'
            };
            return fieldMap[process] || 'tower';
        }
        
        // Load existing data for a flat
        function loadExistingDataForFlat(process, flat) {
            if (!backendUrl) return;
            
            const apiProcess = process.replace('-', '_');
            callBackend('get_flat_data', apiProcess, { tower: currentTower, flat: flat })
                .then(data => {
                    if (data && data[apiProcess]) {
                        populateForm(apiProcess, data[apiProcess]);
                        showNotification('Existing data loaded for flat ' + flat.substring(1), 'success');
                    }
                })
                .catch(error => {
                    console.log('No existing data found for flat ' + flat.substring(1));
                });
        }
        
        // Load existing data - ADDED MISSING FUNCTION
        function loadExistingData(process) {
            if (!currentFlat) {
                showNotification('Please select a flat first', 'error');
                return;
            }
            
            loadExistingDataForFlat(currentProcess, currentFlat);
        }
        
        // Populate form with existing data - FIXED TEAM4 CRM population
        function populateForm(process, data) {
            console.log('Populating form for', process, data);
            
            // Update TEAM4 CRM form with new structure
            if (process === 'team4_crm' && data) {
                document.getElementById('team4CRMAction').value = data.action_type || 'handover';
                document.getElementById('team4CRMAssignedTo').value = data.assigned_to || 'cbre';
                document.getElementById('team4CRMDate').value = data.start_date || new Date().toISOString().split('T')[0];
                document.getElementById('registrationCompleted').checked = data.registration_completed === 'true' || data.registration_completed === true;
                document.getElementById('nocGivenToCBRE').checked = data.noc_given_to_cbre === 'true' || data.noc_given_to_cbre === true;
                document.getElementById('team4CRMRemarks').value = data.remarks || '';
            }
            
            // Populate other forms based on process
            switch(process) {
                case 'key_handover':
                    if (data) {
                        document.getElementById('handoverPerson').value = data.handover_person || '';
                        document.getElementById('receivedByCBRE').value = data.received_by_cbre || '';
                        document.getElementById('handoverDate').value = data.handover_date || '';
                        document.getElementById('allKeysNotHanded').checked = data.all_keys_not_handed === 'true' || data.all_keys_not_handed === true;
                        document.getElementById('keyRemarks').value = data.key_remarks || '';
                        toggleKeyRemarks();
                    }
                    break;
                    
                case 'snagging':
                    if (data) {
                        // Populate all snagging fields
                        document.getElementById('mepInspector').value = data.mep_inspector || '';
                        document.getElementById('mepStartDate').value = data.mep_start_date || '';
                        document.getElementById('mepEndDate').value = data.mep_end_date || '';
                        document.getElementById('mepCompleted').checked = data.mep_completed === 'true' || data.mep_completed === true;
                        
                        document.getElementById('civilInspector').value = data.civil_inspector || '';
                        document.getElementById('civilStartDate').value = data.civil_start_date || '';
                        document.getElementById('civilEndDate').value = data.civil_end_date || '';
                        document.getElementById('civilCompleted').checked = data.civil_completed === 'true' || data.civil_completed === true;
                        
                        document.getElementById('electricalInspector').value = data.electrical_inspector || '';
                        document.getElementById('electricalStartDate').value = data.electrical_start_date || '';
                        document.getElementById('electricalEndDate').value = data.electrical_end_date || '';
                        document.getElementById('electricalCompleted').checked = data.electrical_completed === 'true' || data.electrical_completed === true;
                        
                        document.getElementById('waterInspector').value = data.water_inspector || '';
                        document.getElementById('waterStartDate').value = data.water_start_date || '';
                        document.getElementById('waterEndDate').value = data.water_end_date || '';
                        document.getElementById('waterCompleted').checked = data.water_completed === 'true' || data.water_completed === true;
                        
                        document.getElementById('acDrainInspector').value = data.ac_drain_inspector || '';
                        document.getElementById('acDrainStartDate').value = data.ac_drain_start_date || '';
                        document.getElementById('acDrainEndDate').value = data.ac_drain_end_date || '';
                        document.getElementById('acDrainCompleted').checked = data.ac_drain_completed === 'true' || data.ac_drain_completed === true;
                        
                        document.getElementById('tilesInspector').value = data.tiles_inspector || '';
                        document.getElementById('tilesStartDate').value = data.tiles_start_date || '';
                        document.getElementById('tilesEndDate').value = data.tiles_end_date || '';
                        document.getElementById('tilesCompleted').checked = data.tiles_completed === 'true' || data.tiles_completed === true;
                        
                        document.getElementById('snagRemarks').value = data.snag_remarks || '';
                        document.getElementById('followupDate').value = data.followup_date || '';
                        
                        checkAllSnaggingCompleted();
                    }
                    break;
                    
                case 'project_mep':
                    if (data) {
                        document.getElementById('snagsStatus').value = data.snags_status || 'attended';
                        document.getElementById('confirmationDate').value = data.confirmation_date || '';
                        document.getElementById('cbreChecked').value = data.cbre_checked || 'no';
                        document.getElementById('cbreCheckedDate').value = data.cbre_checked_date || '';
                        toggleCBRECheckedDate();
                    }
                    break;
                    
                case 'cbre_crm':
                    if (data) {
                        document.getElementById('cbreCRMDescription').value = data.description || '';
                        document.getElementById('cbreCRMInformedTo').value = data.informed_to || 'mep';
                        document.getElementById('cbreCRMStatus').value = data.status || 'open';
                        document.getElementById('cbreCRMCallerName').value = data.caller_name || '';
                        document.getElementById('cbreCRMCallerPhone').value = data.caller_phone || '';
                        document.getElementById('cbreCRMFollowupDate').value = data.followup_date || '';
                        document.getElementById('cbreCRMRemarks').value = data.remarks || '';
                        toggleCbreCRMFollowupDate();
                    }
                    break;
                    
                case 'first_visit':
                    if (data) {
                        document.getElementById('ownerName').value = data.owner_name || '';
                        document.getElementById('ownerPhone').value = data.owner_phone || '';
                        document.getElementById('visitDateTime').value = data.visit_datetime || '';
                        document.getElementById('hotMember').value = data.hot_member || '';
                        document.getElementById('ownerWillInformDate').checked = data.owner_will_inform_date === 'true' || data.owner_will_inform_date === true;
                        document.getElementById('handoverSuggested').value = data.handover_suggested || '';
                        document.getElementById('goingForThirdParty').checked = data.going_for_third_party === 'true' || data.going_for_third_party === true;
                        document.getElementById('customerRemarks').value = data.customer_remarks || '';
                        document.getElementById('crmNoc').value = data.crm_noc || 'pending';
                        
                        toggleHandoverDate();
                        toggleThirdPartyForm();
                        
                        // Third party inspection data
                        if (data.going_for_third_party === 'true' || data.going_for_third_party === true) {
                            document.getElementById('thirdPartyDateConfirmed').value = data.third_party_date_confirmed || '';
                            document.getElementById('reportReceivedDate').value = data.report_received_date || '';
                            document.getElementById('softCopy').checked = data.soft_copy === 'true' || data.soft_copy === true;
                            document.getElementById('hardCopy').checked = data.hard_copy === 'true' || data.hard_copy === true;
                            document.getElementById('informedToProjectTeam').value = data.informed_to_project_team || 'no';
                            document.getElementById('projectTeamInformedDate').value = data.project_team_informed_date || '';
                            document.getElementById('cbreCheckingDone').value = data.cbre_checking_done || 'no';
                            document.getElementById('cbreCheckingDate').value = data.cbre_checking_date || '';
                            
                            toggleThirdPartySubForm();
                            toggleProjectTeamDate();
                            toggleCBRECheckingDate();
                        }
                    }
                    break;
                    
                case 'handover':
                    if (data) {
                        document.getElementById('customerName').value = data.customer_name || '';
                        document.getElementById('customerEmail').value = data.customer_email || '';
                        document.getElementById('secondOwnerName').value = data.second_owner_name || '';
                        document.getElementById('secondOwnerEmail').value = data.second_owner_email || '';
                        document.getElementById('hotoMember').value = data.hoto_member || '';
                        document.getElementById('handoverDateTime').value = data.handover_datetime || '';
                        
                        // Items handed over
                        const itemsHanded = data.items_handed ? data.items_handed.split(',') : [];
                        document.getElementById('itemKeys').checked = itemsHanded.includes('keys');
                        document.getElementById('itemManual').checked = itemsHanded.includes('manual');
                        document.getElementById('itemGift').checked = itemsHanded.includes('gift');
                        
                        document.getElementById('customerFeedback').value = data.customer_feedback || '';
                        document.getElementById('finalInspection').value = data.final_inspection || 'yes';
                        document.getElementById('inspectionRemarks').value = data.inspection_remarks || '';
                        
                        toggleInspectionRemarks();
                    }
                    break;
                    
                case 'interiors':
                    if (data) {
                        document.getElementById('siteSupervisor').value = data.site_supervisor || '';
                        document.getElementById('siteSupervisorNumber').value = data.site_supervisor_number || '';
                        document.getElementById('contractorName').value = data.contractor_name || '';
                        document.getElementById('contractorContact').value = data.contractor_contact || '';
                        document.getElementById('workStartDate').value = data.work_start_date || '';
                        document.getElementById('estimatedEndDate').value = data.estimated_end_date || '';
                        
                        // Works planned
                        const worksPlanned = data.works_planned ? data.works_planned.split(',') : [];
                        document.getElementById('workFlooring').checked = worksPlanned.includes('flooring');
                        document.getElementById('workPainting').checked = worksPlanned.includes('painting');
                        document.getElementById('workElectrical').checked = worksPlanned.includes('electrical');
                        document.getElementById('workPlumbing').checked = worksPlanned.includes('plumbing');
                        document.getElementById('workCarpentry').checked = worksPlanned.includes('carpentry');
                        document.getElementById('workFalseCeiling').checked = worksPlanned.includes('false_ceiling');
                        document.getElementById('workKitchen').checked = worksPlanned.includes('kitchen');
                        document.getElementById('workWardrobe').checked = worksPlanned.includes('wardrobe');
                        
                        document.getElementById('dosDontsExplained').checked = data.dos_donts_explained === 'true' || data.dos_donts_explained === true;
                        document.getElementById('multipleVendors').checked = data.multiple_vendors === 'true' || data.multiple_vendors === true;
                        document.getElementById('interiorsRemarks').value = data.remarks || '';
                        
                        toggleMultipleVendors();
                    }
                    break;
                    
                case 'movein':
                    if (data) {
                        document.getElementById('moveinCustomerName').value = data.customer_name || '';
                        document.getElementById('moveinContact').value = data.contact_number || '';
                        document.getElementById('moveinDate').value = data.movein_date || '';
                        document.getElementById('moveinTime').value = data.movein_time || 'morning';
                        document.getElementById('moveClearanceGiven').checked = data.move_clearance_given === 'true' || data.move_clearance_given === true;
                        document.getElementById('moveinRemarks').value = data.remarks || '';
                        
                        toggleMoveinSave();
                    }
                    break;
            }
        }
        
        // ================== BACKEND COMMUNICATION ==================
        
        // Call backend API
        async function callBackend(action, process = null, data = {}) {
            if (!backendUrl) {
                showNotification('Backend URL not configured. Please set it in the Integration tab.', 'error');
                return null;
            }
            
            const url = new URL(backendUrl);
            url.searchParams.append('action', action);
            if (process) {
                url.searchParams.append('process', process);
            }
            
            try {
                const response = await fetch(url.toString(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.error) {
                    showNotification('Error: ' + result.error, 'error');
                    return null;
                }
                
                return result;
            } catch (error) {
                showNotification('Connection error: ' + error.message, 'error');
                return null;
            }
        }
        
        // Test backend connection
        async function testBackendConnection() {
            const result = await callBackend('ping');
            if (result && result.status === 'online') {
                document.getElementById('connectionIndicator').style.color = '#28a745';
                showNotification('Connected to backend successfully', 'success');
                return true;
            } else {
                document.getElementById('connectionIndicator').style.color = '#dc3545';
                return false;
            }
        }
        
        // ================== DASHBOARD FUNCTIONS ==================
        
        // Load dashboard data
        async function loadDashboardData() {
            const result = await callBackend('get_dashboard_counts');
            if (result) {
                updateDashboardKPIs(result);
            }
        }
        
        // Update dashboard KPIs with real data
        function updateDashboardKPIs(data) {
            // Calculate total flats based on new configuration
            const totalFlats = BUILDING_CONFIG.towers.length * BUILDING_CONFIG.floors * BUILDING_CONFIG.flatsPerFloor;
            
            const processes = {
                'key_handover': { element: 'totalKeyHandovers', percent: 'keyHandoverPercent', progress: 'keyHandoverProgress' },
                'snagging': { element: 'totalSnagging', percent: 'snaggingPercent', progress: 'snaggingProgress' },
                'project_mep': { element: 'totalProjectMEP', percent: 'projectMEPPercent', progress: 'projectMEPProgress' },
                'team4_crm': { element: 'totalTeam4CRM', percent: 'team4CRMPercent', progress: 'team4CRMProgress' },
                'cbre_crm': { element: 'totalCbreCRM', percent: 'cbreCRMPercent', progress: 'cbreCRMProgress' },
                'first_visit': { element: 'totalFirstVisits', percent: 'firstVisitPercent', progress: 'firstVisitProgress' },
                'handover': { element: 'totalHandovers', percent: 'handoverPercent', progress: 'handoverProgress' },
                'interiors': { element: 'totalInteriors', percent: 'interiorPercent', progress: 'interiorProgress' },
                'movein': { element: 'totalMoveins', percent: 'moveinPercent', progress: 'moveinProgress' }
            };
            
            // Calculate counts based on workflow
            const calculatedCounts = calculateWorkflowCounts();
            
            Object.entries(processes).forEach(([process, ids]) => {
                // Use calculated counts from workflow
                const count = calculatedCounts[process] || 0;
                const percent = Math.round((count / totalFlats) * 100);
                
                if (document.getElementById(ids.element)) {
                    document.getElementById(ids.element).textContent = count;
                }
                if (document.getElementById(ids.percent)) {
                    document.getElementById(ids.percent).textContent = percent + '%';
                }
                if (document.getElementById(ids.progress)) {
                    document.getElementById(ids.progress).style.width = percent + '%';
                }
            });
            
            document.getElementById('currentDate').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
            
            // Update upcoming events
            updateUpcomingEventsWithRealData();
        }
        
        // Calculate counts based on workflow
        function calculateWorkflowCounts() {
            const counts = {
                'key_handover': 0,
                'snagging': 0,
                'project_mep': 0,
                'team4_crm': 0,
                'cbre_crm': 0,
                'first_visit': 0,
                'handover': 0,
                'interiors': 0,
                'movein': 0
            };
            
            // Calculate based on actual data in allProcessData
            Object.keys(counts).forEach(process => {
                if (allProcessData[process]) {
                    counts[process] = allProcessData[process].length;
                }
            });
            
            return counts;
        }
        
        // Filter chart data
        function filterChartData(filterType) {
            currentChartFilter = filterType;
            
            // Update active button
            document.querySelectorAll('.chart-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tower progress chart with filtered data
            updateTowerProgressChart();
        }
        
        // Update tower progress chart with filtered data
        function updateTowerProgressChart() {
            const towerChartContainer = document.getElementById('tower-progress-chart');
            if (!towerChartContainer) return;
            
            towerChartContainer.innerHTML = '';
            
            // Calculate progress for each tower based on current filter
            BUILDING_CONFIG.towers.forEach(tower => {
                const progressData = calculateTowerProgress(tower, currentChartFilter);
                
                const card = document.createElement('div');
                card.className = 'tower-chart-card';
                card.style.borderLeftColor = getColorForTower(tower);
                
                let chartContent = `
                    <div class="tower-chart-header">
                        <div class="tower-name">Tower ${tower}</div>
                        <div class="tower-progress">${progressData.overallPercent}%</div>
                    </div>
                `;
                
                // Add process items based on filter
                if (currentChartFilter === 'all' || currentChartFilter === 'key') {
                    chartContent += `
                        <div class="process-chart-item">
                            <div class="process-name">
                                <span>Key Handover</span>
                                <span class="process-percent">${progressData.keyHandoverPercent}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressData.keyHandoverPercent}%; background-color: #80BBAD;"></div>
                            </div>
                        </div>
                    `;
                }
                
                if (currentChartFilter === 'all' || currentChartFilter === 'snag') {
                    chartContent += `
                        <div class="process-chart-item">
                            <div class="process-name">
                                <span>CBRE Snagging</span>
                                <span class="process-percent">${progressData.snaggingPercent}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressData.snaggingPercent}%; background-color: #17E88F;"></div>
                            </div>
                        </div>
                    `;
                }
                
                if (currentChartFilter === 'all' || currentChartFilter === 'project') {
                    chartContent += `
                        <div class="process-chart-item">
                            <div class="process-name">
                                <span>Project/MEP</span>
                                <span class="process-percent">${progressData.projectMEPPercent}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressData.projectMEPPercent}%; background-color: #6f42c1;"></div>
                            </div>
                        </div>
                    `;
                }
                
                if (currentChartFilter === 'all' || currentChartFilter === 'team4-crm') {
                    chartContent += `
                        <div class="process-chart-item">
                            <div class="process-name">
                                <span>TEAM4 CRM</span>
                                <span class="process-percent">${progressData.team4CRMPercent}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressData.team4CRMPercent}%; background-color: #6610f2;"></div>
                            </div>
                        </div>
                    `;
                }
                
                if (currentChartFilter === 'all' || currentChartFilter === 'cbre-crm') {
                    chartContent += `
                        <div class="process-chart-item">
                            <div class="process-name">
                                <span>CBRE CRM</span>
                                <span class="process-percent">${progressData.cbreCRMPercent}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressData.cbreCRMPercent}%; background-color: #20c997;"></div>
                            </div>
                        </div>
                    `;
                }
                
                if (currentChartFilter === 'all' || currentChartFilter === 'visit') {
                    chartContent += `
                        <div class="process-chart-item">
                            <div class="process-name">
                                <span>First Visit</span>
                                <span class="process-percent">${progressData.firstVisitPercent}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressData.firstVisitPercent}%; background-color: #DBD99A;"></div>
                            </div>
                        </div>
                    `;
                }
                
                if (currentChartFilter === 'all' || currentChartFilter === 'hoto') {
                    chartContent += `
                        <div class="process-chart-item">
                            <div class="process-name">
                                <span>Handover</span>
                                <span class="process-percent">${progressData.handoverPercent}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressData.handoverPercent}%; background-color: #3E7CA6;"></div>
                            </div>
                        </div>
                    `;
                }
                
                if (currentChartFilter === 'all' || currentChartFilter === 'interior') {
                    chartContent += `
                        <div class="process-chart-item">
                            <div class="process-name">
                                <span>Interiors</span>
                                <span class="process-percent">${progressData.interiorPercent}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressData.interiorPercent}%; background-color: #885073;"></div>
                            </div>
                        </div>
                    `;
                }
                
                if (currentChartFilter === 'all' || currentChartFilter === 'movein') {
                    chartContent += `
                        <div class="process-chart-item">
                            <div class="process-name">
                                <span>Move-in</span>
                                <span class="process-percent">${progressData.moveinPercent}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressData.moveinPercent}%; background-color: #1F3765;"></div>
                            </div>
                        </div>
                    `;
                }
                
                card.innerHTML = chartContent;
                towerChartContainer.appendChild(card);
            });
        }
        
        // Calculate tower progress with filter
        function calculateTowerProgress(tower, filter = 'all') {
            const totalFlatsPerTower = BUILDING_CONFIG.floors * BUILDING_CONFIG.flatsPerFloor;
            
            // Initialize all progress percentages
            const progressData = {
                keyHandoverPercent: 0,
                snaggingPercent: 0,
                projectMEPPercent: 0,
                team4CRMPercent: 0,
                cbreCRMPercent: 0,
                firstVisitPercent: 0,
                handoverPercent: 0,
                interiorPercent: 0,
                moveinPercent: 0,
                overallPercent: 0
            };
            
            // Calculate counts for this tower
            const processCounts = {};
            
            // Define all processes
            const allProcesses = [
                'key_handover', 'snagging', 'project_mep', 'team4_crm', 'cbre_crm',
                'first_visit', 'handover', 'interiors', 'movein'
            ];
            
            // Count flats in each process for this tower
            allProcesses.forEach(process => {
                if (allProcessData[process]) {
                    processCounts[process] = allProcessData[process].filter(item => 
                        item.tower === tower
                    ).length;
                } else {
                    processCounts[process] = 0;
                }
            });
            
            // Calculate percentages for all processes
            progressData.keyHandoverPercent = Math.round((processCounts.key_handover / totalFlatsPerTower) * 100);
            progressData.snaggingPercent = Math.round((processCounts.snagging / totalFlatsPerTower) * 100);
            progressData.projectMEPPercent = Math.round((processCounts.project_mep / totalFlatsPerTower) * 100);
            progressData.team4CRMPercent = Math.round((processCounts.team4_crm / totalFlatsPerTower) * 100);
            progressData.cbreCRMPercent = Math.round((processCounts.cbre_crm / totalFlatsPerTower) * 100);
            progressData.firstVisitPercent = Math.round((processCounts.first_visit / totalFlatsPerTower) * 100);
            progressData.handoverPercent = Math.round((processCounts.handover / totalFlatsPerTower) * 100);
            progressData.interiorPercent = Math.round((processCounts.interiors / totalFlatsPerTower) * 100);
            progressData.moveinPercent = Math.round((processCounts.movein / totalFlatsPerTower) * 100);
            
            // Calculate overall percentage based on filter
            let relevantProcesses = [];
            
            switch(filter) {
                case 'all':
                    relevantProcesses = allProcesses;
                    break;
                case 'key':
                    relevantProcesses = ['key_handover'];
                    break;
                case 'snag':
                    relevantProcesses = ['snagging'];
                    break;
                case 'project':
                    relevantProcesses = ['project_mep'];
                    break;
                case 'team4-crm':
                    relevantProcesses = ['team4_crm'];
                    break;
                case 'cbre-crm':
                    relevantProcesses = ['cbre_crm'];
                    break;
                case 'visit':
                    relevantProcesses = ['first_visit'];
                    break;
                case 'hoto':
                    relevantProcesses = ['handover'];
                    break;
                case 'interior':
                    relevantProcesses = ['interiors'];
                    break;
                case 'movein':
                    relevantProcesses = ['movein'];
                    break;
                default:
                    relevantProcesses = allProcesses;
            }
            
            const totalRelevantCount = relevantProcesses.reduce((sum, process) => 
                sum + processCounts[process], 0);
            const maxPossibleCount = relevantProcesses.length * totalFlatsPerTower;
            
            progressData.overallPercent = maxPossibleCount > 0 ? 
                Math.round((totalRelevantCount / maxPossibleCount) * 100) : 0;
            
            return progressData;
        }
        
        // Get color for tower
        function getColorForTower(tower) {
            const colors = {
                'A': '#1F3765',
                'B': '#2A4A8A',
                'C': '#3E7CA6'
            };
            return colors[tower] || '#1F3765';
        }
        
        // ================== FORM FUNCTIONS ==================
        
        // Save key handover
        async function saveKeyHandover() {
            const data = {
                tower: currentTower,
                flat: currentFlat.substring(1), // Remove tower prefix
                handover_person: document.getElementById('handoverPerson').value,
                received_by_cbre: document.getElementById('receivedByCBRE').value,
                handover_date: document.getElementById('handoverDate').value,
                all_keys_not_handed: document.getElementById('allKeysNotHanded').checked ? 'true' : 'false',
                key_remarks: document.getElementById('keyRemarks').value
            };
            
            const result = await callBackend('save_data', 'key_handover', data);
            if (result && result.success) {
                showNotification('Key handover saved successfully', 'success');
                resetKeyForm();
                loadDashboardData();
                loadAllProcessData(); // Reload process data
            }
        }
        
        // Save snagging
        async function saveSnagging() {
            const data = {
                tower: currentTower,
                flat: currentFlat.substring(1), // Remove tower prefix
                mep_inspector: document.getElementById('mepInspector').value,
                mep_start_date: document.getElementById('mepStartDate').value,
                mep_end_date: document.getElementById('mepEndDate').value,
                mep_completed: document.getElementById('mepCompleted').checked ? 'true' : 'false',
                civil_inspector: document.getElementById('civilInspector').value,
                civil_start_date: document.getElementById('civilStartDate').value,
                civil_end_date: document.getElementById('civilEndDate').value,
                civil_completed: document.getElementById('civilCompleted').checked ? 'true' : 'false',
                electrical_inspector: document.getElementById('electricalInspector').value,
                electrical_start_date: document.getElementById('electricalStartDate').value,
                electrical_end_date: document.getElementById('electricalEndDate').value,
                electrical_completed: document.getElementById('electricalCompleted').checked ? 'true' : 'false',
                water_inspector: document.getElementById('waterInspector').value,
                water_start_date: document.getElementById('waterStartDate').value,
                water_end_date: document.getElementById('waterEndDate').value,
                water_completed: document.getElementById('waterCompleted').checked ? 'true' : 'false',
                ac_drain_inspector: document.getElementById('acDrainInspector').value,
                ac_drain_start_date: document.getElementById('acDrainStartDate').value,
                ac_drain_end_date: document.getElementById('acDrainEndDate').value,
                ac_drain_completed: document.getElementById('acDrainCompleted').checked ? 'true' : 'false',
                tiles_inspector: document.getElementById('tilesInspector').value,
                tiles_start_date: document.getElementById('tilesStartDate').value,
                tiles_end_date: document.getElementById('tilesEndDate').value,
                tiles_completed: document.getElementById('tilesCompleted').checked ? 'true' : 'false',
                snag_remarks: document.getElementById('snagRemarks').value,
                followup_date: document.getElementById('followupDate').value
            };
            
            const result = await callBackend('save_data', 'snagging', data);
            if (result && result.success) {
                showNotification('Snagging data saved successfully', 'success');
                checkAllSnaggingCompleted();
                loadDashboardData();
                loadAllProcessData(); // Reload process data
            }
        }
        
        // Save project MEP
        async function saveProjectMEP() {
            const data = {
                tower: currentTower,
                flat: currentFlat.substring(1), // Remove tower prefix
                snags_status: document.getElementById('snagsStatus').value,
                confirmation_date: document.getElementById('confirmationDate').value,
                cbre_checked: document.getElementById('cbreChecked').value,
                cbre_checked_date: document.getElementById('cbreCheckedDate').value
            };
            
            const result = await callBackend('save_data', 'project_mep', data);
            if (result && result.success) {
                showNotification('Project/MEP data saved successfully', 'success');
                resetProjectMEPForm();
                loadDashboardData();
                loadAllProcessData(); // Reload process data
            }
        }
        
        // Save TEAM4 CRM - UPDATED with new structure
        async function saveTeam4CRM() {
            const data = {
                tower: currentTower,
                flat: currentFlat.substring(1), // Remove tower prefix
                action_type: document.getElementById('team4CRMAction').value,
                assigned_to: document.getElementById('team4CRMAssignedTo').value,
                start_date: document.getElementById('team4CRMDate').value,
                registration_completed: document.getElementById('registrationCompleted').checked ? 'true' : 'false',
                noc_given_to_cbre: document.getElementById('nocGivenToCBRE').checked ? 'true' : 'false',
                remarks: document.getElementById('team4CRMRemarks').value
            };
            
            const result = await callBackend('save_data', 'team4_crm', data);
            if (result && result.success) {
                showNotification('TEAM4 CRM data saved successfully', 'success');
                resetTeam4CRMForm();
                loadDashboardData();
                loadAllProcessData(); // Reload process data
            }
        }
        
        // Save CBRE CRM - Caller name and phone are NOT required
        async function saveCbreCRM() {
            const data = {
                tower: currentTower,
                flat: currentFlat.substring(1), // Remove tower prefix
                description: document.getElementById('cbreCRMDescription').value,
                informed_to: document.getElementById('cbreCRMInformedTo').value,
                status: document.getElementById('cbreCRMStatus').value,
                caller_name: document.getElementById('cbreCRMCallerName').value || '', // Optional
                caller_phone: document.getElementById('cbreCRMCallerPhone').value || '', // Optional
                followup_date: document.getElementById('cbreCRMFollowupDate').value,
                remarks: document.getElementById('cbreCRMRemarks').value
            };
            
            const result = await callBackend('save_data', 'cbre_crm', data);
            if (result && result.success) {
                showNotification('CBRE CRM call data saved successfully', 'success');
                resetCbreCRMForm();
                loadDashboardData();
                loadAllProcessData(); // Reload process data
            }
        }
        
        // Save First Visit - ADDED MISSING FUNCTION
        async function saveFirstVisit() {
            const data = {
                tower: currentTower,
                flat: currentFlat.substring(1), // Remove tower prefix
                owner_name: document.getElementById('ownerName').value,
                owner_phone: document.getElementById('ownerPhone').value,
                visit_datetime: document.getElementById('visitDateTime').value,
                hot_member: document.getElementById('hotMember').value,
                owner_will_inform_date: document.getElementById('ownerWillInformDate').checked ? 'true' : 'false',
                handover_suggested: document.getElementById('handoverSuggested').value,
                going_for_third_party: document.getElementById('goingForThirdParty').checked ? 'true' : 'false',
                third_party_date_confirmed: document.getElementById('thirdPartyDateConfirmed').value,
                report_received_date: document.getElementById('reportReceivedDate').value,
                soft_copy: document.getElementById('softCopy').checked ? 'true' : 'false',
                hard_copy: document.getElementById('hardCopy').checked ? 'true' : 'false',
                informed_to_project_team: document.getElementById('informedToProjectTeam').value,
                project_team_informed_date: document.getElementById('projectTeamInformedDate').value,
                cbre_checking_done: document.getElementById('cbreCheckingDone').value,
                cbre_checking_date: document.getElementById('cbreCheckingDate').value,
                customer_remarks: document.getElementById('customerRemarks').value,
                crm_noc: document.getElementById('crmNoc').value
            };
            
            const result = await callBackend('save_data', 'first_visit', data);
            if (result && result.success) {
                showNotification('First visit data saved successfully', 'success');
                resetVisitForm();
                loadDashboardData();
                loadAllProcessData(); // Reload process data
            }
        }
        
        // Save Handover - ADDED MISSING FUNCTION
        async function saveHandover() {
            const itemsHanded = [];
            if (document.getElementById('itemKeys').checked) itemsHanded.push('keys');
            if (document.getElementById('itemManual').checked) itemsHanded.push('manual');
            if (document.getElementById('itemGift').checked) itemsHanded.push('gift');
            
            const data = {
                tower: currentTower,
                flat: currentFlat.substring(1), // Remove tower prefix
                customer_name: document.getElementById('customerName').value,
                customer_email: document.getElementById('customerEmail').value,
                second_owner_name: document.getElementById('secondOwnerName').value,
                second_owner_email: document.getElementById('secondOwnerEmail').value,
                hoto_member: document.getElementById('hotoMember').value,
                handover_datetime: document.getElementById('handoverDateTime').value,
                items_handed: itemsHanded.join(','),
                customer_feedback: document.getElementById('customerFeedback').value,
                final_inspection: document.getElementById('finalInspection').value,
                inspection_remarks: document.getElementById('inspectionRemarks').value
            };
            
            const result = await callBackend('save_data', 'handover', data);
            if (result && result.success) {
                showNotification('Handover data saved successfully', 'success');
                resetHandoverForm();
                loadDashboardData();
                loadAllProcessData(); // Reload process data
            }
        }
        
        // Save Interiors - ADDED MISSING FUNCTION
        async function saveInteriors() {
            const worksPlanned = [];
            if (document.getElementById('workFlooring').checked) worksPlanned.push('flooring');
            if (document.getElementById('workPainting').checked) worksPlanned.push('painting');
            if (document.getElementById('workElectrical').checked) worksPlanned.push('electrical');
            if (document.getElementById('workPlumbing').checked) worksPlanned.push('plumbing');
            if (document.getElementById('workCarpentry').checked) worksPlanned.push('carpentry');
            if (document.getElementById('workFalseCeiling').checked) worksPlanned.push('false_ceiling');
            if (document.getElementById('workKitchen').checked) worksPlanned.push('kitchen');
            if (document.getElementById('workWardrobe').checked) worksPlanned.push('wardrobe');
            
            const data = {
                tower: currentTower,
                flat: currentFlat.substring(1), // Remove tower prefix
                site_supervisor: document.getElementById('siteSupervisor').value,
                site_supervisor_number: document.getElementById('siteSupervisorNumber').value,
                contractor_name: document.getElementById('contractorName').value,
                contractor_contact: document.getElementById('contractorContact').value,
                work_start_date: document.getElementById('workStartDate').value,
                estimated_end_date: document.getElementById('estimatedEndDate').value,
                works_planned: worksPlanned.join(','),
                dos_donts_explained: document.getElementById('dosDontsExplained').checked ? 'true' : 'false',
                multiple_vendors: document.getElementById('multipleVendors').checked ? 'true' : 'false',
                remarks: document.getElementById('interiorsRemarks').value
            };
            
            const result = await callBackend('save_data', 'interiors', data);
            if (result && result.success) {
                showNotification('Interiors data saved successfully', 'success');
                resetInteriorsForm();
                loadDashboardData();
                loadAllProcessData(); // Reload process data
            }
        }
        
        // Save Move-in - ADDED MISSING FUNCTION
        async function saveMoveIn() {
            const data = {
                tower: currentTower,
                flat: currentFlat.substring(1), // Remove tower prefix
                customer_name: document.getElementById('moveinCustomerName').value,
                contact_number: document.getElementById('moveinContact').value,
                movein_date: document.getElementById('moveinDate').value,
                movein_time: document.getElementById('moveinTime').value,
                move_clearance_given: document.getElementById('moveClearanceGiven').checked ? 'true' : 'false',
                remarks: document.getElementById('moveinRemarks').value
            };
            
            const result = await callBackend('save_data', 'movein', data);
            if (result && result.success) {
                showNotification('Move-in data saved successfully', 'success');
                resetMoveInForm();
                loadDashboardData();
                loadAllProcessData(); // Reload process data
            }
        }
        
        // ================== UTILITY FUNCTIONS ==================
        
        // Show notification
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Refresh data
        function refreshData() {
            if (selectedTab === 'dashboard') {
                loadDashboardData();
            } else if (selectedTab === 'analytics') {
                loadAnalyticsData();
            }
            showNotification('Data refreshed', 'success');
        }
        
        // ================== RESET FORM FUNCTIONS ==================
        
        function resetKeyForm() {
            document.getElementById('handoverPerson').value = '';
            document.getElementById('receivedByCBRE').value = '';
            document.getElementById('handoverDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('allKeysNotHanded').checked = false;
            document.getElementById('keyRemarks').value = '';
            toggleKeyRemarks();
        }
        
        function resetSnagForm() {
            // Reset all snagging form fields
            const fields = [
                'mepInspector', 'mepStartDate', 'mepEndDate', 'mepCompleted',
                'civilInspector', 'civilStartDate', 'civilEndDate', 'civilCompleted',
                'electricalInspector', 'electricalStartDate', 'electricalEndDate', 'electricalCompleted',
                'waterInspector', 'waterStartDate', 'waterEndDate', 'waterCompleted',
                'acDrainInspector', 'acDrainStartDate', 'acDrainEndDate', 'acDrainCompleted',
                'tilesInspector', 'tilesStartDate', 'tilesEndDate', 'tilesCompleted',
                'snagRemarks', 'followupDate'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (field.type === 'checkbox') {
                        field.checked = false;
                    } else if (field.type === 'date') {
                        field.value = new Date().toISOString().split('T')[0];
                    } else {
                        field.value = '';
                    }
                }
            });
        }
        
        function resetProjectMEPForm() {
            document.getElementById('snagsStatus').value = 'attended';
            document.getElementById('confirmationDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('cbreChecked').value = 'no';
            document.getElementById('cbreCheckedDate').value = '';
            toggleCBRECheckedDate();
        }
        
        function resetTeam4CRMForm() {
            document.getElementById('team4CRMAction').value = 'handover';
            document.getElementById('team4CRMAssignedTo').value = 'cbre';
            document.getElementById('team4CRMDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('registrationCompleted').checked = false;
            document.getElementById('nocGivenToCBRE').checked = false;
            document.getElementById('team4CRMRemarks').value = '';
        }
        
        function resetCbreCRMForm() {
            document.getElementById('cbreCRMDescription').value = '';
            document.getElementById('cbreCRMInformedTo').value = 'mep';
            document.getElementById('cbreCRMStatus').value = 'open';
            document.getElementById('cbreCRMCallerName').value = '';
            document.getElementById('cbreCRMCallerPhone').value = '';
            document.getElementById('cbreCRMFollowupDate').value = '';
            document.getElementById('cbreCRMRemarks').value = '';
            toggleCbreCRMFollowupDate();
        }
        
        function resetVisitForm() {
            document.getElementById('ownerName').value = '';
            document.getElementById('ownerPhone').value = '';
            document.getElementById('visitDateTime').value = new Date().toISOString().slice(0, 16);
            document.getElementById('hotMember').value = '';
            document.getElementById('ownerWillInformDate').checked = false;
            document.getElementById('handoverSuggested').value = '';
            document.getElementById('goingForThirdParty').checked = false;
            document.getElementById('customerRemarks').value = '';
            document.getElementById('crmNoc').value = 'pending';
            
            toggleHandoverDate();
            toggleThirdPartyForm();
        }
        
        function resetHandoverForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('secondOwnerName').value = '';
            document.getElementById('secondOwnerEmail').value = '';
            document.getElementById('hotoMember').value = '';
            document.getElementById('handoverDateTime').value = new Date().toISOString().slice(0, 16);
            document.getElementById('itemKeys').checked = false;
            document.getElementById('itemManual').checked = false;
            document.getElementById('itemGift').checked = false;
            document.getElementById('customerFeedback').value = '';
            document.getElementById('finalInspection').value = 'yes';
            document.getElementById('inspectionRemarks').value = '';
            
            toggleInspectionRemarks();
        }
        
        function resetInteriorsForm() {
            document.getElementById('siteSupervisor').value = '';
            document.getElementById('siteSupervisorNumber').value = '';
            document.getElementById('contractorName').value = '';
            document.getElementById('contractorContact').value = '';
            document.getElementById('workStartDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('estimatedEndDate').value = '';
            document.getElementById('workFlooring').checked = false;
            document.getElementById('workPainting').checked = false;
            document.getElementById('workElectrical').checked = false;
            document.getElementById('workPlumbing').checked = false;
            document.getElementById('workCarpentry').checked = false;
            document.getElementById('workFalseCeiling').checked = false;
            document.getElementById('workKitchen').checked = false;
            document.getElementById('workWardrobe').checked = false;
            document.getElementById('dosDontsExplained').checked = false;
            document.getElementById('multipleVendors').checked = false;
            document.getElementById('interiorsRemarks').value = '';
            
            toggleMultipleVendors();
        }
        
        function resetMoveInForm() {
            document.getElementById('moveinCustomerName').value = '';
            document.getElementById('moveinContact').value = '';
            document.getElementById('moveinDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('moveinTime').value = 'morning';
            document.getElementById('moveClearanceGiven').checked = false;
            document.getElementById('moveinRemarks').value = '';
            
            toggleMoveinSave();
        }
        
        // ================== TOGGLE FUNCTIONS ==================
        
        function toggleKeyRemarks() {
            const showRemarks = document.getElementById('allKeysNotHanded').checked;
            document.getElementById('keyRemarksContainer').style.display = showRemarks ? 'block' : 'none';
            if (showRemarks) {
                document.getElementById('keyRemarks').required = true;
            }
        }
        
        function toggleCBRECheckedDate() {
            const showDate = document.getElementById('cbreChecked').value === 'yes';
            document.getElementById('cbreCheckedDateContainer').style.display = showDate ? 'block' : 'none';
        }
        
        function toggleTeam4CRMFollowupDate() {
            const showDate = document.getElementById('team4CRMStatus').value === 'open' || 
                            document.getElementById('team4CRMStatus').value === 'in_progress';
            document.getElementById('team4CRMFollowupDateContainer').style.display = showDate ? 'block' : 'none';
        }
        
        function toggleCbreCRMFollowupDate() {
            const showDate = document.getElementById('cbreCRMStatus').value === 'open';
            document.getElementById('cbreCRMFollowupDateContainer').style.display = showDate ? 'block' : 'none';
        }
        
        function toggleHandoverDate() {
            const showDate = !document.getElementById('ownerWillInformDate').checked;
            document.getElementById('handoverSuggestedContainer').style.display = showDate ? 'block' : 'none';
        }
        
        function toggleThirdPartyForm() {
            const showForm = document.getElementById('goingForThirdParty').checked;
            document.getElementById('thirdPartyForm').style.display = showForm ? 'block' : 'none';
        }
        
        function toggleThirdPartySubForm() {
            const showSubForm = !document.getElementById('dateNotConfirmed').checked;
            document.getElementById('thirdPartySubForm').style.display = showSubForm ? 'block' : 'none';
        }
        
        function toggleProjectTeamDate() {
            const showDate = document.getElementById('informedToProjectTeam').value === 'yes';
            document.getElementById('projectTeamDateContainer').style.display = showDate ? 'block' : 'none';
        }
        
        function toggleCBRECheckingDate() {
            const showDate = document.getElementById('cbreCheckingDone').value === 'yes';
            document.getElementById('cbreCheckingDateContainer').style.display = showDate ? 'block' : 'none';
        }
        
        function toggleInspectionRemarks() {
            const showRemarks = document.getElementById('finalInspection').value !== 'yes';
            document.getElementById('inspectionRemarksContainer').style.display = showRemarks ? 'block' : 'none';
        }
        
        function toggleMultipleVendors() {
            const multipleVendors = document.getElementById('multipleVendors').checked;
            document.getElementById('mainVendorForm').style.display = multipleVendors ? 'none' : 'block';
            document.getElementById('additionalVendorsContainer').style.display = multipleVendors ? 'block' : 'none';
            document.getElementById('addVendorBtn').style.display = multipleVendors ? 'inline-flex' : 'none';
        }
        
        function toggleMoveinSave() {
            const moveClearanceGiven = document.getElementById('moveClearanceGiven').checked;
            document.getElementById('saveMoveinBtn').disabled = !moveClearanceGiven;
        }
        
        function checkAllSnaggingCompleted() {
            const checkboxes = [
                'mepCompleted', 'civilCompleted', 'electricalCompleted',
                'waterCompleted', 'acDrainCompleted', 'tilesCompleted'
            ];
            
            const allCompleted = checkboxes.every(id => document.getElementById(id).checked);
            
            if (allCompleted) {
                document.getElementById('saveSnaggingBtn').style.display = 'none';
                document.getElementById('moveToProjectMEPBtn').style.display = 'inline-flex';
                showNotification('All snagging completed! You can now move to Project/MEP.', 'success');
            } else {
                document.getElementById('saveSnaggingBtn').style.display = 'inline-flex';
                document.getElementById('moveToProjectMEPBtn').style.display = 'none';
            }
        }
        
        function moveToProjectMEP() {
            saveSnagging();
            setTimeout(() => {
                openTab('project-mep');
                // Auto-select the same flat in project-mep tab
                selectTower('project-mep', currentTower);
                setTimeout(() => {
                    selectFloor('project-mep', currentFloor);
                    setTimeout(() => {
                        const flatElement = document.querySelector(`#project-mep-flat-grid .flat-item[data-flat="${currentFlat}"]`);
                        if (flatElement) {
                            flatElement.click();
                        }
                    }, 500);
                }, 500);
            }, 1000);
        }
        
        function moveToTeam4CRM() {
            saveProjectMEP();
            setTimeout(() => {
                openTab('team4-crm');
                selectTower('team4-crm', currentTower);
                setTimeout(() => {
                    selectFloor('team4-crm', currentFloor);
                    setTimeout(() => {
                        const flatElement = document.querySelector(`#team4-crm-flat-grid .flat-item[data-flat="${currentFlat}"]`);
                        if (flatElement) {
                            flatElement.click();
                        }
                    }, 500);
                }, 500);
            }, 1000);
        }
        
        function moveToFirstVisitFromTeam4CRM() {
            saveTeam4CRM();
            setTimeout(() => {
                openTab('first-visit');
                selectTower('first-visit', currentTower);
                setTimeout(() => {
                    selectFloor('first-visit', currentFloor);
                    setTimeout(() => {
                        const flatElement = document.querySelector(`#first-visit-flat-grid .flat-item[data-flat="${currentFlat}"]`);
                        if (flatElement) {
                            flatElement.click();
                        }
                    }, 500);
                }, 500);
            }, 1000);
        }
        
        function moveToTeam4CRMFromThirdParty() {
            // Save third party inspection and move to TEAM4 CRM
            setTimeout(() => {
                openTab('team4-crm');
                selectTower('team4-crm', currentTower);
                setTimeout(() => {
                    selectFloor('team4-crm', currentFloor);
                    setTimeout(() => {
                        const flatElement = document.querySelector(`#team4-crm-flat-grid .flat-item[data-flat="${currentFlat}"]`);
                        if (flatElement) {
                            flatElement.click();
                        }
                    }, 500);
                }, 500);
            }, 1000);
        }
        
        // ================== ANALYTICS FUNCTIONS ==================
        
        function initializeCharts() {
            // Initialize Chart.js instances with empty data
            chartInstances.completionChart = new Chart(
                document.getElementById('completionChart').getContext('2d'),
                getChartConfig('bar', 'Process Completion', 
                    ['Key Handover', 'Snagging', 'Project/MEP', 'TEAM4 CRM', 'CBRE CRM', 'First Visit', 'Handover', 'Interiors', 'Move-in'], 
                    [0, 0, 0, 0, 0, 0, 0, 0, 0])
            );
            
            chartInstances.towerChart = new Chart(
                document.getElementById('towerChart').getContext('2d'),
                getChartConfig('doughnut', 'Tower Distribution', ['Tower A', 'Tower B', 'Tower C'], [0, 0, 0])
            );
            
            chartInstances.trendChart = new Chart(
                document.getElementById('trendChart').getContext('2d'),
                getChartConfig('line', 'Monthly Progress', ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], [0, 0, 0, 0, 0, 0])
            );
            
            chartInstances.statusChart = new Chart(
                document.getElementById('statusChart').getContext('2d'),
                getChartConfig('pie', 'Status Overview', ['Completed', 'In Progress', 'Not Started'], [0, 0, 0])
            );
        }
        
        function getChartConfig(type, label, labels, data) {
            const colors = {
                bar: ['#80BBAD', '#17E88F', '#6f42c1', '#6610f2', '#20c997', '#DBD99A', '#3E7CA6', '#885073', '#1F3765'],
                doughnut: ['#1F3765', '#2A4A8A', '#3E7CA6'],
                line: '#D2785A',
                pie: ['#28a745', '#ffc107', '#dc3545']
            };
            
            return {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: type === 'line' ? colors.line : colors[type],
                        borderColor: type === 'line' ? colors.line : colors[type].map(c => c.replace('0.8', '1')),
                        borderWidth: 2,
                        fill: type === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            };
        }
        
        function loadAnalyticsData() {
            // Load analytics data from real data
            updateAnalyticsChartsWithRealData();
        }
        
        function updateAnalyticsChartsWithRealData() {
            if (!allProcessData || Object.keys(allProcessData).length === 0) {
                console.log('No real data available for analytics');
                return;
            }
            
            // Update completion chart with real data
            const completionData = [
                allProcessData.key_handover ? allProcessData.key_handover.length : 0,
                allProcessData.snagging ? allProcessData.snagging.length : 0,
                allProcessData.project_mep ? allProcessData.project_mep.length : 0,
                allProcessData.team4_crm ? allProcessData.team4_crm.length : 0,
                allProcessData.cbre_crm ? allProcessData.cbre_crm.length : 0,
                allProcessData.first_visit ? allProcessData.first_visit.length : 0,
                allProcessData.handover ? allProcessData.handover.length : 0,
                allProcessData.interiors ? allProcessData.interiors.length : 0,
                allProcessData.movein ? allProcessData.movein.length : 0
            ];
            
            // Update tower chart with real data
            const towerData = calculateTowerDistribution();
            
            // Update trend chart with monthly data
            const trendData = calculateMonthlyTrend();
            
            // Update status chart
            const statusData = calculateStatusOverview();
            
            // Update chart instances
            if (chartInstances.completionChart) {
                chartInstances.completionChart.data.datasets[0].data = completionData;
                chartInstances.completionChart.update();
            }
            
            if (chartInstances.towerChart) {
                chartInstances.towerChart.data.datasets[0].data = towerData;
                chartInstances.towerChart.update();
            }
            
            if (chartInstances.trendChart) {
                chartInstances.trendChart.data.datasets[0].data = trendData;
                chartInstances.trendChart.update();
            }
            
            if (chartInstances.statusChart) {
                chartInstances.statusChart.data.datasets[0].data = statusData;
                chartInstances.statusChart.update();
            }
            
            showNotification('Analytics updated with real data', 'success');
        }
        
        function calculateTowerDistribution() {
            const towerCounts = { A: 0, B: 0, C: 0 };
            
            // Count all records across all processes for each tower
            Object.values(allProcessData).forEach(processData => {
                processData.forEach(item => {
                    if (item.tower && towerCounts[item.tower] !== undefined) {
                        towerCounts[item.tower]++;
                    }
                });
            });
            
            return [towerCounts.A, towerCounts.B, towerCounts.C];
        }
        
        function calculateMonthlyTrend() {
            // Calculate monthly trend based on created_at dates
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthCounts = new Array(12).fill(0);
            
            Object.values(allProcessData).forEach(processData => {
                processData.forEach(item => {
                    if (item.created_at) {
                        const date = new Date(item.created_at);
                        const month = date.getMonth(); // 0-11
                        if (month >= 0 && month < 12) {
                            monthCounts[month]++;
                        }
                    }
                });
            });
            
            // Get last 6 months
            const currentMonth = new Date().getMonth();
            const last6Months = [];
            const last6MonthCounts = [];
            
            for (let i = 5; i >= 0; i--) {
                const monthIndex = (currentMonth - i + 12) % 12;
                last6Months.push(months[monthIndex]);
                last6MonthCounts.push(monthCounts[monthIndex]);
            }
            
            // Update trend chart labels
            if (chartInstances.trendChart) {
                chartInstances.trendChart.data.labels = last6Months;
            }
            
            return last6MonthCounts;
        }
        
        function calculateStatusOverview() {
            const totalFlats = BUILDING_CONFIG.towers.length * BUILDING_CONFIG.floors * BUILDING_CONFIG.flatsPerFloor;
            const completed = allProcessData.movein ? allProcessData.movein.length : 0;
            const inProgress = calculateInProgressCount();
            const notStarted = totalFlats - completed - inProgress;
            
            return [completed, inProgress, notStarted];
        }
        
        function calculateInProgressCount() {
            let count = 0;
            
            // Count flats that are in progress (have some data but not completed move-in)
            const allFlats = new Set();
            const moveinFlats = new Set();
            
            // Get all flats with any data
            Object.values(allProcessData).forEach(processData => {
                processData.forEach(item => {
                    if (item.tower && item.flat) {
                        allFlats.add(`${item.tower}${item.flat}`);
                    }
                });
            });
            
            // Get move-in flats
            if (allProcessData.movein) {
                allProcessData.movein.forEach(item => {
                    if (item.tower && item.flat) {
                        moveinFlats.add(`${item.tower}${item.flat}`);
                    }
                });
            }
            
            // Count flats that have data but are not in move-in
            allFlats.forEach(flat => {
                if (!moveinFlats.has(flat)) {
                    count++;
                }
            });
            
            return count;
        }
        
        function setDateFilter(range) {
            const now = new Date();
            let startDate, endDate;
            
            switch(range) {
                case 'today':
                    startDate = endDate = now.toISOString().split('T')[0];
                    break;
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7)).toISOString().split('T')[0];
                    endDate = new Date().toISOString().split('T')[0];
                    break;
                case 'month':
                    startDate = new Date(now.setMonth(now.getMonth() - 1)).toISOString().split('T')[0];
                    endDate = new Date().toISOString().split('T')[0];
                    break;
                case 'quarter':
                    startDate = new Date(now.setMonth(now.getMonth() - 3)).toISOString().split('T')[0];
                    endDate = new Date().toISOString().split('T')[0];
                    break;
                case 'year':
                    startDate = new Date(now.setFullYear(now.getFullYear() - 1)).toISOString().split('T')[0];
                    endDate = new Date().toISOString().split('T')[0];
                    break;
                case 'all':
                    startDate = '2020-01-01';
                    endDate = new Date().toISOString().split('T')[0];
                    break;
            }
            
            document.getElementById('startDate').value = startDate;
            document.getElementById('endDate').value = endDate;
            
            // Update active button
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Refresh analytics with new date range
            loadAnalyticsData();
        }
        
        function refreshAnalytics() {
            loadAllProcessData().then(() => {
                loadAnalyticsData();
                showNotification('Analytics refreshed with latest data', 'success');
            });
        }
        
        function exportChart(chartId) {
            const chart = chartInstances[chartId];
            if (chart) {
                const link = document.createElement('a');
                link.download = `${chartId}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = chart.toBase64Image();
                link.click();
                showNotification('Chart exported successfully', 'success');
            }
        }
        
        function generateAnalyticsReport() {
            showNotification('Analytics report generation started', 'info');
            // This would generate a comprehensive PDF report
        }
        
        function exportAnalyticsData() {
            showNotification('Exporting analytics data to Excel...', 'info');
            // This would export analytics data to Excel
        }
        
        // ================== EXCEL PROCESSOR FUNCTIONS ==================
        
        function handleFileDrop(event) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.csv'))) {
                document.getElementById('excelFileInput').files = event.dataTransfer.files;
                handleExcelFileSelect(event);
            }
        }
        
        function handleDragOver(event) {
            event.preventDefault();
        }
        
        function selectTemplate() {
            const template = document.getElementById('templateSelect').value;
            if (template) {
                document.getElementById('importProcess').value = template;
            }
        }
        
        function downloadSelectedTemplate() {
            const template = document.getElementById('templateSelect').value;
            if (!template) {
                showNotification('Please select a template type first', 'error');
                return;
            }
            
            // Create a simple template with headers
            const headers = EXCEL_TEMPLATES[template] ? 
                [...EXCEL_TEMPLATES[template].required, ...EXCEL_TEMPLATES[template].optional] : 
                [];
            
            const ws = XLSX.utils.aoa_to_sheet([headers]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, `${template}_template.xlsx`);
            
            showNotification(`Template for ${template} downloaded`, 'success');
        }
        
        function processImport() {
            if (excelValidationResults.valid.length === 0) {
                showNotification('No valid data to import. Please validate data first.', 'error');
                return;
            }
            
            const process = document.getElementById('importProcess').value;
            const action = document.getElementById('importAction').value;
            
            if (!process) {
                showNotification('Please select a process to import', 'error');
                return;
            }
            
            // Process import based on action
            showNotification(`Importing ${excelValidationResults.valid.length} valid rows for ${process}...`, 'info');
            
            // Here you would typically send data to backend
            // For now, just show a summary
            document.getElementById('importSummary').style.display = 'block';
            document.getElementById('summaryText').innerHTML = `
                <p><strong>Import Summary:</strong></p>
                <p>Process: ${process}</p>
                <p>Action: ${action}</p>
                <p>Valid rows to import: ${excelValidationResults.valid.length}</p>
                <p>Rows with errors: ${excelValidationResults.errors.length}</p>
                <p>Status: Ready to import</p>
            `;
            
            showNotification(`Ready to import ${excelValidationResults.valid.length} rows for ${process}`, 'success');
        }
        
        function exportAllToExcel() {
            showNotification('Exporting all data to Excel...', 'info');
            // Implementation would export all data to Excel
        }
        
        function exportSelectedProcess() {
            const process = document.getElementById('importProcess').value;
            if (!process) {
                showNotification('Please select a process to export', 'error');
                return;
            }
            showNotification(`Exporting ${process} data to Excel...`, 'info');
        }
        
        function exportToGoogleSheets() {
            showNotification('Exporting to Google Sheets...', 'info');
        }
        
        // ================== MODAL FUNCTIONS ==================
        
        // View flat details - ADDED MISSING FUNCTION
        function viewFlatDetails() {
            // Load and display flat details in modal
            const modal = document.getElementById('flatDetailsModal');
            const content = document.getElementById('flatDetailsContent');
            
            // Get all data for this flat
            const flatData = {};
            Object.keys(allProcessData).forEach(process => {
                const data = getFlatDataForProcess(process, currentFlat);
                if (data) {
                    flatData[process] = data;
                }
            });
            
            content.innerHTML = `
                <div class="data-section">
                    <h4><i class="fas fa-info-circle"></i> Flat Information</h4>
                    <div class="data-row">
                        <div class="data-field">
                            <div class="field-label">Flat Number</div>
                            <div class="field-value">${currentFlat.substring(1)}</div>
                        </div>
                        <div class="data-field">
                            <div class="field-label">Tower</div>
                            <div class="field-value">${currentTower}</div>
                        </div>
                        <div class="data-field">
                            <div class="field-label">Floor</div>
                            <div class="field-value">${currentFloor}</div>
                        </div>
                        <div class="data-field">
                            <div class="field-label">Status</div>
                            <div class="field-value">${getFlatStatus(flatData)}</div>
                        </div>
                    </div>
                </div>
                
                <div class="data-section">
                    <h4><i class="fas fa-history"></i> Process History</h4>
                    ${Object.keys(flatData).map(process => `
                        <div class="data-field" style="margin-bottom: 10px;">
                            <div class="field-label">${process.replace('_', ' ').toUpperCase()}</div>
                            <div class="field-value">${formatProcessData(flatData[process])}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        function getFlatStatus(flatData) {
            if (flatData.movein) return 'Move-in Completed';
            if (flatData.interiors) return 'Interiors in Progress';
            if (flatData.handover) return 'Handover Completed';
            if (flatData.first_visit) return 'First Visit Completed';
            if (flatData.team4_crm) return 'TEAM4 CRM Processing';
            if (flatData.project_mep) return 'Project/MEP Processing';
            if (flatData.snagging) return 'Snagging in Progress';
            if (flatData.key_handover) return 'Key Handover Completed';
            return 'Not Started';
        }
        
        function formatProcessData(data) {
            if (!data) return 'No data';
            
            // Format based on process type
            if (data.created_at) {
                const date = new Date(data.created_at);
                return `Created: ${date.toLocaleDateString()}`;
            }
            
            return 'Data available';
        }
        
        function closeModal() {
            document.getElementById('flatDetailsModal').style.display = 'none';
        }
        
        function openDeviationForm(process) {
            const modal = document.getElementById('deviationModal');
            const content = document.getElementById('deviationFormContent');
            
            content.innerHTML = `
                <div class="form-group">
                    <label for="deviationType">Deviation Type *</label>
                    <select id="deviationType">
                        <option value="safety">Safety Violation</option>
                        <option value="quality">Quality Issue</option>
                        <option value="schedule">Schedule Delay</option>
                        <option value="process">Process Deviation</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="deviationDescription">Description *</label>
                    <textarea id="deviationDescription" rows="4" placeholder="Describe the deviation..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="deviationSeverity">Severity *</label>
                        <select id="deviationSeverity">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="deviationReportedBy">Reported By *</label>
                        <input type="text" id="deviationReportedBy" placeholder="Your name">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" onclick="saveDeviation('${process}')">
                        <i class="fas fa-save"></i> Save Deviation
                    </button>
                    <button class="btn btn-secondary" onclick="closeDeviationModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        function closeDeviationModal() {
            document.getElementById('deviationModal').style.display = 'none';
        }
        
        async function saveDeviation(process) {
            const data = {
                process_type: process,
                tower: currentTower,
                flat: currentFlat.substring(1),
                deviation_type: document.getElementById('deviationType').value,
                description: document.getElementById('deviationDescription').value,
                severity: document.getElementById('deviationSeverity').value,
                reported_by: document.getElementById('deviationReportedBy').value,
                reported_date: new Date().toISOString().split('T')[0]
            };
            
            const result = await callBackend('save_data', 'deviations', data);
            if (result && result.success) {
                showNotification('Deviation recorded successfully', 'success');
                closeDeviationModal();
            }
        }
        
        // ================== INTEGRATION TAB FUNCTIONS ==================
        
        function testConnection() {
            const url = document.getElementById('webAppUrl').value;
            if (!url) {
                showNotification('Please enter a Web App URL', 'error');
                return;
            }
            
            backendUrl = url;
            localStorage.setItem('hoto_backend_url', url);
            
            testBackendConnection().then(success => {
                if (success) {
                    document.getElementById('connectionStatus').className = 'status-badge status-connected';
                    document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                    document.getElementById('lastSyncTime').textContent = new Date().toLocaleTimeString();
                    showNotification('Connection successful!', 'success');
                    loadAllProcessData();
                }
            });
        }
        
        function saveConnection() {
            const url = document.getElementById('webAppUrl').value;
            if (!url) {
                showNotification('Please enter a Web App URL', 'error');
                return;
            }
            
            backendUrl = url;
            localStorage.setItem('hoto_backend_url', url);
            showNotification('Connection saved successfully', 'success');
        }
        
        function copyWebAppCode() {
            const codeTextarea = document.getElementById('webAppCode');
            codeTextarea.select();
            document.execCommand('copy');
            showNotification('Code copied to clipboard', 'success');
        }
        
        function syncAllData() {
            showNotification('Starting full data sync...', 'info');
            // This would sync all local data with Google Sheets
        }
        
        function createGoogleSheetTemplate() {
            window.open('https://docs.google.com/spreadsheets/create', '_blank');
            showNotification('Opening Google Sheets. Create sheets with required names.', 'info');
        }
        
        function downloadSheetTemplate() {
            showNotification('Downloading Excel template...', 'info');
            // Implementation would download a complete Excel template
        }
        
        // Vendor management functions
        function addAdditionalVendor() {
            const container = document.getElementById('additionalVendorsContainer');
            const newVendorForm = container.cloneNode(true);
            newVendorForm.id = 'additionalVendorsContainer' + Date.now();
            newVendorForm.classList.remove('hidden');
            container.parentNode.insertBefore(newVendorForm, container.nextSibling);
        }
        
        function removeVendor(button) {
            const vendorForm = button.closest('.vendor-form');
            vendorForm.remove();
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const flatModal = document.getElementById('flatDetailsModal');
            const deviationModal = document.getElementById('deviationModal');
            
            if (event.target === flatModal) {
                closeModal();
            }
            if (event.target === deviationModal) {
                closeDeviationModal();
            }
        };
    </script>
</body>
</html>
