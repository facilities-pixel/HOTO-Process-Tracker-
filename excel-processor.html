<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Import - HOT Process</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- REMOVED FIREBASE SCRIPTS -->
    <style>
        /* KEEP ALL YOUR EXISTING CSS STYLES EXACTLY AS THEY ARE */
        .upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #f8f9fa;
        }
        
        .upload-area:hover {
            border-color: #0d6efd;
            background: #e7f1ff;
        }
        
        .upload-area.dragover {
            border-color: #0d6efd;
            background: #e7f1ff;
        }
        
        .preview-table {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .column-mapping {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .mapping-row {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .mapping-row:last-child {
            border-bottom: none;
        }
        
        .excel-col {
            flex: 1;
            font-weight: 600;
            color: #1F3765;
        }
        
        .mapping-select {
            flex: 2;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .import-log {
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .log-success {
            color: #198754;
        }
        
        .log-error {
            color: #dc3545;
        }
        
        .log-warning {
            color: #ffc107;
        }
        
        .template-card {
            height: 100%;
            transition: transform 0.2s;
        }
        
        .template-card:hover {
            transform: translateY(-5px);
        }
        
        .validation-error {
            border: 2px solid #dc3545 !important;
            background-color: #f8d7da !important;
        }
        
        .validation-success {
            border: 2px solid #198754 !important;
            background-color: #d4edda !important;
        }
        
        .error-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #dee2e6;
            z-index: 1;
        }
        
        .step {
            position: relative;
            z-index: 2;
            background: white;
            padding: 0 10px;
            text-align: center;
        }
        
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 5px;
            font-weight: bold;
        }
        
        .step.active .step-circle {
            background: #0d6efd;
            color: white;
        }
        
        .step.completed .step-circle {
            background: #198754;
            color: white;
        }
        
        .step-label {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .step.active .step-label {
            color: #0d6efd;
            font-weight: 500;
        }
        
        .step.completed .step-label {
            color: #198754;
        }
        
        /* NEW: Sync status indicator */
        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .sync-online {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .sync-offline {
            background: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* NEW: Import mode selector */
        .import-mode-selector {
            background: #e7f1ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <!-- GOOGLE APPS SCRIPT CONFIGURATION - ADDED -->
    <script>
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwRWU5znq3r653lh1qtPa6YDVtkxy77WO0nQ8uyrDF4qL-Dxay4Jim01aLMGtLzXj-M6g/exec';
        let deviceId = localStorage.getItem('hot_device_id') || 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('hot_device_id', deviceId);
        let isOnline = navigator.onLine;
        let pendingImports = JSON.parse(localStorage.getItem('hot_pending_imports') || '[]');
    </script>

    <!-- Sheet Selection Modal -->
    <div class="modal fade" id="sheetModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Sheet to Import</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="sheetModalBody">
                    <!-- Sheet options will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="loadSelectedSheet()">Load Selected Sheet</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <!-- Header with sync status - MODIFIED -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="fas fa-file-excel text-success"></i> Excel Data Import</h2>
                        <p class="text-muted">Import data from Excel/CSV files to HOT Process System</p>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="me-3" id="syncStatus">
                            <span class="sync-indicator sync-online"></span> Online
                        </div>
                        <a href="index.html" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
                
                <!-- Import Mode Selector - ADDED -->
                <div class="import-mode-selector">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="syncToCloud" checked>
                                <label class="form-check-label" for="syncToCloud">
                                    <strong>Sync to Google Apps Script (Recommended)</strong> - Data will be saved to cloud for cross-device access
                                </label>
                            </div>
                            <small class="text-muted">If offline, data will be queued and synced when back online</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-sm btn-outline-info" onclick="syncPendingImports()">
                                <i class="fas fa-sync"></i> Sync Pending Imports
                                <span class="badge bg-danger" id="pendingImportCount" style="display: none;">0</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Step Indicator -->
                <div class="step-indicator mb-4">
                    <div class="step active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Upload File</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Preview Data</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Map Columns</div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Import Progress</div>
                    </div>
                </div>
                
                <!-- Upload Area -->
                <div class="card mb-4" id="uploadCard">
                    <div class="card-header">
                        <h5 class="mb-0">Step 1: Upload Excel File</h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-file-excel fa-4x text-success mb-3"></i>
                            <h4>Drop Excel file here or click to browse</h4>
                            <p class="text-muted">Supports .xlsx, .xls, .csv files (Max: 10MB)</p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileSelect(event)">
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p class="text-muted">Or paste Excel data directly:</p>
                                <textarea id="excelPaste" class="form-control" rows="5" placeholder="Paste CSV data here..."></textarea>
                                <button class="btn btn-secondary mt-2" onclick="parsePastedData()">
                                    <i class="fas fa-paste"></i> Parse Pasted Data
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> File Requirements:</h6>
                                    <ul class="mb-0">
                                        <li>First row must contain headers</li>
                                        <li>Supported columns: Tower, Flat, Date fields</li>
                                        <li>Maximum file size: 10MB</li>
                                        <li>Maximum rows: 10,000</li>
                                        <li><strong>Date format: DD.MM.YYYY (e.g., 01.01.2025)</strong></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Preview -->
                <div class="card mb-4" id="previewCard" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Step 2: Data Preview & Validation</h5>
                        <span class="badge bg-info" id="validationSummary">0 errors found</span>
                    </div>
                    <div class="card-body">
                        <div class="alert" id="validationAlert" style="display: none;"></div>
                        
                        <div class="preview-table">
                            <table class="table table-bordered table-sm" id="previewTable">
                                <!-- Preview will be loaded here -->
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-info" id="rowCount">0 rows</span>
                                    <span class="badge bg-info ms-2" id="colCount">0 columns</span>
                                    <span class="badge bg-warning ms-2" id="errorCount">0 errors</span>
                                </div>
                                <div>
                                    <button class="btn btn-warning" onclick="validateData()">
                                        <i class="fas fa-check-circle"></i> Validate Data
                                    </button>
                                    <button class="btn btn-primary ms-2" onclick="setupColumnMapping()">
                                        <i class="fas fa-arrow-right"></i> Continue to Mapping
                                    </button>
                                </div>
                            </div>
                            
                            <div class="error-list" id="errorList" style="display: none;">
                                <!-- Error details will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Column Mapping -->
                <div class="card mb-4" id="mappingCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">Step 3: Column Mapping</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Map Excel columns to HOT Process System fields</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Select Data Type</label>
                                    <select class="form-select" id="dataType" onchange="updateFieldOptions()">
                                        <option value="keyHandover">Key Handover Data</option>
                                        <option value="snagging">Snagging Data</option>
                                        <option value="firstVisit">First Visit Data</option>
                                        <option value="handover">Handover Data</option>
                                        <option value="interiors">Interior Work Data</option>
                                        <option value="movein">Move-in Data</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Import Strategy</label>
                                    <select class="form-select" id="importStrategy">
                                        <option value="add_new">Add new records only</option>
                                        <option value="update_existing">Update existing records</option>
                                        <option value="replace_all">Replace all data</option>
                                        <option value="merge" selected>Merge with existing data</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="createMissing" checked>
                                <label class="form-check-label" for="createMissing">
                                    Create missing flats automatically
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="validateDates" checked>
                                <label class="form-check-label" for="validateDates">
                                    Validate date formats
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="skipDuplicates" checked>
                                <label class="form-check-label" for="skipDuplicates">
                                    Skip duplicate records
                                </label>
                            </div>
                        </div>
                        
                        <div class="column-mapping" id="columnMapping">
                            <!-- Mapping will be generated here -->
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-secondary" onclick="backToPreview()">
                                <i class="fas fa-arrow-left"></i> Back to Preview
                            </button>
                            <button class="btn btn-success" onclick="startImport()">
                                <i class="fas fa-database"></i> Start Import
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Import Progress -->
                <div class="card mb-4" id="progressCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">Step 4: Import Progress</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress-container">
                            <div class="d-flex justify-content-between mb-2">
                                <span id="importStatus">Preparing import...</span>
                                <span id="importPercent">0%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="importProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 id="importedCount">0</h5>
                                        <small class="text-muted">Imported</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 id="skippedCount">0</h5>
                                        <small class="text-muted">Skipped</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 id="errorImportCount">0</h5>
                                        <small class="text-muted">Errors</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="import-log" id="importLog">
                            <!-- Import logs will appear here -->
                        </div>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-primary" id="completeBtn" style="display: none;" onclick="importComplete()">
                                <i class="fas fa-check"></i> Import Complete
                            </button>
                            <button class="btn btn-danger" id="cancelBtn" style="display: none;" onclick="cancelImport()">
                                <i class="fas fa-times"></i> Cancel Import
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Excel Templates -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Excel Templates</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Download pre-formatted Excel templates for easy data entry:</p>
                        <div class="row g-3">
                            <!-- Key Handover Template -->
                            <div class="col-md-4">
                                <div class="card template-card border-primary">
                                    <div class="card-body text-center">
                                        <i class="fas fa-key fa-2x text-primary mb-3"></i>
                                        <h6>Key Handover Template</h6>
                                        <p class="small text-muted">Import key handover data</p>
                                        <button class="btn btn-sm btn-outline-primary" onclick="downloadTemplate('key_handover')">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Snagging Template -->
                            <div class="col-md-4">
                                <div class="card template-card border-success">
                                    <div class="card-body text-center">
                                        <i class="fas fa-search fa-2x text-success mb-3"></i>
                                        <h6>Snagging Template</h6>
                                        <p class="small text-muted">Import snagging data</p>
                                        <button class="btn btn-sm btn-outline-success" onclick="downloadTemplate('snagging')">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- First Visit Template -->
                            <div class="col-md-4">
                                <div class="card template-card border-warning">
                                    <div class="card-body text-center">
                                        <i class="fas fa-calendar-check fa-2x text-warning mb-3"></i>
                                        <h6>First Visit Template</h6>
                                        <p class="small text-muted">Import first visit data</p>
                                        <button class="btn btn-sm btn-outline-warning" onclick="downloadTemplate('first_visit')">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Handover Template -->
                            <div class="col-md-4">
                                <div class="card template-card border-info">
                                    <div class="card-body text-center">
                                        <i class="fas fa-handshake fa-2x text-info mb-3"></i>
                                        <h6>Handover Template</h6>
                                        <p class="small text-muted">Import handover data</p>
                                        <button class="btn btn-sm btn-outline-info" onclick="downloadTemplate('handover')">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Interiors Template -->
                            <div class="col-md-4">
                                <div class="card template-card border-danger">
                                    <div class="card-body text-center">
                                        <i class="fas fa-hammer fa-2x text-danger mb-3"></i>
                                        <h6>Interior Work Template</h6>
                                        <p class="small text-muted">Import interior work data</p>
                                        <button class="btn btn-sm btn-outline-danger" onclick="downloadTemplate('interiors')">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Move-in Template -->
                            <div class="col-md-4">
                                <div class="card template-card border-secondary">
                                    <div class="card-body text-center">
                                        <i class="fas fa-home fa-2x text-secondary mb-3"></i>
                                        <h6>Move-in Template</h6>
                                        <p class="small text-muted">Import move-in data</p>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="downloadTemplate('movein')">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Important:</strong> When using templates, keep the column headers exactly as provided. 
                            Only modify the data rows.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Excel Processor JavaScript with Google Apps Script Integration
        let excelData = null;
        let columnMapping = {};
        let importLog = [];
        let fieldOptions = {};
        let validationErrors = [];
        let isImporting = false;
        let importCanceled = false;
        let currentWorkbook = null;
        
        // Field options for each data type - UPDATED to match data entry structure
        const fieldOptionsData = {
            keyHandover: [
                { value: '', label: '-- Ignore Column --' },
                { value: 'tower', label: 'Tower (A, B, C)', required: true },
                { value: 'flat', label: 'Flat Number', required: true },
                { value: 'person', label: 'Handover Person', required: true },
                { value: 'date', label: 'Handover Date', required: true },
                { value: 'incompleteKeys', label: 'Incomplete Keys (YES/NO)' },
                { value: 'remarks', label: 'Key Remarks' },
                { value: 'status', label: 'Status' }
            ],
            snagging: [
                { value: '', label: '-- Ignore Column --' },
                { value: 'tower', label: 'Tower (A, B, C)', required: true },
                { value: 'flat', label: 'Flat Number', required: true },
                { value: 'inspector', label: 'Inspector Name', required: true },
                { value: 'startDate', label: 'Start Date', required: true },
                { value: 'endDate', label: 'End Date' },
                { value: 'followupDate', label: 'Follow-up Date' },
                { value: 'mepCompleted', label: 'MEP Completed (YES/NO)' },
                { value: 'civilCompleted', label: 'Civil Completed (YES/NO)' },
                { value: 'electricalCompleted', label: 'Electrical Completed (YES/NO)' },
                { value: 'waterCompleted', label: 'Water & Slopes Completed (YES/NO)' },
                { value: 'acDrainCompleted', label: 'AC Drain Completed (YES/NO)' },
                { value: 'tilesCompleted', label: 'Tiles Completed (YES/NO)' },
                { value: 'remarks', label: 'Snag Remarks' },
                { value: 'status', label: 'Status' }
            ],
            firstVisit: [
                { value: '', label: '-- Ignore Column --' },
                { value: 'tower', label: 'Tower (A, B, C)', required: true },
                { value: 'flat', label: 'Flat Number', required: true },
                { value: 'ownerName', label: 'Owner Name', required: true },
                { value: 'ownerPhone', label: 'Owner Phone', required: true },
                { value: 'date', label: 'Visit Date & Time', required: true },
                { value: 'hotMember', label: 'HOT Team Member', required: true },
                { value: 'handoverSuggested', label: 'Handover Date Suggested' },
                { value: 'remarks', label: 'Customer Remarks' },
                { value: 'crmNOC', label: 'CRM NOC (YES/NO)' },
                { value: 'status', label: 'Status' }
            ],
            handover: [
                { value: '', label: '-- Ignore Column --' },
                { value: 'tower', label: 'Tower (A, B, C)', required: true },
                { value: 'flat', label: 'Flat Number', required: true },
                { value: 'customerName', label: 'Customer Name', required: true },
                { value: 'secondOwner', label: 'Second Owner Name' },
                { value: 'ownerEmail', label: 'Owner Email Address', required: true },
                { value: 'secondOwnerEmail', label: 'Second Owner Email' },
                { value: 'hotoMember', label: 'HOTO Team Member', required: true },
                { value: 'date', label: 'Handover Date & Time', required: true },
                { value: 'keysHanded', label: 'All Keys Handed (YES/NO)' },
                { value: 'manualHanded', label: 'Handover Book Handed (YES/NO)' },
                { value: 'giftBoxHanded', label: 'Gift Box Handed (YES/NO)' },
                { value: 'feedback', label: 'Customer Feedback' },
                { value: 'status', label: 'Status' }
            ],
            interiors: [
                { value: '', label: '-- Ignore Column --' },
                { value: 'tower', label: 'Tower (A, B, C)', required: true },
                { value: 'flat', label: 'Flat Number', required: true },
                { value: 'startDate', label: 'Start Date', required: true },
                { value: 'endDate', label: 'Expected End Date' },
                { value: 'contractorName', label: 'Contractor Name', required: true },
                { value: 'contractorContact', label: 'Contractor Contact' },
                { value: 'clearanceBy', label: 'Clearance By' },
                { value: 'flooring', label: 'Flooring (YES/NO)' },
                { value: 'painting', label: 'Painting (YES/NO)' },
                { value: 'carpentry', label: 'Carpentry (YES/NO)' },
                { value: 'electrical', label: 'Electrical (YES/NO)' },
                { value: 'plumbing', label: 'Plumbing (YES/NO)' },
                { value: 'falseCeiling', label: 'False Ceiling (YES/NO)' },
                { value: 'remarks', label: 'Remarks' },
                { value: 'status', label: 'Status' }
            ],
            movein: [
                { value: '', label: '-- Ignore Column --' },
                { value: 'tower', label: 'Tower (A, B, C)', required: true },
                { value: 'flat', label: 'Flat Number', required: true },
                { value: 'customerName', label: 'Customer Name', required: true },
                { value: 'date', label: 'Move-in Date & Time', required: true },
                { value: 'contactNumber', label: 'Contact Number' },
                { value: 'remarks', label: 'Remarks/Special Instructions' },
                { value: 'status', label: 'Status' }
            ]
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect({ target: { files: files } });
                }
            });
            
            // Initialize field options
            fieldOptions = fieldOptionsData.keyHandover;
            
            // Setup connection monitoring
            setupConnectionMonitoring();
            
            // Update pending import count
            updatePendingImportCount();
        });
        
        // Setup connection monitoring - NEW FUNCTION
        function setupConnectionMonitoring() {
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOfflineStatus);
            
            updateConnectionStatus();
        }
        
        // Handle online status - NEW FUNCTION
        function handleOnlineStatus() {
            isOnline = true;
            updateConnectionStatus();
            showNotification('Back online. Data will sync to cloud.', 'success');
        }
        
        // Handle offline status - NEW FUNCTION
        function handleOfflineStatus() {
            isOnline = false;
            updateConnectionStatus();
            showNotification('You are offline. Data will be saved locally.', 'warning');
        }
        
        // Update connection status - NEW FUNCTION
        function updateConnectionStatus() {
            const statusElement = document.getElementById('syncStatus');
            if (statusElement) {
                const indicator = statusElement.querySelector('.sync-indicator');
                indicator.className = isOnline ? 'sync-indicator sync-online' : 'sync-indicator sync-offline';
                statusElement.innerHTML = `<span class="${isOnline ? 'sync-indicator sync-online' : 'sync-indicator sync-offline'}"></span> ${isOnline ? 'Online' : 'Offline'}`;
            }
        }
        
        // Update pending import count - NEW FUNCTION
        function updatePendingImportCount() {
            const pendingImports = JSON.parse(localStorage.getItem('hot_pending_imports') || '[]');
            const countElement = document.getElementById('pendingImportCount');
            
            if (pendingImports.length > 0) {
                countElement.textContent = pendingImports.length;
                countElement.style.display = 'inline';
            } else {
                countElement.style.display = 'none';
            }
        }
        
        // Sync pending imports - NEW FUNCTION
        async function syncPendingImports() {
            if (!isOnline) {
                showNotification('You are offline. Cannot sync to cloud.', 'warning');
                return;
            }
            
            const pendingImports = JSON.parse(localStorage.getItem('hot_pending_imports') || '[]');
            if (pendingImports.length === 0) {
                showNotification('No pending imports to sync', 'info');
                return;
            }
            
            showNotification(`Syncing ${pendingImports.length} pending imports to cloud...`, 'info');
            
            let syncedCount = 0;
            let failedCount = 0;
            
            for (const importData of pendingImports) {
                const result = await saveToGoogleAppsScript(importData);
                if (result.success) {
                    syncedCount++;
                } else {
                    failedCount++;
                }
            }
            
            if (failedCount === 0) {
                // Clear pending imports
                localStorage.setItem('hot_pending_imports', JSON.stringify([]));
                updatePendingImportCount();
                showNotification(`${syncedCount} imports synced to cloud successfully!`, 'success');
            } else {
                // Keep failed imports
                showNotification(`${syncedCount} synced, ${failedCount} failed. Will retry later.`, 'warning');
            }
        }
        
        // Update step indicators
        function updateStepIndicator(currentStep) {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
            }
            
            for (let i = 1; i <= currentStep; i++) {
                const step = document.getElementById(`step${i}`);
                if (i === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.add('completed');
                }
            }
        }
        
        // Update field options based on selected data type
        function updateFieldOptions() {
            const dataType = document.getElementById('dataType').value;
            fieldOptions = fieldOptionsData[dataType] || fieldOptionsData.keyHandover;
            
            if (excelData && excelData.length > 0) {
                setupColumnMapping();
            }
        }
        
        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                alert('File size exceeds 10MB limit. Please use a smaller file.');
                return;
            }
            
            const validExtensions = ['.xlsx', '.xls', '.csv'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            if (!validExtensions.includes(fileExt)) {
                alert('Please upload Excel (.xlsx, .xls) or CSV (.csv) files only.');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    currentWorkbook = workbook;
                    showSheetSelection(workbook);
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file. Please try again.');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Show sheet selection
        function showSheetSelection(workbook) {
            const sheetNames = workbook.SheetNames;
            
            if (sheetNames.length === 1) {
                loadSheetData(workbook, sheetNames[0]);
            } else {
                const modalBody = document.getElementById('sheetModalBody');
                let modalContent = '<p>Multiple sheets found. Select which sheet to import:</p>';
                
                sheetNames.forEach((sheetName, index) => {
                    const hasData = workbook.Sheets[sheetName]['!ref'] ? 'Has data' : 'Empty';
                    modalContent += `
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="sheetSelect" 
                                   value="${sheetName}" id="sheet${index}" ${index === 0 ? 'checked' : ''}>
                            <label class="form-check-label" for="sheet${index}">
                                ${sheetName} (${hasData})
                            </label>
                        </div>
                    `;
                });
                
                modalBody.innerHTML = modalContent;
                
                const modal = new bootstrap.Modal(document.getElementById('sheetModal'));
                modal.show();
            }
        }
        
        // Load selected sheet
        function loadSelectedSheet() {
            const selectedSheet = document.querySelector('input[name="sheetSelect"]:checked').value;
            const modal = bootstrap.Modal.getInstance(document.getElementById('sheetModal'));
            modal.hide();
            loadSheetData(currentWorkbook, selectedSheet);
        }
        
        // Load sheet data
        function loadSheetData(workbook, sheetName) {
            try {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                
                if (!jsonData || jsonData.length === 0 || (jsonData.length === 1 && jsonData[0].length === 0)) {
                    alert('Selected sheet is empty. Please choose another sheet.');
                    return;
                }
                
                if (jsonData.length > 10000) {
                    alert('File exceeds 10,000 row limit. Please use a smaller file.');
                    return;
                }
                
                excelData = jsonData;
                showDataPreview(jsonData);
                
            } catch (error) {
                alert('Error loading sheet data: ' + error.message);
            }
        }
        
        // Show data preview
        function showDataPreview(data) {
            if (!data || data.length === 0) return;
            
            const previewTable = document.getElementById('previewTable');
            const previewCard = document.getElementById('previewCard');
            const uploadCard = document.getElementById('uploadCard');
            
            previewTable.innerHTML = '';
            validationErrors = [];
            
            const previewRows = Math.min(15, data.length);
            
            const headerRow = document.createElement('tr');
            for (let j = 0; j < data[0].length; j++) {
                const th = document.createElement('th');
                th.textContent = data[0][j] || `Column ${j+1}`;
                th.title = `Column ${j+1}`;
                headerRow.appendChild(th);
            }
            previewTable.appendChild(headerRow);
            
            for (let i = 1; i < previewRows; i++) {
                const row = document.createElement('tr');
                
                for (let j = 0; j < data[i].length; j++) {
                    const cell = document.createElement('td');
                    cell.textContent = data[i][j] || '';
                    cell.title = `Row ${i+1}, Col ${j+1}`;
                    row.appendChild(cell);
                }
                
                previewTable.appendChild(row);
            }
            
            document.getElementById('rowCount').textContent = `${data.length} rows`;
            document.getElementById('colCount').textContent = `${data[0] ? data[0].length : 0} columns`;
            document.getElementById('errorCount').textContent = '0 errors';
            
            uploadCard.style.display = 'none';
            previewCard.style.display = 'block';
            previewCard.scrollIntoView({ behavior: 'smooth' });
            
            updateStepIndicator(2);
            validateData();
        }
        
        // Parse pasted data
        function parsePastedData() {
            const pasteData = document.getElementById('excelPaste').value;
            if (!pasteData.trim()) {
                alert('Please paste some data first');
                return;
            }
            
            try {
                const rows = [];
                const lines = pasteData.split('\n');
                
                lines.forEach(line => {
                    const cells = line.split(',').map(cell => {
                        cell = cell.trim();
                        if (cell.startsWith('"') && cell.endsWith('"')) {
                            cell = cell.substring(1, cell.length - 1);
                        }
                        return cell;
                    });
                    rows.push(cells);
                });
                
                if (rows.length > 10000) {
                    alert('Pasted data exceeds 10,000 row limit. Please paste smaller data.');
                    return;
                }
                
                excelData = rows;
                showDataPreview(rows);
                
            } catch (error) {
                alert('Error parsing pasted data: ' + error.message);
            }
        }
        
        // Validate data - STRICT DATE FORMAT
        function validateData() {
            if (!excelData || excelData.length < 2) {
                alert('No data to validate');
                return;
            }
            
            validationErrors = [];
            const headers = excelData[0];
            
            const dataType = document.getElementById('dataType').value;
            const requiredFields = fieldOptionsData[dataType].filter(f => f.required).map(f => f.value);
            
            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                const rowErrors = [];
                
                requiredFields.forEach(field => {
                    const colIndex = headers.findIndex(h => 
                        h && h.toString().toLowerCase().includes(field.toLowerCase())
                    );
                    if (colIndex !== -1 && (!row[colIndex] || row[colIndex].toString().trim() === '')) {
                        rowErrors.push(`Missing ${field} in row ${i+1}`);
                    }
                });
                
                const towerIndex = headers.findIndex(h => 
                    h && h.toString().toLowerCase().includes('tower')
                );
                if (towerIndex !== -1 && row[towerIndex]) {
                    const tower = row[towerIndex].toString().toUpperCase();
                    if (!['A', 'B', 'C'].includes(tower)) {
                        rowErrors.push(`Invalid tower value '${tower}' in row ${i+1}. Must be A, B, or C.`);
                    }
                }
                
                const flatIndex = headers.findIndex(h => 
                    h && h.toString().toLowerCase().includes('flat')
                );
                if (flatIndex !== -1 && row[flatIndex]) {
                    const flat = row[flatIndex].toString();
                    if (!/^\d+$/.test(flat)) {
                        rowErrors.push(`Invalid flat number '${flat}' in row ${i+1}. Must be numeric.`);
                    }
                }
                
                headers.forEach((header, index) => {
                    if (header && header.toString().toLowerCase().includes('date') && row[index]) {
                        const dateStr = row[index].toString();
                        if (!isValidDate(dateStr)) {
                            rowErrors.push(`Invalid date format '${dateStr}' in row ${i+1}, column '${header}'. Use DD.MM.YYYY (e.g., 01.01.2025) or DD.MM.YYYY HH:MM.`);
                        }
                    }
                });
                
                if (rowErrors.length > 0) {
                    validationErrors.push({
                        row: i + 1,
                        errors: rowErrors
                    });
                }
            }
            
            updateValidationUI();
        }
        
        // Check if date is valid - STRICTLY DD.MM.YYYY or DD.MM.YYYY HH:MM
        function isValidDate(dateString) {
            // Check for DD.MM.YYYY
            const format1 = /^\d{2}\.\d{2}\.\d{4}$/;
            // Check for DD.MM.YYYY HH:MM
            const format2 = /^\d{2}\.\d{2}\.\d{4} \d{1,2}:\d{2}$/;
            
            return format1.test(dateString) || format2.test(dateString);
        }
        
        // Update validation UI
        function updateValidationUI() {
            const errorCount = validationErrors.length;
            const errorElement = document.getElementById('errorCount');
            const validationAlert = document.getElementById('validationAlert');
            const errorList = document.getElementById('errorList');
            
            errorElement.textContent = `${errorCount} errors`;
            
            if (errorCount === 0) {
                errorElement.className = 'badge bg-success';
                validationAlert.className = 'alert alert-success';
                validationAlert.innerHTML = '<i class="fas fa-check-circle"></i> All data is valid!';
                validationAlert.style.display = 'block';
                errorList.style.display = 'none';
            } else {
                errorElement.className = 'badge bg-danger';
                validationAlert.className = 'alert alert-danger';
                validationAlert.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Found ${errorCount} rows with errors. Please review before importing.`;
                validationAlert.style.display = 'block';
                
                let errorHTML = '<h6>Error Details:</h6><ul class="mb-0">';
                validationErrors.slice(0, 10).forEach(error => {
                    error.errors.forEach(err => {
                        errorHTML += `<li>${err}</li>`;
                    });
                });
                if (validationErrors.length > 10) {
                    errorHTML += `<li>... and ${validationErrors.length - 10} more errors</li>`;
                }
                errorHTML += '</ul>';
                
                errorList.innerHTML = errorHTML;
                errorList.style.display = 'block';
                highlightValidationErrors();
            }
        }
        
        // Highlight validation errors in preview table
        function highlightValidationErrors() {
            const table = document.getElementById('previewTable');
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                row.classList.remove('validation-error', 'validation-success');
            });
            
            validationErrors.forEach(error => {
                if (error.row <= rows.length) {
                    rows[error.row].classList.add('validation-error');
                }
            });
        }
        
        // Setup column mapping
        function setupColumnMapping() {
            if (!excelData || excelData.length < 1) return;
            
            if (validationErrors.length > 0) {
                if (!confirm('There are validation errors. Do you want to continue anyway?')) {
                    return;
                }
            }
            
            const headers = excelData[0];
            const mappingDiv = document.getElementById('columnMapping');
            const mappingCard = document.getElementById('mappingCard');
            const previewCard = document.getElementById('previewCard');
            
            columnMapping = {};
            
            let html = '<h6>Map Excel Columns:</h6>';
            
            headers.forEach((header, index) => {
                const field = fieldOptions.find(f => 
                    f.value && header && header.toString().toLowerCase().includes(f.value.toLowerCase())
                );
                const defaultValue = field ? field.value : '';
                
                html += `
                    <div class="mapping-row">
                        <div class="excel-col">
                            <small>Excel:</small><br>
                            <strong>${header || `Column ${index+1}`}</strong>
                        </div>
                        <div class="mapping-select">
                            <select class="form-select form-select-sm" id="map_${index}" 
                                    onchange="updateColumnMapping(${index}, this.value)">
                                ${fieldOptions.map(opt => 
                                    `<option value="${opt.value}" ${opt.value === defaultValue ? 'selected' : ''}>
                                        ${opt.label} ${opt.required ? '*' : ''}
                                    </option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                `;
            });
            
            mappingDiv.innerHTML = html;
            
            headers.forEach((header, index) => {
                const field = fieldOptions.find(f => 
                    f.value && header && header.toString().toLowerCase().includes(f.value.toLowerCase())
                );
                if (field) {
                    columnMapping[index] = field.value;
                }
            });
            
            previewCard.style.display = 'none';
            mappingCard.style.display = 'block';
            mappingCard.scrollIntoView({ behavior: 'smooth' });
            
            updateStepIndicator(3);
        }
        
        // Update column mapping
        function updateColumnMapping(columnIndex, fieldName) {
            columnMapping[columnIndex] = fieldName;
        }
        
        // Back to preview
        function backToPreview() {
            document.getElementById('mappingCard').style.display = 'none';
            document.getElementById('previewCard').style.display = 'block';
            updateStepIndicator(2);
        }
        
        // Start import
        function startImport() {
            if (!excelData || excelData.length < 2) {
                alert('No data to import');
                return;
            }
            
            const dataType = document.getElementById('dataType').value;
            const requiredFields = fieldOptionsData[dataType].filter(f => f.required).map(f => f.value);
            const mappedColumns = Object.values(columnMapping);
            
            const missingRequired = requiredFields.filter(field => !mappedColumns.includes(field));
            if (missingRequired.length > 0) {
                alert(`Missing required field mappings: ${missingRequired.join(', ')}`);
                return;
            }
            
            document.getElementById('mappingCard').style.display = 'none';
            document.getElementById('progressCard').style.display = 'block';
            document.getElementById('progressCard').scrollIntoView({ behavior: 'smooth' });
            
            updateStepIndicator(4);
            
            startImportProcess();
        }
        
        // Start import process - UPDATED with Google Apps Script
        async function startImportProcess() {
            if (!excelData || excelData.length < 2) return;
            
            isImporting = true;
            importCanceled = false;
            
            const dataType = document.getElementById('dataType').value;
            const importStrategy = document.getElementById('importStrategy').value;
            const syncToCloud = document.getElementById('syncToCloud').checked;
            const skipHeader = true;
            const startRow = skipHeader ? 1 : 0;
            const totalRows = excelData.length - startRow;
            
            let processedRows = 0;
            let importedCount = 0;
            let skippedCount = 0;
            let errorCount = 0;
            
            const importLogDiv = document.getElementById('importLog');
            importLogDiv.innerHTML = '';
            
            document.getElementById('cancelBtn').style.display = 'inline-block';
            
            for (let i = startRow; i < excelData.length; i++) {
                if (importCanceled) {
                    logImport('Import canceled by user', 'warning');
                    break;
                }
                
                processedRows++;
                const percent = Math.round((processedRows / totalRows) * 100);
                
                document.getElementById('importProgress').style.width = `${percent}%`;
                document.getElementById('importPercent').textContent = `${percent}%`;
                document.getElementById('importStatus').textContent = `Processing row ${processedRows} of ${totalRows}`;
                
                const row = excelData[i];
                const rowData = { processStep: dataType };
                
                Object.keys(columnMapping).forEach(colIndex => {
                    if (columnMapping[colIndex] && row[colIndex]) {
                        rowData[columnMapping[colIndex]] = row[colIndex];
                    }
                });
                
                const result = await importRowData(rowData, i + 1, importStrategy, syncToCloud);
                
                if (result.success) {
                    importedCount++;
                } else if (result.skipped) {
                    skippedCount++;
                } else {
                    errorCount++;
                }
                
                document.getElementById('importedCount').textContent = importedCount;
                document.getElementById('skippedCount').textContent = skippedCount;
                document.getElementById('errorImportCount').textContent = errorCount;
                
                const logEntry = document.createElement('div');
                logEntry.className = result.success ? 'log-success' : 
                                   result.skipped ? 'log-warning' : 'log-error';
                logEntry.textContent = `Row ${i + 1}: ${result.message}`;
                importLogDiv.appendChild(logEntry);
                importLogDiv.scrollTop = importLogDiv.scrollHeight;
                
                // Small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            isImporting = false;
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('completeBtn').style.display = 'inline-block';
            
            const finalLog = document.createElement('div');
            finalLog.className = 'log-success';
            finalLog.innerHTML = `<strong>Import Complete:</strong> ${importedCount} imported, ${skippedCount} skipped, ${errorCount} failed`;
            importLogDiv.appendChild(finalLog);
            
            document.getElementById('importStatus').textContent = 'Import Complete';
            document.getElementById('importProgress').className = 'progress-bar bg-success';
            
            // Update pending import count
            updatePendingImportCount();
        }
        
        // Import single row of data - UPDATED with Google Apps Script
        async function importRowData(rowData, rowNumber, strategy, syncToCloud) {
            try {
                const dataType = rowData.processStep;
                const requiredFields = fieldOptionsData[dataType].filter(f => f.required).map(f => f.value);
                
                for (const field of requiredFields) {
                    if (!rowData[field]) {
                        return {
                            success: false,
                            skipped: false,
                            message: `Missing required field: ${field}`
                        };
                    }
                }
                
                if (rowData.tower && !['A', 'B', 'C'].includes(rowData.tower.toUpperCase())) {
                    return {
                        success: false,
                        skipped: false,
                        message: `Invalid tower: ${rowData.tower}`
                    };
                }
                
                if (rowData.flat && !/^\d+$/.test(rowData.flat.toString())) {
                    return {
                        success: false,
                        skipped: false,
                        message: `Invalid flat number: ${rowData.flat}`
                    };
                }
                
                // Prepare data for Google Apps Script
                const dataForCloud = {
                    id: `${rowData.tower}_${rowData.flat}_${dataType}_${Date.now()}`,
                    tower: rowData.tower.toUpperCase(),
                    flatNumber: rowData.flat.toString(),
                    processStep: dataType,
                    stepData: { ...rowData },
                    createdBy: deviceId,
                    updatedBy: deviceId,
                    importDate: new Date().toISOString()
                };
                
                delete dataForCloud.stepData.processStep;
                delete dataForCloud.stepData.tower;
                delete dataForCloud.stepData.flat;
                
                if (syncToCloud && isOnline) {
                    const result = await saveToGoogleAppsScript(dataForCloud);
                    if (!result.success && !result.local) {
                        return {
                            success: false,
                            skipped: false,
                            message: `Cloud save failed: ${result.error}`
                        };
                    }
                }
                
                if (!syncToCloud || !isOnline) {
                    saveToLocalStorage(dataForCloud);
                    
                    if (syncToCloud && !isOnline) {
                        queueForCloudSync(dataForCloud);
                        return {
                            success: true,
                            skipped: false,
                            message: `Saved locally (offline). Queued for cloud sync.`
                        };
                    }
                }
                
                return {
                    success: true,
                    skipped: false,
                    message: `Imported ${dataType} for Tower ${rowData.tower} - Flat ${rowData.flat}`
                };
                
            } catch (error) {
                return {
                    success: false,
                    skipped: false,
                    message: `Error: ${error.message}`
                };
            }
        }
        
        // Save to Google Apps Script - NEW FUNCTION
        async function saveToGoogleAppsScript(data) {
            if (!isOnline) {
                queueForCloudSync(data);
                return { success: true, message: 'Queued for cloud sync (offline)', local: true };
            }
            
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                return result;
                
            } catch (error) {
                console.error('Error saving to Google Apps Script:', error);
                queueForCloudSync(data);
                return { success: false, error: error.message, local: true };
            }
        }
        
        // Save to local storage - NEW FUNCTION
        function saveToLocalStorage(data) {
            let hotData = JSON.parse(localStorage.getItem('hot_process_data') || '{"towers":{"A":{"flats":{}},"B":{"flats":{}},"C":{"flats":{}}}}');
            const tower = data.tower;
            const flatId = `${tower}-${data.flatNumber}`;
            
            if (!hotData.towers[tower]) {
                hotData.towers[tower] = { flats: {} };
            }
            
            hotData.towers[tower].flats[flatId] = data;
            localStorage.setItem('hot_process_data', JSON.stringify(hotData));
        }
        
        // Queue for cloud sync - NEW FUNCTION
        function queueForCloudSync(data) {
            let pendingImports = JSON.parse(localStorage.getItem('hot_pending_imports') || '[]');
            pendingImports.push({
                data: data,
                timestamp: new Date().toISOString(),
                device: deviceId
            });
            localStorage.setItem('hot_pending_imports', JSON.stringify(pendingImports));
            updatePendingImportCount();
        }
        
        // Log import message
        function logImport(message, type) {
            const importLogDiv = document.getElementById('importLog');
            const logEntry = document.createElement('div');
            logEntry.className = type === 'success' ? 'log-success' : 
                               type === 'warning' ? 'log-warning' : 'log-error';
            logEntry.textContent = message;
            importLogDiv.appendChild(logEntry);
            importLogDiv.scrollTop = importLogDiv.scrollHeight;
        }
        
        // Cancel import
        function cancelImport() {
            if (confirm('Are you sure you want to cancel the import?')) {
                importCanceled = true;
                isImporting = false;
                logImport('Import canceled by user', 'warning');
                document.getElementById('cancelBtn').style.display = 'none';
                document.getElementById('completeBtn').style.display = 'inline-block';
            }
        }
        
        // Import complete
        function importComplete() {
            const importedCount = parseInt(document.getElementById('importedCount').textContent);
            const skippedCount = parseInt(document.getElementById('skippedCount').textContent);
            const errorCount = parseInt(document.getElementById('errorImportCount').textContent);
            
            let message = `Import completed: ${importedCount} imported`;
            if (skippedCount > 0) message += `, ${skippedCount} skipped`;
            if (errorCount > 0) message += `, ${errorCount} errors`;
            
            alert(message);
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }
        
        // Download template
        function downloadTemplate(type) {
            let templateData = [];
            let filename = '';
            
            switch(type) {
                case 'key_handover':
                    templateData = [
                        ['Tower', 'Flat', 'Person', 'Date', 'IncompleteKeys', 'Remarks', 'Status'],
                        ['A', '1503', 'John Doe', '01.01.2025', 'NO', 'All keys received', 'completed'],
                        ['B', '2207', 'Jane Smith', '02.01.2025', 'YES', 'Missing main door key', 'completed'],
                        ['C', '0905', 'Mike Johnson', '03.01.2025', 'NO', 'All keys handed over', 'completed']
                    ];
                    filename = 'key_handover_template.xlsx';
                    break;
                    
                case 'snagging':
                    templateData = [
                        ['Tower', 'Flat', 'Inspector', 'StartDate', 'EndDate', 'FollowupDate', 'MepCompleted', 'CivilCompleted', 'ElectricalCompleted', 'WaterCompleted', 'AcDrainCompleted', 'TilesCompleted', 'Remarks', 'Status'],
                        ['A', '1503', 'Mike Johnson', '01.01.2025', '08.01.2025', '11.01.2025', 'YES', 'YES', 'NO', 'YES', 'YES', 'YES', 'Electrical pending', 'completed']
                    ];
                    filename = 'snagging_template.xlsx';
                    break;
                    
                case 'first_visit':
                    templateData = [
                        ['Tower', 'Flat', 'OwnerName', 'OwnerPhone', 'Date', 'HotMember', 'HandoverSuggested', 'Remarks', 'CrmNOC', 'Status'],
                        ['B', '2207', 'Robert Brown', '9876543210', '01.01.2025 14:30', 'Alex Chen', '06.01.2025 10:00', 'Customer satisfied', 'YES', 'completed']
                    ];
                    filename = 'first_visit_template.xlsx';
                    break;
                    
                case 'handover':
                    templateData = [
                        ['Tower', 'Flat', 'CustomerName', 'SecondOwner', 'OwnerEmail', 'SecondOwnerEmail', 'HotoMember', 'Date', 'KeysHanded', 'ManualHanded', 'GiftBoxHanded', 'Feedback', 'Status'],
                        ['A', '1503', 'Robert Brown', '', 'robert@email.com', '', 'Alex Chen', '06.01.2025 10:00', 'YES', 'YES', 'YES', 'Very satisfied', 'completed']
                    ];
                    filename = 'handover_template.xlsx';
                    break;
                    
                case 'interiors':
                    templateData = [
                        ['Tower', 'Flat', 'StartDate', 'EndDate', 'ContractorName', 'ContractorContact', 'ClearanceBy', 'Flooring', 'Painting', 'Carpentry', 'Electrical', 'Plumbing', 'FalseCeiling', 'Remarks', 'Status'],
                        ['A', '1503', '01.01.2025', '01.02.2025', 'Elite Interiors', '9876543210', 'Alex Chen', 'YES', 'YES', 'YES', 'NO', 'YES', 'NO', 'Electrical work separately', 'started']
                    ];
                    filename = 'interior_work_template.xlsx';
                    break;
                    
                case 'movein':
                    templateData = [
                        ['Tower', 'Flat', 'CustomerName', 'Date', 'ContactNumber', 'Remarks', 'Status'],
                        ['A', '1503', 'Robert Brown', '01.01.2025 10:00', '9876543210', 'All furniture moved in', 'completed']
                    ];
                    filename = 'movein_template.xlsx';
                    break;
            }
            
            const worksheet = XLSX.utils.aoa_to_sheet(templateData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Template');
            XLSX.writeFile(workbook, filename);
            
            logImport(`Template downloaded: ${filename}`, 'success');
        }
        
        // Show notification - NEW FUNCTION
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show`;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
