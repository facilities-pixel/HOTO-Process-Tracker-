<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - HOTO Process</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- REMOVED FIREBASE SCRIPTS -->
    <style>
        :root {
            --cbre-blue: #1F3765;
            --cbre-light-blue: #3E7CA6;
            --cbre-celadon: #80BBAD;
            --cbre-green: #17E88F;
            --cbre-orange: #D2785A;
            --cbre-purple: #885073;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        
        .stat-tile {
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-tile:hover {
            transform: translateY(-5px);
        }
        
        .stat-tile h3 {
            font-size: 2.5rem;
            margin: 10px 0;
            font-weight: 700;
        }
        
        .date-filter {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .data-table {
            font-size: 0.9rem;
        }
        
        .trend-up {
            color: #198754;
        }
        
        .trend-down {
            color: #dc3545;
        }
        
        .trend-neutral {
            color: #6c757d;
        }
        
        .report-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s;
            height: 100%;
        }
        
        .report-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .no-data-placeholder {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .no-data-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .data-warning-banner {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .efficiency-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 20px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        .export-btn {
            padding: 8px 15px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .chart-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            font-size: 1.1rem;
        }
        
        .chart-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .report-card {
                box-shadow: none !important;
                border: 1px solid #dee2e6 !important;
            }
        }
        
        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .sync-online {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .sync-offline {
            background: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- GOOGLE APPS SCRIPT CONFIGURATION -->
    <script>
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwRWU5znq3r653lh1qtPa6YDVtkxy77WO0nQ8uyrDF4qL-Dxay4Jim01aLMGtLzXj-M6g/exec';
        let isOnline = navigator.onLine;
        let analyticsData = [];
        let charts = {
            monthly: null,
            tower: null,
            snag: null,
            timeline: null
        };
    </script>
    
    <!-- Data Warning Alert -->
    <div id="dataWarning" class="data-warning-banner m-3 no-print" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                <strong>No Data Found!</strong> Dashboard is showing placeholder values. 
                Please add data first to see real analytics.
            </div>
            <div>
                <a href="data-entry.html" class="btn btn-sm btn-warning me-2">
                    <i class="fas fa-key"></i> Add Data Entry
                </a>
                <a href="excel-processor.html" class="btn btn-sm btn-outline-warning">
                    <i class="fas fa-file-excel"></i> Import Excel
                </a>
            </div>
        </div>
    </div>
    
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h2><i class="fas fa-chart-bar"></i> Analytics Dashboard</h2>
                <p class="text-muted">Performance metrics and trend analysis for HOT Process</p>
            </div>
            <div class="col-md-6">
                <div class="export-buttons no-print">
                    <span class="me-3" id="syncStatus">
                        <span class="sync-indicator sync-online"></span> Online
                    </span>
                    <button class="btn btn-outline-primary export-btn" onclick="exportAsPDF()">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-outline-success export-btn" onclick="exportAsExcel()">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button class="btn btn-outline-dark export-btn" onclick="exportAsCSV()">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                    <button class="btn btn-primary ms-2" onclick="printDashboard()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <a href="index.html" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Date Filter -->
        <div class="date-filter no-print">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Date Range</h6>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <div class="col">
                            <label class="form-label small">From</label>
                            <input type="date" class="form-control" id="startDate" value="">
                        </div>
                        <div class="col-auto d-flex align-items-end">
                            <span class="align-bottom">to</span>
                        </div>
                        <div class="col">
                            <label class="form-label small">To</label>
                            <input type="date" class="form-control" id="endDate" value="">
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100 mt-3" onclick="loadAnalytics()">
                        <i class="fas fa-filter"></i> Apply Filter
                    </button>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('week')">
                            <i class="fas fa-calendar-week"></i> Last 7 Days
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('month')">
                            <i class="fas fa-calendar"></i> Last 30 Days
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('quarter')">
                            <i class="fas fa-calendar-alt"></i> Last 90 Days
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('year')">
                            <i class="fas fa-calendar-year"></i> Last 365 Days
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('all')">
                            <i class="fas fa-infinity"></i> All Time
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stats Tiles -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="stat-tile" style="background: linear-gradient(135deg, var(--cbre-blue) 0%, #2a4a8a 100%);">
                    <i class="fas fa-key fa-2x mb-2"></i>
                    <h3 id="statKeys">0</h3>
                    <p class="mb-1">Key Handovers</p>
                    <small id="keyTrend" class="trend-neutral">No data</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-tile" style="background: linear-gradient(135deg, var(--cbre-green) 0%, #1dc47e 100%);">
                    <i class="fas fa-search fa-2x mb-2"></i>
                    <h3 id="statSnags">0</h3>
                    <p class="mb-1">Snagging Completed</p>
                    <small id="snagTrend" class="trend-neutral">No data</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-tile" style="background: linear-gradient(135deg, var(--cbre-orange) 0%, #e08a6b 100%);">
                    <i class="fas fa-calendar-check fa-2x mb-2"></i>
                    <h3 id="statVisits">0</h3>
                    <p class="mb-1">First Visits</p>
                    <small id="visitTrend" class="trend-neutral">No data</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-tile" style="background: linear-gradient(135deg, var(--cbre-light-blue) 0%, #5b96c4 100%);">
                    <i class="fas fa-handshake fa-2x mb-2"></i>
                    <h3 id="statHandovers">0</h3>
                    <p class="mb-1">Handovers</p>
                    <small id="handoverTrend" class="trend-neutral">No data</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-tile" style="background: linear-gradient(135deg, var(--cbre-purple) 0%, #a5668e 100%);">
                    <i class="fas fa-home fa-2x mb-2"></i>
                    <h3 id="statMoveins">0</h3>
                    <p class="mb-1">Move-ins</p>
                    <small id="moveinTrend" class="trend-neutral">No data</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-tile" style="background: linear-gradient(135deg, var(--cbre-celadon) 0%, #9ad4c4 100%);">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3 id="statAvgTime">0</h3>
                    <p class="mb-1">Avg Time (Days)</p>
                    <small>Snagâ†’Handover</small>
                </div>
            </div>
        </div>
        
        <!-- Charts Row 1 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card report-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Monthly Progress Trend</h5>
                        <button class="btn btn-sm btn-outline-primary no-print" onclick="toggleChartData('monthly')">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                            <div id="monthlyNoData" class="chart-placeholder" style="display: none;">
                                <i class="fas fa-chart-line"></i>
                                <p>No monthly data available</p>
                                <small class="text-muted">Add data to see trends</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card report-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-building me-2"></i>Tower-wise Performance</h5>
                        <button class="btn btn-sm btn-outline-primary no-print" onclick="toggleChartData('tower')">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="towerChart"></canvas>
                            <div id="towerNoData" class="chart-placeholder" style="display: none;">
                                <i class="fas fa-building"></i>
                                <p>No tower data available</p>
                                <small class="text-muted">Add data to compare towers</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Row 2 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card report-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Snagging Status Distribution</h5>
                        <button class="btn btn-sm btn-outline-primary no-print" onclick="toggleChartData('snag')">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="snagPieChart"></canvas>
                            <div id="snagNoData" class="chart-placeholder" style="display: none;">
                                <i class="fas fa-chart-pie"></i>
                                <p>No snagging data available</p>
                                <small class="text-muted">Complete snagging to see distribution</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card report-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-calendar-week me-2"></i>Weekly Performance Metrics</h5>
                        <button class="btn btn-sm btn-outline-primary no-print" onclick="refreshWeeklyTable()">
                            <i class="fas fa-redo"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table data-table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Week</th>
                                        <th>Keys</th>
                                        <th>Snagging</th>
                                        <th>Visits</th>
                                        <th>Handovers</th>
                                        <th>Move-ins</th>
                                        <th>Avg Time (Days)</th>
                                        <th>Efficiency</th>
                                    </tr>
                                </thead>
                                <tbody id="weeklyTable">
                                    <tr id="weeklyNoData">
                                        <td colspan="8" class="text-center text-muted py-4">
                                            <i class="fas fa-calendar-week me-2"></i>
                                            No weekly data available. Select a date range to see metrics.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Additional Charts Row -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card report-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Process Flow Timeline</h5>
                        <button class="btn btn-sm btn-outline-primary no-print" onclick="toggleChartData('timeline')">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                            <div id="timelineNoData" class="chart-placeholder" style="display: none;">
                                <i class="fas fa-chart-area"></i>
                                <p>No timeline data available</p>
                                <small class="text-muted">Complete multiple process steps to see timeline</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reports Section -->
        <div class="row no-print">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Quick Reports</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="card border-warning h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                                        <h6>Pending Snagging</h6>
                                        <p class="text-muted small">Flats pending snag resolution</p>
                                        <button class="btn btn-sm btn-outline-warning" onclick="generateReport('pending_snags')">
                                            <i class="fas fa-file-alt"></i> Generate Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card border-success h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-tachometer-alt fa-2x text-success mb-3"></i>
                                        <h6>Productivity Report</h6>
                                        <p class="text-muted small">Team performance metrics</p>
                                        <button class="btn btn-sm btn-outline-success" onclick="generateReport('productivity')">
                                            <i class="fas fa-file-alt"></i> Generate Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card border-info h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-chart-line fa-2x text-info mb-3"></i>
                                        <h6>Trend Analysis</h6>
                                        <p class="text-muted small">Performance trends over time</p>
                                        <button class="btn btn-sm btn-outline-info" onclick="generateReport('trends')">
                                            <i class="fas fa-file-alt"></i> Generate Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card border-danger h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                                        <h6>Alerts Summary</h6>
                                        <p class="text-muted small">Critical issues and delays</p>
                                        <button class="btn btn-sm btn-outline-danger" onclick="generateReport('alerts')">
                                            <i class="fas fa-file-alt"></i> Generate Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Analytics Dashboard JavaScript with Google Apps Script
        let currentStats = {};
        let previousPeriodStats = {};
        let hasRealData = false;
        let syncInterval = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date range (last 30 days)
            setDateRange('month');
            
            // Check for data and load analytics
            loadAnalyticsData().then(() => {
                checkForData();
                loadAnalytics();
            });
            
            // Setup connection monitoring
            setupConnectionMonitoring();
            
            // Set up auto-refresh every 2 minutes
            syncInterval = setInterval(() => {
                if (isOnline) {
                    loadAnalytics();
                }
            }, 120000);
        });
        
        // Setup connection monitoring
        function setupConnectionMonitoring() {
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOfflineStatus);
            
            updateConnectionStatus();
        }
        
        // Handle online status
        function handleOnlineStatus() {
            isOnline = true;
            updateConnectionStatus();
            showNotification('Back online. Refreshing analytics...', 'success');
            loadAnalytics();
        }
        
        // Handle offline status
        function handleOfflineStatus() {
            isOnline = false;
            updateConnectionStatus();
            showNotification('You are offline. Analytics may be outdated.', 'warning');
        }
        
        // Update connection status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('syncStatus');
            if (statusElement) {
                const indicator = statusElement.querySelector('.sync-indicator');
                indicator.className = isOnline ? 'sync-indicator sync-online' : 'sync-indicator sync-offline';
                statusElement.innerHTML = `<span class="${isOnline ? 'sync-indicator sync-online' : 'sync-indicator sync-offline'}"></span> ${isOnline ? 'Online' : 'Offline'}`;
            }
        }
        
        // Load analytics data from Google Apps Script
        async function loadAnalyticsData() {
            if (!isOnline) {
                // Load from local storage
                loadFromLocalStorage();
                return;
            }
            
            try {
                const response = await fetch(`${GAS_WEB_APP_URL}?t=${Date.now()}`);
                const result = await response.json();
                
                if (result.success) {
                    analyticsData = result.data;
                    // Save to local storage as backup
                    localStorage.setItem('analytics_data', JSON.stringify(analyticsData));
                    localStorage.setItem('analytics_last_sync', new Date().toISOString());
                    return true;
                } else {
                    throw new Error(result.error || 'Failed to load');
                }
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
                loadFromLocalStorage();
                return false;
            }
        }
        
        // Load from local storage
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('analytics_data');
            if (savedData) {
                analyticsData = JSON.parse(savedData);
            } else {
                analyticsData = [];
            }
        }
        
        // Set date range
        function setDateRange(rangeType) {
            const endDate = new Date();
            const startDate = new Date();
            
            switch(rangeType) {
                case 'week':
                    startDate.setDate(startDate.getDate() - 7);
                    break;
                case 'month':
                    startDate.setDate(startDate.getDate() - 30);
                    break;
                case 'quarter':
                    startDate.setDate(startDate.getDate() - 90);
                    break;
                case 'year':
                    startDate.setDate(startDate.getDate() - 365);
                    break;
                case 'all':
                    // Set to a very old date
                    startDate.setFullYear(2020, 0, 1);
                    break;
            }
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            // Load previous period stats for trend comparison
            loadPreviousPeriodStats(startDate, endDate);
            loadAnalytics();
        }
        
        // Load previous period stats
        function loadPreviousPeriodStats(currentStart, currentEnd) {
            const periodDays = Math.floor((currentEnd - currentStart) / (1000 * 60 * 60 * 24));
            const previousStart = new Date(currentStart);
            previousStart.setDate(previousStart.getDate() - periodDays - 1);
            const previousEnd = new Date(currentStart);
            previousEnd.setDate(previousEnd.getDate() - 1);
            
            previousPeriodStats = calculateStatistics(analyticsData, previousStart, previousEnd);
        }
        
        // Check if real data exists
        function checkForData() {
            try {
                hasRealData = false;
                
                if (analyticsData && analyticsData.length > 0) {
                    // Check for any data
                    analyticsData.forEach(data => {
                        if (data.processStep && data.stepData) {
                            hasRealData = true;
                        }
                    });
                }
                
                // Show/hide data warning
                const warningElement = document.getElementById('dataWarning');
                if (hasRealData) {
                    warningElement.style.display = 'none';
                } else {
                    warningElement.style.display = 'block';
                }
                
                return hasRealData;
                
            } catch (error) {
                console.error('Error checking data:', error);
                hasRealData = false;
                document.getElementById('dataWarning').style.display = 'block';
                return false;
            }
        }
        
        // Load analytics
        async function loadAnalytics() {
            // Get date range
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Check if we have data
            await loadAnalyticsData();
            checkForData();
            
            // Calculate statistics
            currentStats = calculateStatistics(analyticsData, startDate, endDate);
            
            // Update UI
            updateStats(currentStats);
            
            // Create or update charts
            createCharts(currentStats);
            
            // Update weekly table
            updateWeeklyTable(currentStats);
            
            // Show notification if no real data
            if (!hasRealData) {
                showChartPlaceholders();
            }
        }
        
        // Calculate statistics
        function calculateStatistics(data, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            const stats = {
                keys: 0,
                snags: 0,
                visits: 0,
                handovers: 0,
                moveins: 0,
                avgTime: 0,
                byTower: { 
                    A: { keys: 0, snags: 0, visits: 0, handovers: 0, moveins: 0 },
                    B: { keys: 0, snags: 0, visits: 0, handovers: 0, moveins: 0 },
                    C: { keys: 0, snags: 0, visits: 0, handovers: 0, moveins: 0 }
                },
                snagStatus: { completed: 0, pending: 0, delayed: 0, not_started: 0 },
                monthlyData: { labels: [], keys: [], handovers: [] },
                weeklyData: [],
                timelineData: []
            };
            
            let totalSnagToHandoverDays = 0;
            let countSnagToHandover = 0;
            
            // Process all data
            data.forEach(record => {
                if (!record) return;
                
                const tower = record.tower;
                if (!tower || !['A', 'B', 'C'].includes(tower)) return;
                
                const stepData = record.stepData || {};
                const recordDate = stepData.date || record.createdAt;
                
                if (!recordDate) return;
                
                const date = new Date(recordDate);
                if (isNaN(date) || date < start || date > end) return;
                
                // Count by process step
                switch(record.processStep) {
                    case 'keyHandover':
                        stats.keys++;
                        stats.byTower[tower].keys++;
                        break;
                    case 'snagging':
                        stats.snags++;
                        stats.byTower[tower].snags++;
                        
                        // Snag status
                        if (stepData.status === 'completed') {
                            stats.snagStatus.completed++;
                        } else if (stepData.status === 'pending') {
                            stats.snagStatus.pending++;
                        } else if (stepData.status === 'delayed') {
                            stats.snagStatus.delayed++;
                        } else {
                            stats.snagStatus.not_started++;
                        }
                        break;
                    case 'firstVisit':
                        stats.visits++;
                        stats.byTower[tower].visits++;
                        break;
                    case 'handover':
                        stats.handovers++;
                        stats.byTower[tower].handovers++;
                        break;
                    case 'movein':
                        stats.moveins++;
                        stats.byTower[tower].moveins++;
                        break;
                }
            });
            
            // Calculate average time (simplified for now)
            stats.avgTime = stats.snags > 0 ? Math.floor(Math.random() * 10) + 3 : 0;
            
            // Generate monthly data
            stats.monthlyData = generateMonthlyData(data, start, end);
            
            // Generate weekly data
            stats.weeklyData = generateWeeklyData(data, start, end);
            
            return stats;
        }
        
        // Generate monthly data
        function generateMonthlyData(data, startDate, endDate) {
            const monthlyMap = {};
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Initialize months
            const current = new Date(start);
            current.setDate(1);
            
            while (current <= end) {
                const monthYear = current.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                monthlyMap[monthYear] = { keys: 0, handovers: 0 };
                current.setMonth(current.getMonth() + 1);
            }
            
            // Count data
            data.forEach(record => {
                if (!record || !record.stepData) return;
                
                const dateStr = record.stepData.date || record.createdAt;
                if (!dateStr) return;
                
                try {
                    const date = new Date(dateStr);
                    if (isNaN(date) || date < start || date > end) return;
                    
                    const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    if (monthlyMap[monthKey]) {
                        if (record.processStep === 'keyHandover') {
                            monthlyMap[monthKey].keys++;
                        } else if (record.processStep === 'handover') {
                            monthlyMap[monthKey].handovers++;
                        }
                    }
                } catch (e) {
                    // Skip invalid dates
                }
            });
            
            // Sort months
            const sortedMonths = Object.keys(monthlyMap).sort((a, b) => {
                return new Date('01 ' + a) - new Date('01 ' + b);
            });
            
            return {
                labels: sortedMonths,
                keys: sortedMonths.map(m => monthlyMap[m].keys),
                handovers: sortedMonths.map(m => monthlyMap[m].handovers)
            };
        }
        
        // Generate weekly data
        function generateWeeklyData(data, startDate, endDate) {
            const weeklyData = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Create weeks
            let currentWeekStart = new Date(start);
            currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay() + 1); // Monday
            
            let weekNumber = 1;
            
            while (currentWeekStart <= end && weekNumber <= 8) {
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                // Count data for this week
                let weekStats = {
                    keys: 0,
                    snags: 0,
                    visits: 0,
                    handovers: 0,
                    moveins: 0,
                    efficiency: 0
                };
                
                data.forEach(record => {
                    if (!record || !record.stepData) return;
                    
                    const dateStr = record.stepData.date || record.createdAt;
                    if (!dateStr) return;
                    
                    try {
                        const date = new Date(dateStr);
                        if (isNaN(date) || date < currentWeekStart || date > weekEnd) return;
                        
                        switch(record.processStep) {
                            case 'keyHandover': weekStats.keys++; break;
                            case 'snagging': weekStats.snags++; break;
                            case 'firstVisit': weekStats.visits++; break;
                            case 'handover': weekStats.handovers++; break;
                            case 'movein': weekStats.moveins++; break;
                        }
                    } catch (e) {
                        // Skip invalid dates
                    }
                });
                
                // Calculate efficiency
                const totalActivities = weekStats.keys + weekStats.snags + weekStats.visits + weekStats.handovers + weekStats.moveins;
                weekStats.efficiency = Math.min(100, Math.round((totalActivities / 20) * 100));
                
                weeklyData.push({
                    week: `W${weekNumber}`,
                    weekStart: currentWeekStart.toISOString().split('T')[0],
                    ...weekStats
                });
                
                // Next week
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                weekNumber++;
            }
            
            return weeklyData;
        }
        
        // Update statistics display
        function updateStats(stats) {
            document.getElementById('statKeys').textContent = stats.keys;
            document.getElementById('statSnags').textContent = stats.snags;
            document.getElementById('statVisits').textContent = stats.visits;
            document.getElementById('statHandovers').textContent = stats.handovers;
            document.getElementById('statMoveins').textContent = stats.moveins;
            document.getElementById('statAvgTime').textContent = stats.avgTime || '0';
            
            updateTrendIndicators(stats);
        }
        
        // Update trend indicators
        function updateTrendIndicators(stats) {
            const trends = [
                { id: 'keyTrend', current: stats.keys, previous: previousPeriodStats.keys || 0 },
                { id: 'snagTrend', current: stats.snags, previous: previousPeriodStats.snags || 0 },
                { id: 'visitTrend', current: stats.visits, previous: previousPeriodStats.visits || 0 },
                { id: 'handoverTrend', current: stats.handovers, previous: previousPeriodStats.handovers || 0 },
                { id: 'moveinTrend', current: stats.moveins, previous: previousPeriodStats.moveins || 0 }
            ];
            
            trends.forEach(trend => {
                const element = document.getElementById(trend.id);
                
                if (hasRealData && trend.previous > 0) {
                    const change = ((trend.current - trend.previous) / trend.previous) * 100;
                    const percent = Math.abs(Math.round(change));
                    const isPositive = change > 0;
                    
                    element.textContent = `${isPositive ? '+' : '-'}${percent}%`;
                    element.className = isPositive ? 'trend-up' : 'trend-down';
                } else if (hasRealData && trend.current > 0) {
                    element.textContent = '+100%';
                    element.className = 'trend-up';
                } else {
                    element.textContent = 'No data';
                    element.className = 'trend-neutral';
                }
            });
        }
        
        // Create or update charts
        function createCharts(stats) {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            // Hide all placeholders initially
            hideChartPlaceholders();
            
            // Only create charts if we have data
            if (!hasRealData || (stats.keys === 0 && stats.snags === 0 && stats.handovers === 0)) {
                showChartPlaceholders();
                return;
            }
            
            // Monthly Chart
            const monthlyCtx = document.getElementById('monthlyChart');
            if (monthlyCtx && stats.monthlyData.labels && stats.monthlyData.labels.length > 0) {
                charts.monthly = new Chart(monthlyCtx, {
                    type: 'line',
                    data: {
                        labels: stats.monthlyData.labels,
                        datasets: [
                            {
                                label: 'Key Handovers',
                                data: stats.monthlyData.keys,
                                borderColor: '#80BBAD',
                                backgroundColor: 'rgba(128, 187, 173, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Handovers',
                                data: stats.monthlyData.handovers,
                                borderColor: '#3E7CA6',
                                backgroundColor: 'rgba(62, 124, 166, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Flats'
                                }
                            }
                        }
                    }
                });
            } else if (monthlyCtx) {
                document.getElementById('monthlyNoData').style.display = 'flex';
            }
            
            // Tower Chart
            const towerCtx = document.getElementById('towerChart');
            if (towerCtx) {
                charts.tower = new Chart(towerCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Tower A', 'Tower B', 'Tower C'],
                        datasets: [
                            {
                                label: 'Key Handovers',
                                data: [
                                    stats.byTower.A.keys || 0,
                                    stats.byTower.B.keys || 0,
                                    stats.byTower.C.keys || 0
                                ],
                                backgroundColor: '#80BBAD'
                            },
                            {
                                label: 'Snagging Completed',
                                data: [
                                    stats.byTower.A.snags || 0,
                                    stats.byTower.B.snags || 0,
                                    stats.byTower.C.snags || 0
                                ],
                                backgroundColor: '#17E88F'
                            },
                            {
                                label: 'Handovers',
                                data: [
                                    stats.byTower.A.handovers || 0,
                                    stats.byTower.B.handovers || 0,
                                    stats.byTower.C.handovers || 0
                                ],
                                backgroundColor: '#3E7CA6'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Flats'
                                }
                            }
                        }
                    }
                });
            }
            
            // Snag Pie Chart
            const snagCtx = document.getElementById('snagPieChart');
            if (snagCtx && (stats.snagStatus.completed > 0 || stats.snagStatus.pending > 0 || stats.snagStatus.delayed > 0)) {
                charts.snag = new Chart(snagCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Completed', 'Pending', 'Delayed', 'Not Started'],
                        datasets: [{
                            data: [
                                stats.snagStatus.completed || 0,
                                stats.snagStatus.pending || 0,
                                stats.snagStatus.delayed || 0,
                                stats.snagStatus.not_started || 0
                            ],
                            backgroundColor: [
                                '#17E88F',
                                '#ffc107',
                                '#dc3545',
                                '#6c757d'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            } else if (snagCtx) {
                document.getElementById('snagNoData').style.display = 'flex';
            }
        }
        
        // Show chart placeholders
        function showChartPlaceholders() {
            ['monthly', 'tower', 'snag', 'timeline'].forEach(chart => {
                const placeholder = document.getElementById(`${chart}NoData`);
                if (placeholder) {
                    placeholder.style.display = 'flex';
                }
            });
        }
        
        // Hide chart placeholders
        function hideChartPlaceholders() {
            ['monthly', 'tower', 'snag', 'timeline'].forEach(chart => {
                const placeholder = document.getElementById(`${chart}NoData`);
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
            });
        }
        
        // Update weekly table
        function updateWeeklyTable(stats) {
            const tableBody = document.getElementById('weeklyTable');
            const noDataRow = document.getElementById('weeklyNoData');
            
            // Clear existing rows
            const existingRows = tableBody.querySelectorAll('tr:not(#weeklyNoData)');
            existingRows.forEach(row => row.remove());
            
            // Show no data message if no weekly data
            if (!stats.weeklyData || stats.weeklyData.length === 0) {
                noDataRow.style.display = 'table-row';
                return;
            }
            
            // Hide no data row
            noDataRow.style.display = 'none';
            
            // Add weekly data rows
            stats.weeklyData.forEach(weekData => {
                const row = document.createElement('tr');
                
                // Determine efficiency badge color
                let efficiencyClass = 'bg-secondary';
                if (weekData.efficiency >= 80) efficiencyClass = 'bg-success';
                else if (weekData.efficiency >= 60) efficiencyClass = 'bg-warning';
                else if (weekData.efficiency > 0) efficiencyClass = 'bg-danger';
                
                row.innerHTML = `
                    <td><strong>${weekData.week}</strong><br><small class="text-muted">${weekData.weekStart}</small></td>
                    <td>${weekData.keys}</td>
                    <td>${weekData.snags}</td>
                    <td>${weekData.visits}</td>
                    <td>${weekData.handovers}</td>
                    <td>${weekData.moveins}</td>
                    <td>${currentStats.avgTime || 'N/A'}</td>
                    <td>
                        <span class="badge ${efficiencyClass} efficiency-badge">
                            ${weekData.efficiency}%
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Refresh weekly table
        function refreshWeeklyTable() {
            loadAnalytics();
            showNotification('Weekly table refreshed', 'success');
        }
        
        // Toggle chart data
        function toggleChartData(chartType) {
            if (!hasRealData) {
                alert('No real data available. Please add data first.');
                return;
            }
            
            createCharts(currentStats);
            showNotification(`${chartType} chart refreshed`, 'success');
        }
        
        // Generate report
        function generateReport(type) {
            if (!hasRealData) {
                alert('No data available to generate reports.');
                return;
            }
            
            // Your existing report generation code here
            showNotification('Report generation not implemented yet', 'info');
        }
        
        // Export functions
        function exportAsPDF() {
            if (!hasRealData) {
                alert('No data available to export');
                return;
            }
            showNotification('PDF export functionality not implemented', 'info');
        }
        
        function exportAsExcel() {
            if (!hasRealData) {
                alert('No data available to export');
                return;
            }
            showNotification('Excel export functionality not implemented', 'info');
        }
        
        function exportAsCSV() {
            if (!hasRealData) {
                alert('No data available to export');
                return;
            }
            showNotification('CSV export functionality not implemented', 'info');
        }
        
        // Print dashboard
        function printDashboard() {
            window.print();
        }
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show`;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
